
<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>تطبيق حصر وتقييم العقارات لحساب الضرائب العقارية</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js">

function renderPropertyRow(property, isImported = false) {
  const row = document.createElement("tr");
  row.className = isImported ? "imported-property" : "saved-property";
  row.innerHTML = `
    <td>${property.number}</td>
    <td>${property.street}</td>
    <td>${property.district}</td>
    <td>${property.city}</td>
    <td>${property.governorate}</td>
    <td>${property.date}</td>
    <td>
      <span class="property-badge ${isImported ? "badge-imported" : "badge-saved"}">
        ${isImported ? "مستورد" : "محفوظ"}
      </span>
    </td>
    <td>إجراءات</td>
  `;
  return row;
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
/* جميع الأنماط تبقى كما هي مع إضافة أنماط جديدة */
:root {
--primary: #2c3e50;
--secondary: #3498db;
--accent: #e74c3c;
--success: #27ae60;
--warning: #f39c12;
--light: #ecf0f1;
--dark: #34495e;
--gray: #95a5a6;
--shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
--radius: 10px;
--transition: all 0.3s ease;
}
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Cairo', sans-serif;
}
body {
background: linear-gradient(135deg, #f5f7fa, #e4e7eb);
color: #333;
line-height: 1.6;
min-height: 100vh;
padding: 20px;
direction: rtl;
}
.container {
max-width: 1400px;
margin: 0 auto;
}
header {
background: linear-gradient(to right, var(--primary), var(--dark));
color: white;
padding: 20px;
border-radius: var(--radius);
box-shadow: var(--shadow);
margin-bottom: 30px;
text-align: center;
position: relative;
overflow: hidden;
}
header::before {
content: "";
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: url('data:image/svg+xml;utf8,<svg xmlns="https://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><polygon points="0,0 100,0 0,100" fill="rgba(255,255,255,0.1)"/></svg>');
background-size: cover;
}
header h1 {
font-size: 2.5rem;
margin-bottom: 10px;
position: relative;
}
header p {
font-size: 1.2rem;
max-width: 800px;
margin: 0 auto;
position: relative;
}
.app-nav {
display: flex;
justify-content: center;
margin: 20px 0;
flex-wrap: wrap;
gap: 10px;
}
.nav-btn {
background: white;
color: var(--primary);
border: none;
padding: 12px 25px;
border-radius: 50px;
font-weight: bold;
cursor: pointer;
transition: var(--transition);
box-shadow: var(--shadow);
display: flex;
align-items: center;
gap: 8px;
}
.nav-btn:hover, .nav-btn.active {
background: var(--secondary);
color: white;
transform: translateY(-3px);
}
.app-section {
background: white;
border-radius: var(--radius);
box-shadow: var(--shadow);
padding: 30px;
margin-bottom: 30px;
display: none;
}
.app-section.active {
display: block;
animation: fadeIn 0.5s ease;
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}
.section-title {
color: var(--primary);
margin-bottom: 25px;
padding-bottom: 15px;
border-bottom: 2px solid var(--secondary);
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 15px;
}
.form-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
}
.form-group {
margin-bottom: 20px;
}
.form-group label {
display: block;
margin-bottom: 8px;
font-weight: bold;
color: var(--dark);
}
.form-group input,
.form-group select,
.form-group textarea {
width: 100%;
padding: 12px 15px;
border: 1px solid #ddd;
border-radius: var(--radius);
font-size: 16px;
transition: var(--transition);
}
.form-group textarea {
min-height: 120px;
resize: vertical;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
border-color: var(--secondary);
outline: none;
box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}
.form-row {
display: flex;
gap: 20px;
margin-bottom: 20px;
}
.form-row .form-group {
flex: 1;
margin-bottom: 0;
}
.btn {
background: var(--secondary);
color: white;
border: none;
padding: 12px 25px;
border-radius: var(--radius);
font-size: 16px;
cursor: pointer;
transition: var(--transition);
display: inline-flex;
align-items: center;
gap: 8px;
white-space: nowrap;
}
.btn:hover {
background: #2980b9;
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
.btn-success {
background: var(--success);
}
.btn-warning {
background: var(--warning);
}
.btn-danger {
background: var(--accent);
}
.btn i {
font-size: 14px;
}
.btn-group {
display: flex;
gap: 10px;
margin-top: 20px;
flex-wrap: wrap;
}
.table-responsive {
overflow-x: auto;
margin: 20px 0;
border-radius: var(--radius);
border: 1px solid #eee;
}
table {
width: 100%;
border-collapse: collapse;
min-width: 800px;
}
table th, table td {
padding: 12px 15px;
text-align: right;
border-bottom: 1px solid #eee;
}
table th {
background: var(--light);
color: var(--dark);
font-weight: bold;
}
table tr:hover {
background: rgba(52, 152, 219, 0.05);
}
.empty-data {
text-align: center;
padding: 30px;
color: var(--gray);
}
.empty-data i {
font-size: 3rem;
margin-bottom: 15px;
color: var(--secondary);
}
.unit-card {
background: white;
border: 1px solid #eee;
border-radius: var(--radius);
padding: 20px;
margin-bottom: 20px;
box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
transition: var(--transition);
position: relative;
}
.similarity-badge {
position: absolute;
top: 15px;
left: 15px;
padding: 5px 12px;
border-radius: 20px;
font-size: 12px;
font-weight: bold;
}
.similarity-street {
background: #4caf50;
color: white;
}
.similarity-village {
background: #2196f3;
color: white;
}
.similarity-city {
background: #9c27b0;
color: white;
}
.similarity-governorate {
background: #ff9800;
color: white;
}
.unit-card:hover {
transform: translateY(-5px);
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}
.unit-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 15px;
padding-bottom: 10px;
border-bottom: 1px dashed #eee;
}
.unit-header h3 {
color: var(--primary);
}
.unit-price {
background: var(--success);
color: white;
padding: 5px 15px;
border-radius: 20px;
font-weight: bold;
}
.value-badge {
background: #e3f2fd;
border-radius: 20px;
padding: 5px 12px;
font-size: 14px;
display: inline-flex;
align-items: center;
gap: 5px;
margin-top: 5px;
}
.value-badge.market {
background: #e8f5e9;
color: #2e7d32;
}
.value-badge.rental {
background: #fff8e1;
color: #f57f17;
}
.value-badge.net-rental {
background: #e3f2fd;
color: #1976d2;
}
.value-badge.tax {
background: #ffebee;
color: #c62828;
}
.valuation-summary {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
margin-bottom: 30px;
}
.valuation-methods {
display: flex;
flex-wrap: wrap;
gap: 15px;
align-items: center;
}
.method-selector {
display: flex;
align-items: center;
gap: 10px;
}
.method-selector label {
font-weight: bold;
color: var(--dark);
}
.method-selector select {
padding: 8px 12px;
border-radius: var(--radius);
border: 1px solid #ddd;
background: white;
}
.ai-loading {
display: inline-block;
margin-left: 10px;
color: var(--secondary);
}
.value-card {
background: linear-gradient(135deg, var(--secondary), var(--primary));
color: white;
padding: 25px;
border-radius: var(--radius);
text-align: center;
box-shadow: var(--shadow);
position: relative;
}
.similarity-level {
position: absolute;
top: 15px;
left: 15px;
background: rgba(255, 255, 255, 0.2);
padding: 5px 15px;
border-radius: 20px;
font-size: 14px;
}
.value-card h3 {
margin-bottom: 15px;
font-size: 1.5rem;
}
.value-amount {
font-size: 2.5rem;
font-weight: bold;
margin: 20px 0;
}
.stats-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
margin: 20px 0;
}
.stat-card {
background: white;
border-radius: var(--radius);
padding: 20px;
text-align: center;
box-shadow: var(--shadow);
border-left: 4px solid var(--secondary);
}
.stat-card h3 {
color: var(--dark);
margin-bottom: 10px;
}
.stat-value {
font-size: 2rem;
font-weight: bold;
color: var(--primary);
}
.image-preview {
display: flex;
flex-wrap: wrap;
gap: 10px;
margin-top: 10px;
}
.image-preview img {
width: 100px;
height: 100px;
object-fit: cover;
border-radius: 5px;
border: 1px solid #ddd;
transition: transform 0.3s ease;
}
.image-preview img:hover {
transform: scale(1.1);
box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.document-item {
background: var(--light);
padding: 10px;
border-radius: 5px;
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 10px;
}
.tab-container {
margin: 20px 0;
}
.tabs {
display: flex;
background: var(--light);
border-radius: 50px;
padding: 5px;
margin-bottom: 20px;
flex-wrap: wrap;
}
.tab {
flex: 1;
text-align: center;
padding: 10px;
cursor: pointer;
border-radius: 50px;
transition: var(--transition);
min-width: 120px;
margin: 3px;
}
.tab.active {
background: var(--secondary);
color: white;
}
.tab-content {
display: none;
}
.tab-content.active {
display: block;
}
footer {
text-align: center;
padding: 20px;
color: var(--gray);
margin-top: 30px;
border-top: 1px solid #eee;
background: #f8f9fa;
border-radius: var(--radius);
}
.signature {
font-weight: bold;
color: var(--primary);
margin-top: 10px;
}
.regression-info {
background: #f8f9fa;
border-radius: var(--radius);
padding: 20px;
margin-top: 20px;
border-left: 4px solid var(--success);
}
.regression-info h3 {
color: var(--success);
margin-bottom: 15px;
}
.regression-info ul {
padding-right: 20px;
}
.regression-info li {
margin-bottom: 10px;
}
.unit-values {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 15px;
margin-top: 15px;
padding-top: 15px;
border-top: 1px dashed #eee;
}
.unit-value-item {
background: #f8f9fa;
border-radius: 8px;
padding: 12px;
text-align: center;
}
.unit-value-item .label {
font-size: 14px;
color: var(--dark);
margin-bottom: 5px;
}
.unit-value-item .value {
font-weight: bold;
font-size: 16px;
}
.unit-value-item .market-value {
color: #2e7d32;
}
.unit-value-item .rental-value {
color: #f57f17;
}
.unit-value-item .net-rental-value {
color: #1976d2;
}
.unit-value-item .tax-value {
color: #c62828;
}
.addition-table {
margin-top: 20px;
}
.notification {
position: fixed;
top: 20px;
right: 20px;
background: var(--success);
color: white;
padding: 15px 25px;
border-radius: var(--radius);
box-shadow: var(--shadow);
z-index: 1000;
display: flex;
align-items: center;
gap: 10px;
animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
}
@keyframes slideIn {
from { transform: translateX(100%); opacity: 0; }
to { transform: translateX(0); opacity: 1; }
}
@keyframes fadeOut {
from { opacity: 1; }
to { opacity: 0; }
}
.record32-container {
background: white;
border-radius: var(--radius);
box-shadow: var(--shadow);
padding: 30px;
margin-top: 20px;
}
.record32-header {
text-align: center;
margin-bottom: 30px;
padding-bottom: 20px;
border-bottom: 2px solid var(--primary);
}
.record32-header h2 {
color: var(--primary);
font-size: 2rem;
margin-bottom: 10px;
}
.record32-info {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
margin-bottom: 30px;
}
.record32-info-item {
background: #f8f9fa;
border-radius: var(--radius);
padding: 15px;
border-left: 4px solid var(--secondary);
}
.record32-info-item h3 {
color: var(--dark);
margin-bottom: 10px;
font-size: 1.1rem;
}
.record32-info-item p {
font-size: 1.1rem;
font-weight: bold;
}
.record32-description {
background: #f8f9fa;
border-radius: var(--radius);
padding: 20px;
margin-bottom: 30px;
border-left: 4px solid var(--success);
}
.record32-description h3 {
color: var(--success);
margin-bottom: 15px;
}
.record32-description p {
line-height: 1.8;
}
.record32-actions {
display: flex;
justify-content: center;
gap: 15px;
margin-top: 30px;
}
#map {
height: 500px;
width: 100%;
border-radius: var(--radius);
margin-top: 20px;
box-shadow: var(--shadow);
}
.map-container {
position: relative;
}
.map-controls {
position: absolute;
top: 10px;
right: 10px;
z-index: 1000;
background: white;
padding: 10px;
border-radius: var(--radius);
box-shadow: var(--shadow);
}
.coordinates-container {
display: flex;
gap: 10px;
}
.coordinates-container input {
flex: 1;
}
.coordinates-container button {
padding: 0 15px;
}
.gps-loader {
display: inline-block;
width: 20px;
height: 20px;
border: 3px solid rgba(255,255,255,0.3);
border-radius: 50%;
border-top-color: white;
animation: spin 1s ease-in-out infinite;
margin-right: 8px;
display: none;
}
@keyframes spin {
to { transform: rotate(360deg); }
}
.market-data-info {
background: #f0f7ff;
border-radius: var(--radius);
padding: 15px;
margin-top: 20px;
border-left: 4px solid var(--secondary);
}
.market-data-info h3 {
color: var(--secondary);
margin-bottom: 10px;
display: flex;
align-items: center;
gap: 8px;
}
.price-meter {
font-weight: bold;
color: #d35400;
background: #fef9e7;
padding: 3px 8px;
border-radius: 4px;
margin-left: 5px;
}
.source-badge {
display: inline-block;
background: #3498db;
color: white;
padding: 2px 8px;
border-radius: 4px;
font-size: 12px;
margin-left: 5px;
}
.official-form {
background: white;
border-radius: var(--radius);
box-shadow: var(--shadow);
padding: 30px;
margin-bottom: 30px;
overflow-x: auto;
}
.official-form table {
min-width: 1200px;
margin-bottom: 20px;
}
.official-form .merged-cell {
background-color: #ecf0f1;
font-weight: bold;
text-align: center;
padding: 10px;
}
.official-form th {
background-color: #3498db;
color: white;
font-weight: bold;
text-align: center;
}
.official-form .section-header {
background-color: #2c3e50;
color: white;
text-align: center;
padding: 10px;
margin: 25px 0 15px;
}
.official-form .signature-area {
margin-top: 40px;
}
.official-form .signature-row {
display: flex;
justify-content: space-around;
margin-top: 15px;
}
.official-form .signature-box {
width: 45%;
text-align: center;
border-bottom: 1px solid #7f8c8d;
padding: 10px;
}
.official-form .empty-row td {
height: 25px;
}
.map-popup-content {
max-width: 300px;
}
.map-popup-content h3 {
color: var(--primary);
border-bottom: 2px solid var(--secondary);
padding-bottom: 5px;
margin-bottom: 10px;
}
.map-popup-content p {
margin-bottom: 5px;
}
.map-popup-content .unit-item {
padding: 8px;
border-bottom: 1px dashed #eee;
}
.addition-decision {
background: white;
border-radius: var(--radius);
box-shadow: var(--shadow);
padding: 30px;
margin-bottom: 30px;
}
.decision-header {
text-align: center;
margin-bottom: 30px;
padding-bottom: 20px;
border-bottom: 2px solid var(--primary);
}
.decision-header h2 {
color: var(--primary);
font-size: 1.8rem;
margin-bottom: 15px;
}
.decision-details {
display: flex;
justify-content: space-between;
flex-wrap: wrap;
margin-bottom: 20px;
gap: 15px;
}
.decision-detail {
flex: 1;
min-width: 200px;
}
.decision-detail label {
font-weight: bold;
display: block;
margin-bottom: 5px;
color: var(--dark);
}
.decision-detail input {
width: 100%;
padding: 10px;
border: 1px solid #ddd;
border-radius: 5px;
}
.addition-table {
margin-top: 20px;
overflow-x: auto;
}
.addition-table table {
width: 100%;
border-collapse: collapse;
min-width: 900px;
}
.addition-table th,
.addition-table td {
padding: 12px 15px;
border: 1px solid #ddd;
text-align: center;
}
.addition-table th {
background-color: var(--primary);
color: white;
font-weight: bold;
}
.addition-table tr:nth-child(even) {
background-color: #f8f9fa;
}
.addition-table tr:hover {
background-color: rgba(52, 152, 219, 0.05);
}
.total-row td {
background-color: var(--light);
font-weight: bold;
color: var(--primary);
}
.signature-section {
margin-top: 40px;
padding-top: 20px;
border-top: 2px solid var(--secondary);
}
.signature-row {
display: flex;
justify-content: space-around;
margin-top: 30px;
flex-wrap: wrap;
gap: 20px;
}
.signature-box {
width: 250px;
text-align: center;
}
.signature-line {
border-bottom: 1px solid var(--dark);
padding: 10px;
margin-bottom: 5px;
}
.search-container {
background: white;
border-radius: var(--radius);
box-shadow: var(--shadow);
padding: 20px;
margin-bottom: 20px;
}
.search-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 15px;
flex-wrap: wrap;
gap: 15px;
}
.search-header h3 {
color: var(--primary);
font-size: 1.4rem;
}
.search-filters {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 15px;
margin-bottom: 20px;
}
.search-filter-group {
margin-bottom: 15px;
}
.search-filter-group label {
display: block;
margin-bottom: 8px;
font-weight: bold;
color: var(--dark);
}
.search-filter-group input,
.search-filter-group select {
width: 100%;
padding: 10px 15px;
border: 1px solid #ddd;
border-radius: var(--radius);
font-size: 16px;
}
.search-actions {
display: flex;
gap: 10px;
justify-content: flex-end;
}
.search-results {
margin-top: 20px;
overflow-x: auto;
}
.search-results table {
width: 100%;
min-width: 900px;
border-collapse: collapse;
}
.search-results th {
background-color: var(--primary);
color: white;
padding: 12px 15px;
text-align: center;
}
.search-results td {
padding: 12px 15px;
border-bottom: 1px solid #eee;
text-align: center;
}
.search-results tr:hover {
background-color: rgba(52, 152, 219, 0.05);
}
.form-type-filter {
display: flex;
gap: 10px;
margin-top: 15px;
flex-wrap: wrap;
}
.form-type-btn {
padding: 8px 15px;
background: var(--light);
border: 1px solid #ddd;
border-radius: 50px;
cursor: pointer;
transition: var(--transition);
}
.form-type-btn.active {
background: var(--secondary);
color: white;
border-color: var(--secondary);
}
.no-results {
text-align: center;
padding: 30px;
color: var(--gray);
}
.no-results i {
font-size: 3rem;
margin-bottom: 15px;
color: var(--secondary);
}
.highlight {
background-color: #fffde7;
font-weight: bold;
color: var(--primary);
}
.gps-container {
position: relative;
}
.gps-status {
font-size: 12px;
margin-top: 5px;
color: var(--gray);
}
.gps-status.error {
color: var(--accent);
}
.gps-status.success {
color: var(--success);
}
.search-loader {
display: inline-block;
width: 16px;
height: 16px;
border: 2px solid rgba(255,255,255,0.3);
border-radius: 50%;
border-top-color: white;
animation: spin 1s ease-in-out infinite;
margin-right: 8px;
display: none;
}
.export-buttons {
display: flex;
gap: 10px;
margin-top: 20px;
flex-wrap: wrap;
}
.export-btn {
background: #27ae60;
color: white;
border: none;
padding: 12px 20px;
border-radius: var(--radius);
font-size: 16px;
cursor: pointer;
transition: var(--transition);
display: inline-flex;
align-items: center;
gap: 8px;
white-space: nowrap;
}
.export-btn:hover {
background: #219653;
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
.export-btn.excel {
background: #27ae60;
}
.export-btn.excel:hover {
background: #2ecc71;
}
.export-btn.image {
background: #2980b9;
}
.export-btn.image:hover {
background: #3498db;
}
.form-images-container {
margin-top: 20px;
padding: 15px;
background: #f8f9fa;
border-radius: var(--radius);
border-left: 4px solid var(--secondary);
}
.form-images-title {
font-weight: bold;
margin-bottom: 10px;
color: var(--primary);
display: flex;
align-items: center;
gap: 8px;
}
.form-images-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
gap: 10px;
margin-top: 10px;
}
.form-image-item {
border: 1px solid #ddd;
border-radius: 5px;
overflow: hidden;
height: 100px;
}
.form-image-item img {
width: 100%;
height: 100%;
object-fit: cover;
}
.market-preview {
margin-top: 15px;
padding: 15px;
background: white;
border-radius: var(--radius);
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.market-preview h4 {
color: var(--dark);
margin-bottom: 10px;
padding-bottom: 10px;
border-bottom: 1px solid #eee;
}
.market-preview table {
width: 100%;
border-collapse: collapse;
}
.market-preview th {
background: var(--light);
padding: 8px;
font-weight: bold;
}
.market-preview td {
padding: 8px;
border-bottom: 1px solid #eee;
}
/* أنماط جديدة لنظام البحث المحسن */
.search-icon {
position: relative;
display: inline-block;
}
.search-icon-btn {
background: var(--light);
border: none;
border-radius: 50%;
width: 40px;
height: 40px;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
transition: var(--transition);
box-shadow: var(--shadow);
}
.search-icon-btn:hover {
background: var(--secondary);
color: white;
}
.search-dropdown {
position: absolute;
top: 50px;
right: 0;
background: white;
border-radius: var(--radius);
box-shadow: var(--shadow);
padding: 20px;
width: 350px;
z-index: 100;
display: none;
opacity: 0;
transform: translateY(-10px);
transition: all 0.3s ease;
}
.search-dropdown.active {
display: block;
opacity: 1;
transform: translateY(0);
animation: fadeIn 0.3s ease;
}
.search-dropdown .form-group {
margin-bottom: 15px;
}
.search-dropdown .form-group label {
font-size: 14px;
}
.search-dropdown .form-group input {
padding: 10px;
font-size: 14px;
}
.search-dropdown .btn-group {
margin-top: 10px;
}
.search-dropdown .btn {
padding: 10px 15px;
font-size: 14px;
}
.search-dropdown .form-type-filter {
margin-top: 15px;
margin-bottom: 10px;
}
/* أنماط جديدة للتحذير */
.duplicate-warning {
background-color: #fff8e1;
border-left: 4px solid #ff9800;
padding: 10px 15px;
margin-top: 10px;
border-radius: 4px;
display: none;
}
.duplicate-warning.show {
display: block;
}
.duplicate-warning i {
color: #ff9800;
margin-left: 5px;
}
/* تحسينات جديدة */
.loading-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.7);
display: flex;
justify-content: center;
align-items: center;
z-index: 2000;
display: none;
}
.loading-spinner {
width: 60px;
height: 60px;
border: 5px solid rgba(255, 255, 255, 0.3);
border-radius: 50%;
border-top-color: white;
animation: spin 1s ease-in-out infinite;
}
.loading-text {
color: white;
margin-top: 20px;
font-size: 18px;
}
.unit-filters {
display: flex;
gap: 15px;
margin-bottom: 20px;
flex-wrap: wrap;
}
.filter-btn {
padding: 8px 15px;
background: #f8f9fa;
border: 1px solid #ddd;
border-radius: 50px;
cursor: pointer;
transition: var(--transition);
}
.filter-btn.active {
background: var(--secondary);
color: white;
border-color: var(--secondary);
}
.unit-rating {
display: flex;
gap: 5px;
margin-top: 10px;
}
.unit-rating .star {
color: #ddd;
cursor: pointer;
transition: color 0.2s;
}
.unit-rating .star.active {
color: #ffc107;
}
.unit-stats {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
gap: 10px;
margin-top: 15px;
}
.stat-item {
background: #f8f9fa;
padding: 10px;
border-radius: 8px;
text-align: center;
}
.stat-label {
font-size: 12px;
color: var(--dark);
}
.stat-value {
font-weight: bold;
font-size: 14px;
}
/* تحسينات الطباعة */
@media print {
body * {
visibility: hidden;
}
.app-section.active,
.app-section.active * {
visibility: visible;
}
.app-section.active {
position: absolute;
left: 0;
top: 0;
width: 100%;
margin: 0;
padding: 0;
box-shadow: none;
}
header, .app-nav, footer, .btn-group, .export-buttons, .tab-container .tabs {
display: none !important;
}
.official-form {
page-break-inside: avoid;
page-break-after: auto;
}
.official-form table {
min-width: 100% !important;
font-size: 12px;
}
.official-form th,
.official-form td {
padding: 8px 10px !important;
}
}
@media (max-width: 768px) {
.form-row {
flex-direction: column;
gap: 0;
}
header h1 {
font-size: 1.8rem;
}
.nav-btn {
padding: 10px 15px;
font-size: 14px;
}
.value-amount {
font-size: 2rem;
}
.btn-group {
flex-direction: column;
}
.btn-group .btn {
width: 100%;
justify-content: center;
}
.unit-values {
grid-template-columns: 1fr;
}
.section-title {
flex-direction: column;
align-items: flex-start;
}
.record32-info {
grid-template-columns: 1fr;
}
.record32-actions {
flex-direction: column;
}
#map {
height: 300px;
}
.coordinates-container {
flex-direction: column;
}
.official-form .signature-row {
flex-direction: column;
gap: 15px;
}
.official-form .signature-box {
width: 100%;
}
.decision-details {
flex-direction: column;
}
.signature-row {
flex-direction: column;
align-items: center;
}
.search-filters {
grid-template-columns: 1fr;
}
.search-results table {
min-width: 700px;
}
.search-actions {
flex-direction: column;
}
.export-buttons {
flex-direction: column;
}
.search-dropdown {
width: 280px;
right: -40px;
}
.unit-stats {
grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
}
}
/* أزرار الوحدات والتقييم */
#units-section .btn,
#valuation-section .btn {
padding: 8px 18px; /* حجم متوسط */
font-size: 14px;
border-radius: 8px;
min-width: 120px;
}
/* تحسين الألوان للأزرار الهامة */
#units-section .btn-success,
#valuation-section .btn-success {
background: var(--success);
color: white;
}
#units-section .btn-success:hover,
#valuation-section .btn-success:hover {
background: #219653;
}
#units-section .btn,
#valuation-section .btn {
background: var(--secondary);
color: white;
}
#units-section .btn:hover,
#valuation-section .btn:hover {
background: #2980b9;
}
/* توحيد حجم الأيقونات */
#units-section .btn i,
#valuation-section .btn i {
font-size: 13px;
}
/* تكبير خانة القيمة السوقية */
#units-section #manual-market-value {
padding: 14px;
font-size: 18px;
border: 2px solid var(--secondary);
border-radius: var(--radius);
width: 100%;
box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
/* تحسينات البحث الجديدة */
.search-results-container {
margin-top: 20px;
background: #fff;
border-radius: var(--radius);
box-shadow: var(--shadow);
padding: 20px;
}
.search-results-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
padding-bottom: 15px;
border-bottom: 1px solid #eee;
}
.results-count {
background: var(--secondary);
color: white;
padding: 5px 10px;
border-radius: 20px;
font-size: 14px;
}
.property-card {
border: 1px solid #eee;
border-radius: var(--radius);
padding: 15px;
margin-bottom: 15px;
transition: var(--transition);
cursor: pointer;
}
.property-card:hover {
transform: translateY(-3px);
box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.property-card h3 {
color: var(--primary);
margin-bottom: 10px;
display: flex;
align-items: center;
gap: 10px;
}
.property-card .property-id {
background: var(--dark);
color: white;
padding: 3px 8px;
border-radius: 4px;
font-size: 14px;
}
.property-info {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 10px;
margin-top: 10px;
}
.info-item {
display: flex;
gap: 5px;
}
.info-label {
font-weight: bold;
color: var(--dark);
}
/* أنماط جديدة للاستيراد والدمج */
.import-section {
margin-top: 25px;
padding: 20px;
background: #f8f9fa;
border-radius: var(--radius);
border-left: 4px solid var(--warning);
}
.import-section h3 {
color: var(--warning);
margin-bottom: 15px;
display: flex;
align-items: center;
gap: 8px;
}
.import-options {
display: flex;
gap: 15px;
margin-top: 15px;
flex-wrap: wrap;
}
.import-option {
background: white;
border: 1px solid #ddd;
border-radius: var(--radius);
padding: 15px;
flex: 1;
min-width: 250px;
text-align: center;
cursor: pointer;
transition: var(--transition);
}
.import-option:hover {
transform: translateY(-3px);
box-shadow: 0 5px 15px rgba(0,0,0,0.1);
border-color: var(--secondary);
}
.import-option i {
font-size: 2.5rem;
color: var(--secondary);
margin-bottom: 10px;
}
.merge-status {
margin-top: 20px;
padding: 15px;
background: #e8f5e9;
border-radius: var(--radius);
display: none;
}
.merge-status.visible {
display: block;
}
.merge-stats {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 15px;
margin-top: 15px;
}
.merge-stat {
background: white;
border-radius: var(--radius);
padding: 15px;
text-align: center;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.merge-stat .number {
font-size: 1.8rem;
font-weight: bold;
color: var(--primary);
margin: 5px 0;
}
.merge-stat .label {
font-size: 14px;
color: var(--dark);
}
/* إضافة مؤشر حالة الاتصال */
.connection-status {
position: fixed;
bottom: 20px;
right: 20px;
padding: 10px 20px;
border-radius: 20px;
font-weight: bold;
z-index: 1000;
box-shadow: 0 2px 10px rgba(0,0,0,0.2);
display: flex;
align-items: center;
gap: 8px;
transition: all 0.3s ease;
}
.connection-status.online {
background: #27ae60;
color: white;
}
.connection-status.offline {
background: #e74c3c;
color: white;
}

.count-badge {
  background: #e74c3c;
  color: white;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 13px;
  margin-right: 8px;
}


/* التمييز بين العقارات */
.saved-property {
  background-color: #e8f5e9; /* أخضر فاتح */
}
.imported-property {
  background-color: #fff3e0; /* برتقالي فاتح */
}
.property-badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: bold;
  color: white;
}
.badge-saved {
  background: #27ae60; /* أخضر */
}
.badge-imported {
  background: #e67e22; /* برتقالي */
}

</style>
<style>
/* جميع الأنماط تبقى كما هي */
/* ... (جميع أنماط CSS الحالية) ... */

/* أنماط جديدة للإحصائيات حسب الشارع */
.street-stats-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 15px;
}

.street-filter {
  display: flex;
  align-items: center;
  gap: 10px;
}

.street-filter input {
  padding: 10px 15px;
  border: 1px solid #ddd;
  border-radius: var(--radius);
  min-width: 250px;
}

.street-summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.street-summary-card {
  background: white;
  border-radius: var(--radius);
  padding: 15px;
  text-align: center;
  box-shadow: var(--shadow);
  border-left: 4px solid var(--secondary);
}

.street-summary-card h3 {
  color: var(--dark);
  margin-bottom: 10px;
  font-size: 1rem;
}

.street-summary-value {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--primary);
}

.street-stats-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

.street-stats-table th {
  background-color: var(--primary);
  color: white;
  padding: 12px 15px;
  text-align: center;
}

.street-stats-table td {
  padding: 12px 15px;
  border-bottom: 1px solid #eee;
  text-align: center;
}

.street-stats-table tr:hover {
  background-color: rgba(52, 152, 219, 0.05);
}

.street-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.street-actions button {
  padding: 5px 10px;
  font-size: 14px;
}

@media (max-width: 768px) {
  .street-stats-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .street-filter {
    width: 100%;
  }
  
  .street-filter input {
    width: 100%;
  }
  
  .street-summary-cards {
    grid-template-columns: 1fr 1fr;
  }
}
</style></head>
<body>
<!-- مؤشر حالة الاتصال -->
<div class="connection-status" id="connection-status">
<i class="fas fa-wifi"></i>
<span>متصل بالإنترنت</span>
</div>
<div class="container">
<header>
<h1><i class="fas fa-building"></i> تطبيق حصر وتقييم العقارات لحساب الضرائب العقارية</h1>
<p>تطبيق متكامل لإدارة العقارات، تعبئة الاستمارات الرسمية، وتقييم الضرائب العقارية بكل دقة</p>
</header>
<div class="app-nav">
<button class="nav-btn active" data-target="property-section"><i class="fas fa-home"></i> بيانات العقار</button>
<button class="nav-btn" data-target="units-section"><i class="fas fa-layer-group"></i> وحدات العقار</button>
<button class="nav-btn" data-target="valuation-section"><i class="fas fa-chart-line"></i> التقييم العقاري</button>
<button class="nav-btn" data-target="official-forms-section"><i class="fas fa-file-alt"></i> الاستمارات الرسمية</button>
<button class="nav-btn" data-target="addition-section"><i class="fas fa-file-contract"></i> قرار الإضافة</button>
<button class="nav-btn" data-target="map-section"><i class="fas fa-map-marked-alt"></i> الخريطة العقارية</button>
<button class="nav-btn" data-target="stats-section"><i class="fas fa-chart-pie"></i> الإحصائيات</button></div>
<!-- Property Section -->
<section class="app-section active" id="property-section">
<div class="section-title">
<h2><i class="fas fa-home"></i> إدخال بيانات العقار</h2>
<div class="search-icon">
<button class="search-icon-btn" id="property-search-btn">
<i class="fas fa-search"></i>
</button>
<div class="search-dropdown" id="property-search-dropdown">
<div class="form-container">
<div class="form-group">
<label>رقم العقار</label>
<input id="property-search-number" placeholder="أدخل الرقم العقاري" type="text"/>
</div>
<div class="form-group">
<label>الشارع</label>
<input id="property-search-street" placeholder="اسم الشارع" type="text"/>
</div>
<div class="form-group">
<label>الحى / القرية</label>
<input id="property-search-district" placeholder="اسم المنطقة أو القرية" type="text"/>
</div>
</div>
<div class="btn-group">
<button class="btn" id="reset-property-search">
<i class="fas fa-eraser"></i> مسح البحث
</button>
<button class="btn btn-success" id="search-property">
<i class="fas fa-search"></i> بحث
</button>
</div>
</div>
</div>
<div class="export-buttons">
<button class="export-btn excel" id="export-backup-all">
<i class="fas fa-download"></i> نسخة احتياطية كاملة (Excel)
</button>
<button class="export-btn" id="import-properties" style="background-color: #8e44ad;">
<i class="fas fa-file-import"></i> استيراد عقارات
</button>
<button class="export-btn" id="show-saved-properties" style="background-color: #16a085;">
<i class="fas fa-building"></i> العقارات المحفوظة والمستوردة <span class="count-badge" id="properties-count">0</span>
</button>
</div>
</div>
<div class="form-container">
<div>
<div class="form-group">
<label>الرقم العقاري</label>
<input id="property-number" placeholder="أدخل الرقم العقاري" type="text"/>
<div class="duplicate-warning" id="duplicate-warning">
<i class="fas fa-exclamation-triangle"></i>
يوجد عقار آخر بنفس الرقم في نفس الشارع
</div>
</div>
<!-- إضافة حقل رقم العقار السابق -->
<div class="form-group">
<label>رقم العقار السابق</label>
<input id="previous-property-number" placeholder="أدخل الرقم العقاري السابق" type="text"/>
</div>
<div class="form-group">
<label>الشارع</label>
<input id="street" placeholder="اسم الشارع" type="text"/>
</div>
<div class="form-group">
<label>عرض الشارع (متر)</label>
<input id="street-width" placeholder="عرض الشارع بالمتر" type="number"/>
</div>
<div class="form-group">
<label>الحى / القرية</label>
<input id="district" placeholder="الحى أو القرية" type="text"/>
</div>
<div class="form-group">
<label>المركز / المدينة</label>
<input id="city" placeholder="المركز أو المدينة" type="text"/>
</div>
<div class="form-group">
<label>المحافظة</label>
<input id="governorate" placeholder="أدخل اسم المحافظة" type="text"/>
</div>
<div class="form-group">
<label>طبيعة المكان</label>
<select id="location-type">
  <option value="village">قرية</option>
  <option value="compound">عزبة</option>
  <option value="city">مدينة</option>
  <option value="major_city">مدينة رئيسية</option>
</select>
</div>
<div class="form-row">
<div class="form-group">
<label>سنة الإنشاء</label>
<input id="construction-year" placeholder="سنة الإنشاء" type="number"/>
</div>
<div class="form-group">
<label>مادة البناء</label>
<select id="building-material">
<option value="brick">طوب أحمر</option>
<option value="sand_brick">طوب رملي</option>
<option selected="" value="concrete">خرسانة مسلحة</option>
<option value="stone">حجر</option>
<option value="mud_brick">طوب لبن</option>
<option value="other">أخرى</option>
</select>
</div>
</div>
<div class="form-group gps-container">
<label>الإحداثيات (خط الطول، خط العرض)</label>
<div class="coordinates-container">
<input id="coordinates" placeholder="مثال: 30.0444, 31.2357" type="text"/>
<button class="btn" id="get-gps" style="padding: 0 15px;">
<span class="gps-loader" id="gps-loader"></span>
<i class="fas fa-location-arrow"></i>
</button>
</div>
<div class="gps-status" id="gps-status"></div>
<small>يمكنك استخدام <a href="https://www.google.com/maps" target="_blank">خرائط جوجل</a> للحصول على الإحداثيات</small>
</div>
<div class="form-group">
<label>اسم المكلف</label>
<input id="responsible-name" placeholder="اسم المكلف" type="text"/>
</div>
</div>
<div>
<div class="form-group">
<label>اسم المالك</label>
<input id="owner" placeholder="اسم المالك" type="text"/>
</div>
<!-- إضافة حقل الرقم القومي للمالك -->
<div class="form-group">
<label>الرقم القومي للمالك</label>
<input id="owner-national-id" placeholder="الرقم القومي للمالك" type="text"/>
</div>
<div class="form-row">
<div class="form-group">
<label>المساحة (م²)</label>
<input id="area" placeholder="المساحة بالمتر المربع" type="number"/>
</div>
<div class="form-group">
<label>عدد الأدوار</label>
<input id="floors" placeholder="عدد الأدوار" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>عدد الوحدات</label>
<input id="units-count" placeholder="عدد الوحدات" type="number"/>
</div>
<div class="form-group">
<label>نوع العقار</label>
<select id="property-type">
<option value="residential">سكني</option>
<option value="commercial">تجاري</option>
<option value="mixed">مختلط</option>
<option value="agricultural">زراعي</option>
<option value="space">فضاء</option>
<option value="utilized_space">فضاء مستغل</option>
<option value="educational">تعليمي</option>
<option value="health">صحي</option>
<option value="under_completion">تحت الإتمام</option>
</select>
</div>
</div>
<div class="form-group">
<label>الوصف التفصيلي للعقار</label>
<textarea id="detailed-description" placeholder="وصف تفصيلي للعقار"></textarea>
</div>
<div class="form-group">
<label>صور العقار</label>
<input accept="image/*" id="property-images" multiple="" type="file"/>
<div class="image-preview" id="image-preview"></div>
</div>
<div class="form-group">
<label>مستندات العقار</label>
<input id="property-documents" multiple="" type="file"/>
<div id="documents-preview"></div>
</div>
</div>
</div>
<div class="btn-group">
<button class="btn btn-success" id="save-property">
<i class="fas fa-save"></i> حفظ العقار
</button>
<button class="btn" id="reset-form">
<i class="fas fa-eraser"></i> مسح النموذج
</button>
<button class="btn" id="delete-property">
<i class="fas fa-trash"></i> حذف العقار
</button>
</div>
<div class="export-buttons">
<button class="export-btn excel" id="export-property-excel">
<i class="fas fa-file-excel"></i> تصدير Excel
</button>
</div>
<!-- نافذة العقارات المحفوظة -->
<div id="saved-properties-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
background:#fff; border:2px solid #333; padding:20px; z-index:1000; border-radius:8px; box-shadow:0 0 15px rgba(0,0,0,0.5); width:80%; max-width:900px; max-height:80vh; overflow:auto;">
<h3 style="margin-top:0; text-align:center;"><i class="fas fa-building"></i> العقارات المحفوظة والمستوردة</h3>
<div class="table-responsive">
<div id="saved-properties-search" style="margin-bottom:15px; text-align:right;"><label>🔎 بحث: </label><input id="saved-properties-search-input" placeholder="ابحث برقم العقار أو الشارع أو المنطقة ..." style="padding:8px; width:50%; border:1px solid #ccc; border-radius:5px;" type="text"/></div><table style="width:100%;">
<thead>
<tr>
<th>رقم العقار</th>
<th>الشارع</th>
<th>المنطقة/القرية</th>
<th>المدينة/المركز</th>
<th>المحافظة</th>
<th>تاريخ الإضافة</th>
<th>الحالة</th>
<th>الإجراءات</th>
</tr>
</thead>
<tbody id="saved-properties-table">
<!-- سيتم ملؤه بالبيانات -->
</tbody>
</table>
</div>
<div style="text-align:center; margin-top:20px;">
<button class="btn" id="close-saved-properties" style="padding:10px 20px;">
<i class="fas fa-times"></i> إغلاق
</button>
</div>
</div>
<!-- قسم الاستيراد والدمج -->
<div class="import-section">
<h3><i class="fas fa-file-import"></i> استيراد العقارات ودمجها</h3>
<p>يمكنك استيراد ملف Excel يحتوي على بيانات العقارات ودمجها مع البيانات الحالية في النظام</p>
<div class="import-options">
<div class="import-option" id="import-merge">
<i class="fas fa-object-group"></i>
<h4>دمج العقارات</h4>
<p>دمج العقارات المستوردة مع العقارات الحالية مع تحديث التكرارات</p>
</div>
<div class="import-option" id="import-replace">
<i class="fas fa-exchange-alt"></i>
<h4>استبدال العقارات</h4>
<p>استبدال جميع العقارات الحالية بالعقارات المستوردة</p>
</div>
<div class="import-option" id="import-add">
<i class="fas fa-plus-circle"></i>
<h4>إضافة جديدة فقط</h4>
<p>إضافة العقارات الجديدة فقط مع تجاهل العقارات المكررة</p>
</div>
</div>
<div class="merge-status" id="merge-status">
<h4><i class="fas fa-sync-alt"></i> نتيجة عملية الدمج</h4>
<div class="merge-stats">
<div class="merge-stat">
<div class="number" id="imported-count">0</div>
<div class="label">عدد العقارات المستوردة</div>
</div>
<div class="merge-stat">
<div class="number" id="added-count">0</div>
<div class="label">تمت إضافتها</div>
</div>
<div class="merge-stat">
<div class="number" id="updated-count">0</div>
<div class="label">تم تحديثها</div>
</div>
<div class="merge-stat">
<div class="number" id="duplicate-count">0</div>
<div class="label">مكررة (تم تخطيها)</div>
</div>
</div>
<div class="btn-group" style="margin-top: 20px;">
<button class="btn btn-success" id="confirm-merge">
<i class="fas fa-check"></i> تأكيد الدمج
</button>
<button class="btn btn-danger" id="cancel-merge">
<i class="fas fa-times"></i> إلغاء
</button>
</div>
</div>
</div>
</section>
<!-- Units Section -->
<section class="app-section" id="units-section">
<div class="section-title">
<h2><i class="fas fa-layer-group"></i> إدارة وحدات العقار</h2>
<div class="unit-filters">
<div class="filter-btn active" data-filter="all">الكل</div>
<div class="filter-btn" data-filter="residential">سكنية</div>
<div class="filter-btn" data-filter="commercial">تجارية</div>
<div class="filter-btn" data-filter="space">فضاء</div>
</div>
</div>
<div class="form-container">
<div>
<div class="form-row">
<div class="form-group">
<label>رقم الدور</label>
<input id="unit-floor" placeholder="رقم الدور" type="number"/>
</div>
<div class="form-group">
<label>رقم الوحدة</label>
<input id="unit-number" placeholder="رقم الوحدة" type="text"/>
</div>
<div class="form-group">
<label>اسم المالك</label>
<input id="unit-owner" placeholder="مالك الوحدة" type="text"/>
</div>
</div>
<!-- إضافة حقل الرقم القومي للمالك للوحدة -->
<div class="form-group">
<label>الرقم القومي للمالك</label>
<input id="unit-owner-national-id" placeholder="الرقم القومي للمالك" type="text"/>
</div>
<div class="form-group">
<label>مساحة الوحدة (م²)</label>
<input id="unit-area" placeholder="مساحة الوحدة" type="number"/>
</div>
<div class="form-row">
<div class="form-group">
<label>حالة الوحدة</label>
<select id="unit-status">
<option value="complete">تامة</option>
<option value="incomplete">غير تامة</option>
<option value="occupied">مشغولة على غير اتمام</option>
</select>
</div>
<div class="form-group">
<label>نوع الاستغلال</label>
<select id="unit-use-type">
<option value="residential">سكني</option>
<option value="commercial">تجاري</option>
<option value="administrative">إداري</option>
<option value="space">فضاء</option>
<option value="utilized_space">فضاء مستغل</option>
<option value="educational">تعليمي</option>
<option value="health">صحي</option>
<option value="under_completion">تحت الإتمام</option>
</select>
</div>
</div>
</div>
<div>
<div class="form-row">
<div class="form-group">
<label>نوع الوحدة</label>
<select id="unit-type">
<option value="apartment">شقة</option>
<option value="duplex">دوبلكس</option>
<option value="villa">فيلا</option>
<option value="shop">محل</option>
<option value="warehouse">مخزن</option>
<option value="workshop">ورشة</option>
<option value="clinic">عيادة</option>
<option value="office">مكتب</option>
<option value="space">فضاء</option>
<option value="utilized_space">فضاء مستغل</option>
</select>
</div>
<div class="form-group">
<label>مستوى التشطيب</label>
<select id="unit-finishing">
<option value="none">بدون</option>
<option value="basic">عادي</option>
<option selected="" value="medium">متوسط</option>
<option value="high">عالي</option>
<option value="luxury">فاخر</option>
</select>
</div>
</div>
<div class="form-group">
<label>اسم الشاغل (إن وجد)</label>
<input id="unit-occupant" placeholder="اسم الشاغل" type="text"/>
</div>
<!-- إضافة حقل النشاط الجديد -->
<div class="form-group">
<label>النشاط (نوع الاستخدام)</label>
<input id="unit-activity" placeholder="مثال: محلات تجارية، مخازن" type="text"/>
</div>
<div class="unit-rating">
<div class="star" data-rating="1"><i class="fas fa-star"></i></div>
<div class="star" data-rating="2"><i class="fas fa-star"></i></div>
<div class="star" data-rating="3"><i class="fas fa-star"></i></div>
<div class="star" data-rating="4"><i class="fas fa-star"></i></div>
<div class="star" data-rating="5"><i class="fas fa-star"></i></div>
</div>
<div class="form-group" id="manual-valuation-input" style="display:none; margin-top:10px;">
<label>أدخل القيمة السوقية (جنيه)</label>
<input id="manual-market-value" placeholder="أدخل القيمة السوقية" type="number"/>
<button id="open-calculator" style="margin-right:5px;" type="button">🧮 الحاسبة</button>
</div>
<div class="btn-group">
<button class="btn btn-success" id="calculate-values-btn" style="width: 100%;">
<i class="fas fa-calculator"></i> احتساب القيم
</button>
</div>
<button class="btn" id="add-unit-btn" style="width: 100%; margin-top: 10px;">
<i class="fas fa-plus"></i> إضافة الوحدة
</button>
</div>
</div>
<div class="section-title" style="margin-top: 30px;">
<h3><i class="fas fa-list"></i> الوحدات المضافة</h3>
</div>
<div class="table-responsive">
<table>
<thead>
<tr>
<th>الدور</th>
<th>رقم الوحدة</th>
<th>المالك</th>
<th>الرقم القومي</th> <!-- عمود جديد -->
<th>المساحة</th>
<th>سعر المتر</th>
<th>النوع</th>
<th>الاستغلال</th>
<th>النشاط</th>
<th>حالة الوحدة</th>
<th>القيم المالية</th>
<th>الحالة</th>
<th>الإجراءات</th>
</tr>
</thead>
<tbody id="units-table-body">
<tr class="empty-data-row">
<td colspan="12">
<div class="empty-data">
<i class="fas fa-inbox"></i>
<h3>لا توجد وحدات مسجلة</h3>
<p>قم بإضافة وحدات العقار باستخدام النموذج أعلاه</p>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="export-buttons">
<button class="export-btn excel" id="export-units-excel">
<i class="fas fa-file-excel"></i> تصدير Excel
</button>
</div>
</section>
<!-- Valuation Section -->
<section class="app-section" id="valuation-section">
<div class="section-title">
<h2><i class="fas fa-chart-line"></i> التقييم العقاري</h2>
<div class="valuation-methods">
<div class="method-selector">
<label>طريقة التقييم:</label>
<select id="valuation-method">
<option value="regression">الانحدار المتعدد</option>
<option value="ai">الذكاء الاصطناعي</option>
<option value="manual">التقييم اليدوي</option>
</select>
<div class="form-group" id="manual-valuation-input" style="display:none; margin-top:10px;">
<label>أدخل القيمة السوقية (جنيه)</label>
<input id="manual-market-value" placeholder="أدخل القيمة السوقية" type="number"/>
<button id="open-calculator" style="margin-right:5px;" type="button">🧮 الحاسبة</button>
</div>
<div class="btn-group">
<button class="btn" id="calculate-valuation">
<i class="fas fa-calculator"></i> احسب التقييم
</button>
<button class="btn" id="import-market-data">
<i class="fas fa-file-import"></i> استيراد بيانات السوق
</button>
<button class="btn" id="fetch-ai-data" style="display:none;">
<i class="fas fa-robot"></i> جلب بيانات الذكاء الاصطناعي
</button>
</div>
</div>
</div>
</div>
<div class="valuation-summary">
<div class="value-card">
<div class="similarity-level" id="market-similarity">--</div>
<h3>القيمة السوقية المقدرة</h3>
<div class="value-amount" id="market-value">--</div>
<p>متوسط سعر المتر: <span id="avg-meter-price">--</span></p>
</div>
<div class="value-card">
<div class="similarity-level" id="rental-similarity">--</div>
<h3>القيمة الإيجارية السنوية</h3>
<div class="value-amount" id="rental-value">--</div>
<p>بناءً على القيمة السوقية</p>
</div>
<div class="value-card">
<div class="similarity-level" id="tax-similarity">--</div>
<h3>الضريبة العقارية السنوية</h3>
<div class="value-amount" id="tax-value">--</div>
<p>للوحدة سكنية</p>
</div>
</div>
<div class="market-data-info">
<h3><i class="fas fa-info-circle"></i> بيانات السوق العقاري</h3>
<p>تم تحديث بيانات السوق في: <strong id="market-update-date">--</strong></p>
<p>مصدر البيانات: <strong id="market-data-source">--</strong></p>
<p>عدد الإعلانات المستخدمة: <strong id="market-ads-count">--</strong></p>
<div id="market-data-preview"></div>
</div>
<div class="section-title">
<h3><i class="fas fa-balance-scale"></i> وحدات مشابهة للاسترشاد (10 وحدات كحد أقصى)</h3>
<div class="btn" id="show-similar">
<i class="fas fa-sync"></i> تحديث النتائج
</div>
</div>
<div class="valuation-summary" id="similar-units-container">
<div class="empty-data">
<i class="fas fa-search"></i>
<h3>لا توجد وحدات مشابهة</h3>
<p>سيتم عرض وحدات مشابهة بعد تقييم الوحدة</p>
</div>
</div>
<div class="export-buttons">
<button class="export-btn excel" id="export-valuation-excel">
<i class="fas fa-file-excel"></i> تصدير Excel
</button>
</div>
</section>
<!-- Official Forms Section -->
<section class="app-section" id="official-forms-section">
<div class="section-title">
<h2><i class="fas fa-file-alt"></i> الاستمارات الرسمية</h2>
<div class="search-icon">
<button class="search-icon-btn" id="forms-search-btn">
<i class="fas fa-search"></i>
</button>
<div class="search-dropdown" id="forms-search-dropdown">
<div class="form-container">
<div class="form-group">
<label>رقم العقار</label>
<input id="search-property-number" placeholder="أدخل رقم العقار" type="text"/>
</div>
<div class="form-group">
<label>الشارع</label>
<input id="search-street" placeholder="اسم الشارع" type="text"/>
</div>
<div class="form-group">
<label>الحى / القرية</label>
<input id="search-district" placeholder="اسم المنطقة أو القرية" type="text"/>
</div>
</div>
<div class="form-type-filter">
<div class="form-type-btn active" data-form-type="all">
جميع الاستمارات
</div>
<div class="form-type-btn" data-form-type="form1">
استمارة الحصر
</div>
<div class="form-type-btn" data-form-type="form2">
استمارة 32
</div>
</div>
<div class="btn-group">
<button class="btn" id="reset-search">
<i class="fas fa-eraser"></i> مسح البحث
</button>
<button class="btn btn-success" id="search-forms">
<i class="fas fa-search"></i> بحث
</button>
</div>
</div>
</div>
</div>
<div class="tab-container">
<div class="tabs">
<div class="tab active" data-target="form1">استمارة الحصر</div>
<div class="tab" data-target="form2">استمارة 32 ض0 ع</div>
</div>
<div class="tab-content active" id="form1">
<div class="official-form">
<h2>استمارة حصر وتقدير العقارات المبنية</h2>
<table>
<tr>
<td class="merged-cell" colspan="18">وزارة المالية</td>
</tr>
<tr>
<td class="merged-cell" colspan="18">مصلحة الضرائب العقارية</td>
</tr>
<tr>
<td class="merged-cell" colspan="18">مديرية الضرائب العقارية</td>
</tr>
<tr>
<td class="merged-cell" colspan="18">استمارة حصر وتقدير العقارات المبنية( سكنى وغير سكنى ) وما فى حكمها</td>
</tr>
<tr id="form1-header">
<td class="merged-cell" colspan="18">
محافظة : ....................................... مأمورية ................................... قرية ..............................................
</td>
</tr>
<!-- Header Row 1 -->
<tr>
<th rowspan="2">رقم العقار</th>
<th rowspan="2">الشارع</th>
<th rowspan="2">عرض الشارع</th>
<th rowspan="2">المالك</th>
<th rowspan="2">مادة البناء</th>
<th rowspan="2">وصف العقار</th>
<th rowspan="2">تاريخ الإنشاء</th>
<th rowspan="2">نوع الاستغلال</th>
<th colspan="4">مشتملات العقار</th>
<th rowspan="2">الشاغل</th>
<th rowspan="2">القيمة الايجارية السنوية</th>
<th rowspan="2">الضريبة المستحقة</th>
<th rowspan="2">طبيعة القرية</th>
</tr>
<!-- Header Row 2 -->
<tr>
<th>الدور</th>
<th>رقم الوحدة</th>
<th>نوع الوحدة</th>
<th>المساحة</th>
</tr>
<!-- Data Rows -->
<tbody id="form1-data">
<tr class="empty-row"><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
</tbody>
<!-- Signature Section -->
<tr>
<td colspan="18">
<div class="signature-area">
<div><strong>توقيع أعضاء لجنة الحصر والتقدير:</strong></div>
<div class="signature-row">
<div class="signature-box">الإسم: ......................................</div>
<div class="signature-box">الصفة: ......................................</div>
<div class="signature-box">التوقيع: ......................................</div>
</div>
<div class="signature-row">
<div class="signature-box">الإسم: ......................................</div>
<div class="signature-box">الصفة: ......................................</div>
<div class="signature-box">التوقيع: ......................................</div>
</div>
<div class="signature-row">
<div class="signature-box">الإسم: ......................................</div>
<div class="signature-box">الصفة: ......................................</div>
<div class="signature-box">التوقيع: ......................................</div>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="tab-content" id="form2">
<div class="official-form">
<h2>استمارة 32 ض0 ع</h2>
<table>
<tr>
<td class="merged-cell" colspan="35">وزارة المالية</td>
</tr>
<tr>
<td class="merged-cell" colspan="35">مصلحة الضرائب العقارية</td>
</tr>
<tr>
<td class="merged-cell" colspan="35">مديرية الضرائب العقارية</td>
</tr>
<tr>
<td class="merged-cell" colspan="35">دفتر حصر وتقدير العقارات المبنية ربط عام 202</td>
</tr>
<tr id="form2-header">
<td class="merged-cell" colspan="35">
محافظة ..................................................................
مأمورية .............................
الناحية ................. ...............
</td>
</tr>
<!-- Main Header Row -->
<tr>
<th rowspan="2">تاريخ الحصر والتقدير</th>
<th rowspan="2">اسم المالك</th>
<th colspan="3">رقم العقار</th>
<th rowspan="2">اسم الشارع</th>
<th rowspan="2">وصف العقار</th>
<th rowspan="2">تاريخ الإنشاء</th>
<th rowspan="2">نوع الإستغلال *</th>
<th rowspan="2">تاريخ تقديم الإقرار ورقم قيده بالسجل</th>
<th colspan="4">مشتملات العقار</th>
<th rowspan="2">اسم الشاغل</th>
<th colspan="5">بيانات التقدير</th>
<th rowspan="2">رقم الإخطار بالتقديرات</th>
<th colspan="2">بيانات لجنة الطعن</th>
<th colspan="3">المعاملة الضريبية</th>
<th colspan="8">بيانات التكليف وتغيراته</th>
<th rowspan="2">ملاحظات</th>
</tr>
<!-- Sub Header Row -->
<tr>
<!-- رقم العقار -->
<th>الحالى</th>
<th>السابق</th>
<th>التنظيم</th>
<!-- مشتملات العقار -->
<th>رقم الدور</th>
<th>رقم الوحدة</th>
<th>نوع الوحدة *</th>
<th>المساحة</th>
<!-- بيانات التقدير -->
<th>الإيجار السنوى</th>
<th>صافى الإيجار السنوى</th>
<th>الضريبة السنوية</th>
<th>معفى</th>
<th>غير معفى</th>
<!-- بيانات لجنة الطعن -->
<th>الإيجار السنوى</th>
<th>الضريبة السنوية</th>
<!-- المعاملة الضريبية -->
<th>غير خاضع</th>
<th>اسم صاحب التكليف السابق</th>
<th>اسم صاحب التكليف الحالى</th>
<!-- بيانات التكليف -->
<th>رقم المكلفة المشترى</th>
<th>اسم المنقول اليه التكليف</th>
<th>السند الناقل للتكليف</th>
<th>رقم وتاريخ اذن نقل التكليف</th>
<th>الحصة المنقولة</th>
<th>اسم البائع</th>
</tr>
<!-- Data Rows -->
<tbody id="form2-data">
<tr class="empty-row"><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
</tbody>
<!-- Footer Notes -->
<tr>
<td colspan="35">
<div class="section-header">تم الحصر والتقدير بمعرفة اللجنة</div>
<p>نوع الاستغلال ، اذا كانت الوحدة غير تامة وغير مشغولة تكتب حالتها تحت الاتمام/ تحت التشطيب</p>
<p>نوع الوحدة ، حجرة . بدروم . شقة . شقة دوبلكس. فيلا منفصلة . فيلا مزدوجة ................. الخ</p>
<div class="signature-area">
<div><strong>أعضاء لجنة الحصر والتقدير:</strong></div>
<div class="signature-row">
<div class="signature-box">...............................</div>
<div class="signature-box">...............................</div>
<div class="signature-box">رئيس اللجنة: ........................</div>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<!-- إضافة قسم نتائج البحث -->
<div class="search-results-container">
<div class="search-results-header">
<h3>نتائج البحث</h3>
<span class="results-count" id="results-count">0 نتائج</span>
</div>
<div id="search-results-body">
<div class="no-results">
<i class="fas fa-search"></i>
<h3>لم يتم إجراء بحث بعد</h3>
<p>استخدم أيقونة البحث للعثور على الاستمارات الرسمية</p>
</div>
</div>
</div>
<div class="btn-group">
<button class="btn btn-success" id="print-form1">
<i class="fas fa-print"></i> طباعة استمارة الحصر
</button>
<button class="btn btn-success" id="print-form2">
<i class="fas fa-print"></i> طباعة استمارة 32
</button>
</div>
</section>
<!-- Addition Decision Section -->
<section class="app-section" id="addition-section">
<div class="section-title">
<h2><i class="fas fa-file-contract"></i> قرار الإضافة</h2>
<div>
<button class="btn" id="print-decision">
<i class="fas fa-print"></i> طباعة القرار
</button>
</div>
</div>
<div class="addition-decision">
<div class="decision-header">
<h2>قرار الإضافة</h2>
<p>قرار إضافة العقارات المبنية وما في حكمها طبقاً لأحكام القانون رقم 196 لسنة 2020</p>
</div>
<div class="decision-details">
<div class="decision-detail">
<label>رقم القرار</label>
<input id="decision-number" type="text" value="١٢٣٤٥"/>
</div>
<div class="decision-detail">
<label>تاريخ القرار</label>
<input id="decision-date" type="text" value="٢٣ يوليو ٢٠٢٥"/>
</div>
<div class="decision-detail">
<label>المحافظة</label>
<input id="decision-governorate" type="text" value="الغربية"/>
</div>
<div class="decision-detail">
<label>الجهة المختصة</label>
<input id="decision-authority" type="text" value="مصلحة الضرائب العقارية"/>
</div>
</div>
<div class="addition-table">
<table>
<thead>
<tr>
<th>رقم العقار</th>
<th>الشارع</th>
<th>الحى / القرية</th>
<th>المركز / المدينة</th>
<th>اسم المالك</th>
<th>رقم الوحدة</th>
<th>الدور</th>
<th>النشاط</th>
<th>القيمة الإيجارية</th>
<th>الضريبة</th>
<!-- إضافة العمودين الجديدين هنا -->
<th>معفى ق117</th>
<th>المقتضى إضافته</th>
</tr>
</thead>
<tbody id="addition-table-body">
<!-- سيتم ملؤه بالبيانات -->
</tbody>
<tfoot>
<tr class="total-row">
<td colspan="8" style="text-align: left;">الإجمالي</td>
<td id="total-rental">٠ ج.م</td>
<td id="total-tax">٠ ج.م</td>
<td id="total-exempt">٠ ج.م</td>
<td id="total-payable">٠ ج.م</td>
</tr>
</tfoot>
</table>
</div>
<div class="signature-section">
<div class="signature-row">
<div class="signature-box">
<div class="signature-line"></div>
<div>رئيس اللجنة</div>
</div>
<div class="signature-box">
<div class="signature-line"></div>
<div>عضو اللجنة</div>
</div>
<div class="signature-box">
<div class="signature-line"></div>
<div>عضو اللجنة</div>
</div>
<div class="signature-box">
<div class="signature-line"></div>
<div>مقرر اللجنة</div>
</div>
</div>
</div>
</div>
<div class="export-buttons">
<button class="export-btn excel" id="export-addition-excel"><i class="fas fa-file-excel"></i> تصدير Excel</button>
</div>
</section>
<!-- Map Section -->
<section class="app-section" id="map-section">
<div class="section-title">
<h2><i class="fas fa-map-marked-alt"></i> الخريطة العقارية</h2>
<div class="btn" id="refresh-map">
<i class="fas fa-sync"></i> تحديث الخريطة
</div>
<button class="export-btn image" id="export-map-package" style="margin-right:10px;"><i class="fas fa-download"></i> تصدير الخريطة (صورة + بيانات GPS)</button>
</div>
<div class="map-container">
<div id="map"></div>
</div>
<div class="regression-info">
<h3><i class="fas fa-info-circle"></i> معلومات الخريطة:</h3>
<ul>
<li>تعرض الخريطة جميع العقارات المسجلة في النظام</li>
<li>يمكنك النقر على أي عقار لعرض معلوماته الأساسية ووحداته</li>
<li>يتم تمثيل العقارات بنقاط زرقاء</li>
<li>العقارات التي تحتوي على صور تمثل بنقاط خضراء</li>
<li>تمت الاستعانة ببيانات السوق العقاري الحديثة في التقييم</li>
</ul>
</div>
<div class="export-buttons">
<button class="export-btn image" id="export-map-image">
<i class="fas fa-download"></i> تصدير الصورة
</button>
</div>
</section>
<section class="app-section" id="stats-section">
<div class="section-title">
<h2><i class="fas fa-chart-pie"></i> الإحصائيات التفصيلية حسب الشارع</h2>
<div class="btn-group">
<button class="export-btn excel" id="export-street-stats-excel">
<i class="fas fa-file-excel"></i> تصدير Excel
        </button>
<button class="export-btn" id="export-street-stats-csv" style="background-color:#f39c12;">
<i class="fas fa-file-csv"></i> تصدير CSV
        </button>
<button class="export-btn image" id="export-street-stats-pdf" style="background-color:#34495e;">
<i class="fas fa-file-pdf"></i> تصدير PDF
        </button>
</div>
</div>
<div class="street-stats-header">
<h3>إحصائيات مفصلة حسب الشارع</h3>
<div class="street-filter">
<input id="street-filter" placeholder="البحث باسم الشارع..." type="text"/>
<button class="btn" id="refresh-stats">
<i class="fas fa-sync"></i> تحديث
        </button>
</div>
</div>
<div class="street-summary-cards">
<div class="street-summary-card">
<h3>إجمالي العقارات</h3>
<div class="street-summary-value" id="total-properties">0</div>
</div>
<div class="street-summary-card">
<h3>إجمالي الوحدات</h3>
<div class="street-summary-value" id="total-units">0</div>
</div>
<div class="street-summary-card">
<h3>إجمالي القيمة الإيجارية</h3>
<div class="street-summary-value" id="total-rental">0.00</div>
</div>
<div class="street-summary-card">
<h3>إجمالي الضريبة السنوية</h3>
<div class="street-summary-value" id="total-tax">0.00</div>
</div>
</div>
<div class="table-responsive">
<table class="street-stats-table">
<thead>
<tr>
<th>الشارع</th>
<th>عدد العقارات</th>
<th>عدد الوحدات</th>
<th>إجمالي القيمة الإيجارية</th>
<th>إجمالي الضريبة السنوية</th>
<th>الحالة</th>
<th>الإجراءات</th>
</tr>
</thead>
<tbody id="street-stats-body">
<tr>
<td colspan="6" style="text-align: center; padding: 30px;">
<i class="fas fa-inbox"></i>
<h3>لا توجد بيانات إحصائية بعد</h3>
<p>سيتم عرض الإحصائيات بعد إضافة عقارات ووحدات</p>
</td>
</tr>
</tbody>
</table>
</div>
</section>
<footer>
<p>جميع الحقوق محفوظة - تم التصميم والإنشاء والتطوير بواسطة</p>
<p class="signature">هانى العجان - مدير عام الإدارة العامة للمباني بالضرائب العقارية بالغربية</p>
<p>الإصدار 5.0.0 - تم التحديث: أغسطس 2025</p>
</footer>
</div>
<!-- Overlay for loading indicator -->
<div class="loading-overlay" id="loading-overlay">
<div class="loading-content">
<div class="loading-spinner"></div>
<div class="loading-text">جاري التصدير، الرجاء الانتظار...</div>
</div>
</div>
<!-- نافذة الحاسبة -->
<div id="calculator-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
background:#fff; border:2px solid #333; padding:15px; z-index:1000; border-radius:8px; box-shadow:0 0 15px rgba(0,0,0,0.5);">
<h3 style="margin-top:0;">آلة حاسبة</h3>
<input id="calc-display" readonly="" style="width:100%; font-size:18px; margin-bottom:10px; text-align:right;" type="text"/>
<div id="calc-buttons" style="display:grid; grid-template-columns:repeat(4, 50px); gap:5px; justify-content:center;">
<button>7</button><button>8</button><button>9</button><button>/</button>
<button>4</button><button>5</button><button>6</button><button>*</button>
<button>1</button><button>2</button><button>3</button><button>-</button>
<button>0</button><button>.</button><button>=</button><button>+</button>
<button id="calc-clear" style="grid-column:span 4; background:#f55; color:#fff;">مسح</button>
<button id="calc-use" style="grid-column:span 4; background:#28a745; color:#fff;">استخدام النتيجة</button>
<button id="calc-close" style="grid-column:span 4; background:#777; color:#fff;">إغلاق</button>
</div>
</div>
<script>

function getFloorFactor(floorNumber) {
    let floorFactor = 1.0;
    if (floorNumber === 1) {
        floorFactor = 0.98;
    } else if (floorNumber >= 2 && floorNumber <= 4) {
        floorFactor = 1.0;
    } else if (floorNumber === 5) {
        floorFactor = 0.98;
    } else if (floorNumber === 6) {
        floorFactor = 0.96;
    } else if (floorNumber >= 7) {
        floorFactor = 0.94;
    }
    return floorFactor;
}


// === Safe arithmetic evaluator (no eval) ===
function safeEvalExpression(expr) {
// Allow only digits, operators, parentheses, dot and spaces
if (!/^[0-9+\-*/%().\s]+$/.test(expr)) return "خطأ";
try {
// Shunting-yard algorithm to handle operator precedence safely
const output = [];
const ops = [];
const prec = {'+':1,'-':1,'*':2,'/':2,'%':2};
const assoc = {'+':'L','-':'L','*':'L','/':'L','%':'L'};
let i=0, num='';
const pushNumber = () => {
if (num !== '') { output.push(parseFloat(num)); num=''; }
};
while (i < expr.length) {
const c = expr[i];
if (c >= '0' && c <= '9' || c === '.') { num += c; }
else if (c in prec) {
pushNumber();
while (ops.length) {
const top = ops[ops.length-1];
if ((top in prec) && (prec[top] > prec[c] || (prec[top] === prec[c] && assoc[c] === 'L'))) {
output.push(ops.pop());
} else break;
}
ops.push(c);
} else if (c === '(') { pushNumber(); ops.push(c); }
else if (c === ')') {
pushNumber();
while (ops.length && ops[ops.length-1] !== '(') output.push(ops.pop());
if (ops.length && ops[ops.length-1] === '(') ops.pop(); else return "خطأ";
}
// ignore spaces and others (already validated)
i++;
}
pushNumber();
while (ops.length) {
const op = ops.pop();
if (op === '(' || op === ')') return "خطأ";
output.push(op);
}
// Evaluate RPN
const stack = [];
for (const token of output) {
if (typeof token === 'number') stack.push(token);
else {
if (stack.length < 2) return "خطأ";
const b = stack.pop(), a = stack.pop();
let r;
switch (token) {
case '+': r = a + b; break;
case '-': r = a - b; break;
case '*': r = a * b; break;
case '/': r = b === 0 ? NaN : a / b; break;
case '%': r = a % b; break;
default: return "خطأ";
}
stack.push(r);
}
}
if (stack.length !== 1 || !isFinite(stack[0])) return "خطأ";
// Keep up to 6 decimal places without trailing zeros
const out = stack[0];
return (Math.round(out * 1e6) / 1e6).toString();
} catch (_) {
return "خطأ";
}
}
// ======== التطبيق الرئيسي ========
const RealEstateApp = {
// تخزين البيانات
properties: [],
currentProperty: null,
units: [],
similarUnits: [],
similarityLevel: '',
map: null,
marketData: null,
searchResults: [],
importedProperties: [], // العقارات المستوردة المؤقتة
        editingUnitIndex: null,
        lastUpdatedUnitIndex: null,
isOnline: true, // حالة الاتصال بالإنترنت
// تهيئة التطبيق
init: function() {
this.loadData();
this.setupEventListeners();
this.updateMarketData();
this.updateMap();
this.initSearchEvents();
this.fillAdditionTable(); // تعبئة جدول قرار الإضافة عند التحميل
this.checkConnection(); // التحقق من حالة الاتصال
this.registerServiceWorker(); // تسجيل Service Worker
},
// تسجيل Service Worker
registerServiceWorker: function() {
if ('serviceWorker' in navigator) {
navigator.serviceWorker.register('/service-worker.js')
.then(registration => {
console.log('Service Worker مسجل بنجاح:', registration);
})
.catch(error => {
console.error('فشل تسجيل Service Worker:', error);
});
}
},
// التحقق من حالة الاتصال
checkConnection: function() {
this.isOnline = navigator.onLine;
this.updateConnectionStatus();
// استمع لتغيرات حالة الاتصال
window.addEventListener('online', () => {
this.isOnline = true;
this.updateConnectionStatus();
this.showNotification('تم استعادة الاتصال بالإنترنت');
});
window.addEventListener('offline', () => {
this.isOnline = false;
this.updateConnectionStatus();
this.showNotification('فقدت الاتصال بالإنترنت. العمل في وضع عدم الاتصال', 'warning');
});
},
// تحديث واجهة حالة الاتصال
updateConnectionStatus: function() {
const statusEl = document.getElementById('connection-status');
if (this.isOnline) {
statusEl.className = 'connection-status online';
statusEl.innerHTML = '<i class="fas fa-wifi"></i> متصل بالإنترنت';
} else {
statusEl.className = 'connection-status offline';
statusEl.innerHTML = '<i class="fas fa-cloud-download-alt"></i> وضع عدم الاتصال';
}
},
// تحميل البيانات من التخزين المحلي
loadData: function() {
this.properties = JSON.parse(localStorage.getItem('realEstateProperties')) || [];
this.marketData = JSON.parse(localStorage.getItem('realEstateMarketData')) || {
lastUpdated: null,
properties: [],
source: "بيانات افتراضية"
};
},
// إعداد مستمعي الأحداث
setupEventListeners: function() {
// تغيير طريقة التقييم
document.getElementById('valuation-method').addEventListener('change', (e) => {
document.getElementById('fetch-ai-data').style.display =
e.target.value === 'ai' ? 'inline-block' : 'none';
});
// جلب بيانات الذكاء الاصطناعي
document.getElementById('fetch-ai-data').addEventListener('click', () => this.fetchAIData());
// التنقل بين الأقسام
document.querySelectorAll('.nav-btn').forEach(button => {
button.addEventListener('click', (e) => {
const target = e.target.getAttribute('data-target');
this.showSection(target);
});
});
// أحداث النسخ الاحتياطي والتصدير
document.getElementById('export-backup-all').addEventListener('click', () => this.exportBackupAll());
document.getElementById('export-property-excel').addEventListener('click', () => this.exportPropertyExcel());
document.getElementById('export-units-excel').addEventListener('click', () => this.exportUnitsExcel());
document.getElementById('export-valuation-excel').addEventListener('click', () => this.exportValuationExcel());
document.getElementById('export-addition-excel').addEventListener('click', () => this.exportAdditionExcel());
document.getElementById('export-map-image').addEventListener('click', () => this.exportMapImage());
document.getElementById('import-properties').addEventListener('click', () => this.importProperties());
// أحداث الحفظ والحذف
document.getElementById('save-property').addEventListener('click', () => this.saveProperty());
document.getElementById('delete-property').addEventListener('click', () => this.deleteProperty());
document.getElementById('reset-form').addEventListener('click', () => this.resetForm());
// إدارة الوحدات
document.getElementById('add-unit-btn').addEventListener('click', () => this.addUnit());
document.getElementById('calculate-values-btn').addEventListener('click', () => this.calculateUnitValues());
document.getElementById('calculate-valuation').addEventListener('click', () => this.calculateValuation());
// أحداث الخريطة
document.getElementById('refresh-map').addEventListener('click', () => this.updateMap());
document.getElementById('get-gps').addEventListener('click', () => this.getGPSLocation());
// أحداث البحث الجديدة
document.getElementById('search-forms').addEventListener('click', () => this.searchOfficialForms());
document.getElementById('reset-search').addEventListener('click', () => this.resetSearch());
document.getElementById('search-property').addEventListener('click', () => this.searchProperty());
document.getElementById('reset-property-search').addEventListener('click', () => this.resetPropertySearch());
// أحداث أيقونات البحث
document.getElementById('forms-search-btn').addEventListener('click', (e) => {
e.stopPropagation();
const dropdown = document.getElementById('forms-search-dropdown');
dropdown.classList.toggle('active');
});
document.getElementById('property-search-btn').addEventListener('click', (e) => {
e.stopPropagation();
const dropdown = document.getElementById('property-search-dropdown');
dropdown.classList.toggle('active');
});
// إغلاق القوائم المنسدلة عند النقر خارجها
document.addEventListener('click', (e) => {
if (!e.target.closest('.search-dropdown')) {
document.querySelectorAll('.search-dropdown').forEach(dropdown => {
dropdown.classList.remove('active');
});
}
});
// أحداث أخرى
document.getElementById('import-market-data').addEventListener('click', () => this.importMarketData());
document.getElementById('show-similar').addEventListener('click', () => this.showSimilarUnits());
document.getElementById('print-decision').addEventListener('click', () => this.printDecision());
document.getElementById('print-form1').addEventListener('click', () => this.printForm1());
document.getElementById('print-form2').addEventListener('click', () => this.printForm2());
// معاينة الصور
document.getElementById('property-images').addEventListener('change', (e) => this.previewImages(e));
// التقييم النجمي
document.querySelectorAll('.unit-rating .star').forEach(star => {
star.addEventListener('click', (e) => {
const rating = parseInt(e.target.closest('.star').dataset.rating);
this.setUnitRating(rating);
});
});
// تصفية الوحدات
document.querySelectorAll('.filter-btn').forEach(btn => {
btn.addEventListener('click', (e) => {
document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
e.target.classList.add('active');
this.filterUnits(e.target.dataset.filter);
});
});
// أحداث الاستيراد والدمج
document.getElementById('import-merge').addEventListener('click', () => this.importProperties('merge'));
document.getElementById('import-replace').addEventListener('click', () => this.importProperties('replace'));
document.getElementById('import-add').addEventListener('click', () => this.importProperties('add'));
document.getElementById('confirm-merge').addEventListener('click', () => this.confirmMerge());
document.getElementById('cancel-merge').addEventListener('click', () => this.cancelMerge());
},
// ======== وظائف الأقسام ========
// عرض قسم معين وإخفاء البقية
showSection: function(sectionId) {
// إخفاء جميع الأقسام
document.querySelectorAll('.app-section').forEach(section => {
section.classList.remove('active');
});
// إزالة النشط من أزرار التنقل
document.querySelectorAll('.nav-btn').forEach(btn => {
btn.classList.remove('active');
});
// إظهار القسم المطلوب
document.getElementById(sectionId).classList.add('active');
// تحديد الزر النشط
document.querySelector(`.nav-btn[data-target="${sectionId}"]`).classList.add('active');
// تحديث المحتوى حسب القسم
switch(sectionId) {
case 'map-section':
this.updateMap();
break;
case 'valuation-section':
this.updateMarketData();
break;
case 'addition-section':
this.fillAdditionTable(); // تحديث جدول قرار الإضافة
break;
case 'official-forms-section':
this.resetSearch();
break;
}
},
// ======== وظائف العقارات ========
// حفظ العقار
saveProperty: function() {
// جمع البيانات من النموذج
const propertyData = {
id: this.currentProperty?.id || Date.now(),
propertyNumber: document.getElementById('property-number').value,
// إضافة التعديل: جمع رقم العقار السابق
previousPropertyNumber: document.getElementById('previous-property-number').value,
street: document.getElementById('street').value,
streetWidth: document.getElementById('street-width').value,
district: document.getElementById('district').value,
city: document.getElementById('city').value,
governorate: document.getElementById('governorate').value,
buildingMaterial: document.getElementById('building-material').value,
constructionYear: document.getElementById('construction-year').value,
responsibleName: document.getElementById('responsible-name').value,
detailedDescription: document.getElementById('detailed-description').value,
owner: document.getElementById('owner').value,
// إضافة التعديل: جمع الرقم القومي للمالك
ownerNationalId: document.getElementById('owner-national-id').value,
area: parseFloat(document.getElementById('area').value) || 0,
floors: parseInt(document.getElementById('floors').value) || 0,
unitsCount: parseInt(document.getElementById('units-count').value) || 0,
propertyType: document.getElementById('property-type').value,
coordinates: document.getElementById('coordinates').value,
units: [...this.units],
images: this.getPropertyImages()
};
// التحقق من البيانات الأساسية
if (!propertyData.propertyNumber || !propertyData.street || !propertyData.district || !propertyData.city || !propertyData.governorate) {
this.showNotification('الرجاء إدخال البيانات الأساسية للعقار (الرقم العقاري، الشارع، القرية، المدينة، المحافظة)', 'error');
return;
}
// التحقق من التكرار في نفس الشارع
const duplicateProperty = this.properties.find(p =>
p.id !== propertyData.id &&
p.propertyNumber === propertyData.propertyNumber &&
p.street === propertyData.street &&
p.district === propertyData.district
);
if (duplicateProperty) {
document.getElementById('duplicate-warning').classList.add('show');
if (!confirm(`يوجد عقار آخر (${duplicateProperty.propertyNumber}) بنفس الرقم في نفس الشارع. هل تريد الاستمرار في الحفظ؟`)) {
return;
}
} else {
document.getElementById('duplicate-warning').classList.remove('show');
}
// تحديث أو إضافة العقار
if (this.currentProperty) {
const index = this.properties.findIndex(p => p.id === this.currentProperty.id);
if (index !== -1) {
this.properties[index] = propertyData;
}
} else {
this.properties.push(propertyData);
}
// حفظ في التخزين المحلي
        // لا نقوم بإزالة وسم المستورد عن كل العقارات، فقط العقار الحالي
localStorage.setItem('realEstateProperties', JSON.stringify(this.properties));
// تحديث واجهة المستخدم
this.currentProperty = propertyData;
this.updateMap();
this.fillOfficialForm1(propertyData);
this.fillOfficialForm2(propertyData);
this.fillAdditionTable(); // تحديث جدول قرار الإضافة بعد الحفظ
// عرض رسالة تأكيد الحفظ
this.showNotification('تم حفظ بيانات العقار بنجاح!');
        if (this.currentProperty && (this.currentProperty._imported || this.currentProperty.imported)) {
            this.showNotification('تم تحويل العقار المستورد الحالي إلى محفوظ بنجاح');
        }
},
// مسح النموذج
resetForm: function() {
if (confirm('هل تريد مسح جميع البيانات بما في ذلك بيانات الموقع الجغرافي؟')) {
// مسح كل شيء بما في ذلك بيانات الموقع الجغرافي
document.getElementById('property-number').value = '';
// إضافة التعديل: مسح رقم العقار السابق
document.getElementById('previous-property-number').value = '';
document.getElementById('street').value = '';
document.getElementById('street-width').value = '';
document.getElementById('district').value = '';
document.getElementById('city').value = '';
document.getElementById('governorate').value = '';
} else {
// الاحتفاظ ببيانات الموقع الجغرافي فقط
const street = document.getElementById('street').value;
const streetWidth = document.getElementById('street-width').value;
const district = document.getElementById('district').value;
const city = document.getElementById('city').value;
const governorate = document.getElementById('governorate').value;
}
// مسح باقي الحقول في كل الحالات
document.getElementById('building-material').value = 'concrete';
document.getElementById('construction-year').value = '';
document.getElementById('responsible-name').value = '';
document.getElementById('owner').value = '';
// إضافة التعديل: مسح الرقم القومي للمالك
document.getElementById('owner-national-id').value = '';
document.getElementById('area').value = '';
document.getElementById('floors').value = '';
document.getElementById('units-count').value = '';
document.getElementById('detailed-description').value = '';
document.getElementById('property-images').value = '';
document.getElementById('image-preview').innerHTML = '';
document.getElementById('property-documents').value = '';
document.getElementById('documents-preview').innerHTML = '';
document.getElementById('coordinates').value = '';
document.getElementById('duplicate-warning').classList.remove('show');
this.units = [];
this.updateUnitsTable();
this.currentProperty = null;
// استعادة بيانات الموقع الجغرافي إذا لم يتم مسحها
if (!confirm) {
document.getElementById('street').value = street;
document.getElementById('street-width').value = streetWidth;
document.getElementById('district').value = district;
document.getElementById('city').value = city;
document.getElementById('governorate').value = governorate;
}
this.showNotification('تم مسح النموذج بنجاح!');
},
// حذف العقار
deleteProperty: function() {
if (!this.currentProperty) {
this.showNotification('لا يوجد عقار محدد للحذف', 'error');
return;
}
if (confirm(`هل أنت متأكد من حذف عقار ${this.currentProperty.propertyNumber}؟`)) {
const index = this.properties.findIndex(p => p.id === this.currentProperty.id);
if (index !== -1) {
this.properties.splice(index, 1);
localStorage.setItem('realEstateProperties', JSON.stringify(this.properties));
this.resetForm();
this.updateMap();
this.fillAdditionTable(); // تحديث جدول قرار الإضافة بعد الحذف
this.showNotification('تم حذف العقار بنجاح');
}
}
},
// معاينة الصور
previewImages: function(e) {
const preview = document.getElementById('image-preview');
preview.innerHTML = '';
Array.from(e.target.files).forEach(file => {
if (!file.type.match('image.*')) return;
const reader = new FileReader();
reader.onload = function(e) {
const img = document.createElement('img');
img.src = e.target.result;
preview.appendChild(img);
}
reader.readAsDataURL(file);
});

        // إذا كان العقار مستوردًا وتم تحميله، عند الحفظ نحوله إلى محفوظ (نزيل وسم المستورد)
        // If the current property was imported, mark only this one as saved (remove imported flag)
        if (this.currentProperty && (this.currentProperty._imported || this.currentProperty.imported)) {
            propertyData._imported = false;
            propertyData.imported = false;
        }
},
// الحصول على صور العقار
getPropertyImages: function() {
const images = [];
document.querySelectorAll('#image-preview img').forEach(img => {
images.push(img.src);
});
return images;
},
// ======== وظائف الوحدات ========
// إضافة وحدة
addUnit: function() {
// جمع بيانات الوحدة
const unitData = {
floor: document.getElementById('unit-floor').value || '0',
number: document.getElementById('unit-number').value || '', // رقم الوحدة
owner: document.getElementById('unit-owner').value || 'غير معروف',
// إضافة التعديل: جمع الرقم القومي للمالك للوحدة
ownerNationalId: document.getElementById('unit-owner-national-id').value || '',
area: document.getElementById('unit-area').value || '0',
status: document.getElementById('unit-status').value,
useType: document.getElementById('unit-use-type').value,
unitType: document.getElementById('unit-type').value,
finishing: document.getElementById('unit-finishing').value,
occupant: document.getElementById('unit-occupant').value,
activity: document.getElementById('unit-activity').value || '' // إضافة النشاط
};
// التحقق من البيانات الأساسية
if (!unitData.floor || !unitData.area) {
this.showNotification('الرجاء إدخال رقم الدور ومساحة الوحدة', 'error');
return;
}

        const wasEditing = (this.editingUnitIndex !== null && typeof this.editingUnitIndex !== 'undefined');
// إضافة الوحدة
if (this.editingUnitIndex !== null && typeof this.editingUnitIndex !== 'undefined') {
            this.units[this.editingUnitIndex] = unitData;
            // حساب القيم فور تحديث الوحدة
            try { this.calculateUnitValues({ floor: unitData.floor, number: unitData.number }); } catch(e) {}
            // حفظ مؤشر آخر وحدة تم تحديثها حتى يتمكن زر احتساب القيم من التعرف عليها بعد الحفظ
            this.lastUpdatedUnitIndex = this.editingUnitIndex;
            this.editingUnitIndex = null;
            const addBtn = document.getElementById('add-unit-btn');
            if (addBtn) { addBtn.textContent = 'إضافة وحدة'; delete addBtn.dataset.editing; }
        } else {
            this.units.push(unitData);
            // حساب القيم للوحدة المضافة فورًا
            try {
                const newIndex = this.units.length - 1;
                this.lastUpdatedUnitIndex = newIndex;
                this.calculateUnitValues({ floor: unitData.floor, number: unitData.number });
            } catch (e) {}
        }
this.updateUnitsTable();
// مسح حقول الوحدة
document.getElementById('unit-floor').value = '';
document.getElementById('unit-number').value = '';
document.getElementById('unit-owner').value = '';
// إضافة التعديل: مسح الرقم القومي للمالك للوحدة
document.getElementById('unit-owner-national-id').value = '';
document.getElementById('unit-area').value = '';
document.getElementById('unit-occupant').value = '';
document.getElementById('unit-activity').value = '';
if (wasEditing) { this.showNotification('تم تحديث بيانات الوحدة بنجاح'); } else { this.showNotification('تمت إضافة الوحدة بنجاح!'); }
},
// تحديث جدول الوحدات
updateUnitsTable: function() {
const tbody = document.getElementById('units-table-body');
tbody.innerHTML = '';
if (this.units.length === 0) {
tbody.innerHTML = `
<tr class="empty-data-row">
<td colspan="12">
<div class="empty-data">
<i class="fas fa-inbox"></i>
<h3>لا توجد وحدات مسجلة</h3>
<p>قم بإضافة وحدات العقار باستخدام النموذج أعلاه</p>
</div>
</td>
</tr>
`;
return;
}
// إعداد خرائط للقيم
const statusMap = {
'complete': 'تامة',
'incomplete': 'غير تامة',
'occupied': 'مشغولة'
};
const useTypeMap = {
'residential': 'سكني',
'commercial': 'تجاري',
'administrative': 'إداري',
'space': 'فضاء',
'utilized_space': 'فضاء مستغل'
};
const unitTypeMap = {
'apartment': 'شقة',
'duplex': 'دوبلكس',
'villa': 'فيلا',
'shop': 'محل',
'warehouse': 'مخزن',
'workshop': 'ورشة',
'clinic': 'عيادة',
'office': 'مكتب',
'space': 'فضاء',
'utilized_space': 'فضاء مستغل'
};
// إضافة الوحدات إلى الجدول
this.units.forEach((unit, index) => {
const pricePerMeter = unit.marketValue > 0 && unit.area > 0 ? unit.marketValue / unit.area : 0;
const tr = document.createElement('tr');
tr.innerHTML = `
<td>${unit.floor}</td>
<td>${unit.number || '--'}</td> <!-- رقم الوحدة -->
<td>${unit.owner}</td>
<!-- إضافة التعديل: عرض الرقم القومي للمالك -->
<td>${unit.ownerNationalId || '--'}</td>
<td>${unit.area} م²</td>
<td>${pricePerMeter ? this.formatCurrency(pricePerMeter) : '--'}</td>
<td>${unitTypeMap[unit.unitType] || unit.unitType}</td>
<td>${useTypeMap[unit.useType] || unit.useType}</td>
<td>${unit.activity || '--'}</td>
<td>${statusMap[unit.status] || unit.status}</td>
<td>
<div class="value-badge market">
<i class="fas fa-tag"></i> القيمة السوقية: ${unit.marketValue ? this.formatCurrency(unit.marketValue) : '--'}
</div>
<div class="value-badge rental">
<i class="fas fa-hand-holding-usd"></i> القيمة الإيجارية: ${unit.rentalValue ? this.formatCurrency(unit.rentalValue) : '--'}
</div>
<div class="value-badge net-rental">
<i class="fas fa-coins"></i> صافي الإيجار: ${unit.netRentalValue ? this.formatCurrency(unit.netRentalValue) : '--'}
</div>
<div class="value-badge tax">
<i class="fas fa-file-invoice-dollar"></i> الضريبة: ${unit.tax ? this.formatCurrency(unit.tax) : '--'}
</div>
</td>
<td>
<button class="btn btn-warning edit-unit" style="padding: 5px 10px; font-size: 14px;">
<i class="fas fa-edit"></i>
</button>
<button class="btn btn-danger delete-unit" style="padding: 5px 10px; font-size: 14px;">
<i class="fas fa-trash"></i>
</button>
</td>
`;
tbody.appendChild(tr);
// إضافة أحداث لحذف الوحدة
tr.querySelector('.delete-unit').addEventListener('click', () => {
if (confirm('هل أنت متأكد من حذف هذه الوحدة؟')) {
this.units.splice(index, 1);
this.updateUnitsTable();
this.showNotification('تم حذف الوحدة بنجاح');
}
});
            // زر التعديل
            const editBtn = tr.querySelector('.edit-unit');
            if (editBtn) {
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const unit = this.units[index];
                    // ملء نموذج الوحدة بالبيانات
                    document.getElementById('unit-floor').value = unit.floor || '';
                    document.getElementById('unit-number').value = unit.number || '';
                    document.getElementById('unit-owner').value = unit.owner || '';
                    document.getElementById('unit-owner-national-id').value = unit.ownerNationalId || '';
                    document.getElementById('unit-area').value = unit.area || '';
                    document.getElementById('unit-status').value = unit.status || '';
                    document.getElementById('unit-use-type').value = unit.useType || '';
                    document.getElementById('unit-type').value = unit.unitType || '';
                    document.getElementById('unit-finishing').value = unit.finishing || '';
                    document.getElementById('unit-occupant').value = unit.occupant || '';
                    document.getElementById('unit-activity').value = unit.activity || '';
                    this.editingUnitIndex = index;
                    const addBtn = document.getElementById('add-unit-btn');
                    if (addBtn) { addBtn.textContent = 'تحديث الوحدة'; addBtn.dataset.editing = 'true'; }
                });
            }

});
},
// ======== وظائف التقييم ========
// جلب بيانات الذكاء الاصطناعي
fetchAIData: function() {
if (!this.currentProperty) {
this.showNotification('الرجاء تحديد عقار أولاً', 'error');
return;
}
const loadingEl = document.createElement('span');
loadingEl.className = 'ai-loading';
loadingEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري جلب البيانات...';
const btn = document.getElementById('fetch-ai-data');
btn.disabled = true;
btn.appendChild(loadingEl);
// محاكاة جلب بيانات من واجهة برمجة تطبيقات الذكاء الاصطناعي
setTimeout(() => {
// بيانات وهمية من مواقع التسويق العقاري
const aiData = [
{
source: 'موقع عقار (AI)',
price: Math.floor(Math.random() * 500000) + 1000000,
area: Math.floor(Math.random() * 50) + 80,
location: this.currentProperty.district,
similarity: 'high',
features: ['تشطيب فاخر', '3 غرف', '2 حمام']
},
{
source: 'سوق العقار (AI)',
price: Math.floor(Math.random() * 600000) + 900000,
area: Math.floor(Math.random() * 60) + 70,
location: this.currentProperty.district,
similarity: 'medium',
features: ['تشطيب متوسط', '2 غرف', '1 حمام']
}
];
this.marketData = {
lastUpdated: new Date().toISOString(),
properties: aiData,
source: "نموذج الذكاء الاصطناعي"
};
localStorage.setItem('realEstateMarketData', JSON.stringify(this.marketData));
this.updateMarketDataUI();
btn.removeChild(loadingEl);
btn.disabled = false;
this.showNotification('تم جلب بيانات الذكاء الاصطناعي بنجاح');
}, 2000);
},
// حساب القيم باستخدام الذكاء الاصطناعي
calculateWithAI: function() {
if (!this.marketData || this.marketData.properties.length === 0) {
this.showNotification('الرجاء جلب بيانات الذكاء الاصطناعي أولاً', 'error');
return;
}
this.units.forEach(unit => {
// تحليل البيانات باستخدام نموذج الذكاء الاصطناعي (محاكاة)
const similarUnits = this.marketData.properties.filter(u =>
u.area >= unit.area * 0.8 && u.area <= unit.area * 1.2
);
if (similarUnits.length > 0) {
const avgPricePerMeter = similarUnits.reduce((sum, u) => sum + (u.price / u.area), 0) / similarUnits.length;
// تعديل السعر بناءً على مواصفات الوحدة
let pricePerMeter = avgPricePerMeter;
// تعديل حسب نوع التشطيب
if (unit.finishing === 'high') pricePerMeter *= 1.2;
else if (unit.finishing === 'luxury') pricePerMeter *= 1.5;
else if (unit.finishing === 'basic') pricePerMeter *= 0.9;
else if (unit.finishing === 'none') pricePerMeter *= 0.7;
// تعديل حسب نوع الوحدة
if (unit.unitType === 'villa') pricePerMeter *= 1.3;
else if (unit.unitType === 'duplex') pricePerMeter *= 1.2;
else if (unit.unitType === 'shop') pricePerMeter *= 1.1;
unit.marketValue = pricePerMeter * unit.area;
unit.rentalValue = unit.marketValue * 0.018;
unit.netRentalValue = unit.useType === 'residential' ? unit.rentalValue * 0.7 : unit.rentalValue * 0.68;
unit.tax = unit.useType === 'residential' ? unit.marketValue * 0.00126 : unit.marketValue * 0.001224;
} else {
// استخدام القيم الافتراضية إذا لم توجد وحدات مشابهة
unit.marketValue = unit.area * 8000;
unit.rentalValue = unit.marketValue * 0.018;
unit.netRentalValue = unit.useType === 'residential' ? unit.rentalValue * 0.7 : unit.rentalValue * 0.68;
unit.tax = unit.useType === 'residential' ? unit.marketValue * 0.00126 : unit.marketValue * 0.001224;
}
});
this.updateUnitsTable();
this.calculateValuation();
this.showNotification('تم حساب القيم باستخدام الذكاء الاصطناعي بنجاح');
},
// تحديث بيانات السوق
updateMarketData: function() {
const now = new Date();
const twoMonthsAgo = new Date();
twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
// إذا مر أكثر من شهرين أو لا توجد بيانات، جلب بيانات جديدة
if (!this.marketData.lastUpdated || new Date(this.marketData.lastUpdated) < twoMonthsAgo || this.marketData.properties.length === 0) {
// محاكاة جلب بيانات من مواقع التسويق العقاري
const demoData = [
{
id: 1,
governorate: "الغربية",
city: "طنطا",
district: "حي أول",
street: "شارع الجلاء",
constructionYear: 2015,
area: 120,
unitType: "شقة",
price: 1500000,
pricePerMeter: 12500,
description: '3 غرف، تشطيب متوسط، دور 3',
adDate: "2025-05-15",
similarity: 'street',
source: 'موقع عقار'
},
{
id: 2,
governorate: "الغربية",
city: "طنطا",
district: "حي ثان",
street: "شارع النصر",
constructionYear: 2018,
area: 150,
unitType: "شقة",
price: 1800000,
pricePerMeter: 12000,
description: '3 غرف، تشطيب فاخر، دور 2',
adDate: "2025-06-20",
similarity: 'village',
source: 'موقع عقار'
},
{
id: 3,
governorate: "الغربية",
city: "طنطا",
district: "حي أول",
street: "شارع سعد زغلول",
constructionYear: 2010,
area: 100,
unitType: "شقة",
price: 1000000,
pricePerMeter: 10000,
description: '2 غرف، تشطيب عادي، دور 1',
adDate: "2025-07-10",
similarity: 'street',
source: 'موقع عقار'
}
];
this.marketData = {
lastUpdated: new Date().toISOString(),
properties: demoData,
source: "بيانات افتراضية"
};
localStorage.setItem('realEstateMarketData', JSON.stringify(this.marketData));
}
// تحديث معلومات السوق في الواجهة
const updateDate = new Date(this.marketData.lastUpdated).toLocaleDateString('ar-EG');
document.getElementById('market-update-date').textContent = updateDate;
document.getElementById('market-data-source').textContent = this.marketData.source;
document.getElementById('market-ads-count').textContent = this.marketData.properties.length;
},
// احتساب قيم الوحدات
calculateUnitValues: function(target) {
    const method = document.getElementById('valuation-method')?.value || 'regression';
    if (!this.units || this.units.length === 0) {
        this.showNotification('لا توجد وحدات لحساب قيمها!', 'error');
        return;
    }

    let unitIndex = null;
    if (target && typeof target === 'object' && (target.floor !== undefined || target.number !== undefined)) {
        const f = ('' + (target.floor || '')).trim();
        const n = ('' + (target.number || '')).trim();
        unitIndex = this.units.findIndex(u => ('' + (u.floor || '')).trim() === f && ('' + (u.number || '')).trim() === n);
    }

    if ((unitIndex === -1 || unitIndex === null) && (this.editingUnitIndex !== null && this.editingUnitIndex !== undefined)) {
        unitIndex = this.editingUnitIndex;
    }
    // fallback to last updated unit if available (user saved the unit and the form was cleared)
    if ((unitIndex === -1 || unitIndex === null) && (this.lastUpdatedUnitIndex !== null && this.lastUpdatedUnitIndex !== undefined)) {
        unitIndex = this.lastUpdatedUnitIndex;
    }
    if (unitIndex === -1 || unitIndex === null) unitIndex = this.units.length - 1;

    const unit = this.units[unitIndex];
    if (!unit) {
        this.showNotification('لم يتم العثور على الوحدة المطلوبة', 'error');
        return;
    }

    const buildingMaterial = document.getElementById('building-material')?.value || 'concrete';

    if (method === 'ai') {
        if (!this.marketData || !this.marketData.properties || this.marketData.properties.length === 0) {
            unit.marketValue = unit.area * 8000;
        } else {
            const similarUnits = this.marketData.properties.filter(u =>
                u.area >= unit.area * 0.8 && u.area <= unit.area * 1.2
            );
            if (similarUnits.length > 0) {
                const avgPricePerMeter = similarUnits.reduce((s, u) => s + (u.price / u.area), 0) / similarUnits.length;
                let pricePerMeter = avgPricePerMeter;
                if (unit.finishing === 'high') pricePerMeter *= 1.2;
                else if (unit.finishing === 'luxury') pricePerMeter *= 1.5;
                else if (unit.finishing === 'basic') pricePerMeter *= 0.9;
                else if (unit.finishing === 'none') pricePerMeter *= 0.7;
                if (unit.unitType === 'villa') pricePerMeter *= 1.3;
                else if (unit.unitType === 'duplex') pricePerMeter *= 1.2;
                else if (unit.unitType === 'shop') pricePerMeter *= 1.1;
                unit.marketValue = pricePerMeter * unit.area;
            } else {
                unit.marketValue = unit.area * 8000;
            }
        }

        unit.rentalValue = unit.marketValue * 0.018;
        unit.netRentalValue = unit.useType === 'residential' ? unit.rentalValue * 0.7 : unit.rentalValue * 0.68;
        unit.tax = unit.useType === 'residential' ? unit.marketValue * 0.00126 : unit.marketValue * 0.001224;

        this.updateUnitsTable();
        this.calculateValuation();
        this.showNotification(`تم حساب القيم للوحدة (دور ${unit.floor} - رقم ${unit.number || (unitIndex+1)})`);
        return;
    }

    const baseValue = (typeof coefficients !== 'undefined' && coefficients.area) ? (coefficients.area * unit.area) : (unit.area * 1000);
    const useFactor = (typeof coefficients !== 'undefined' && coefficients.useType) ? (coefficients.useType[unit.useType] || 1.0) : 1.0;
    const typeFactor = (typeof coefficients !== 'undefined' && coefficients.unitType) ? (coefficients.unitType[unit.unitType] || 1.0) : 1.0;
    const finishingFactor = (typeof coefficients !== 'undefined' && coefficients.finishing) ? (coefficients.finishing[unit.finishing] || 1.0) : 1.0;
    const materialFactor = (typeof coefficients !== 'undefined' && coefficients.buildingMaterial) ? (coefficients.buildingMaterial[buildingMaterial] || 1.0) : 1.0;

    let similarityFactor = 1.0;
    if (this.similarityLevel === 'نفس الشارع') similarityFactor = 1.10;
    else if (this.similarityLevel === 'نفس المنطقة/القرية') similarityFactor = 1.05;
    else if (this.similarityLevel === 'نفس المدينة') similarityFactor = 1.02;

    const floorNumber = parseInt(unit.floor) || 0;
    let floorFactor;
    if (typeof getFloorFactor === 'function') {
        floorFactor = getFloorFactor(floorNumber || 1);
    } else {
        floorFactor = (coefficients.floor || 1.0) * (floorNumber > 0 ? floorNumber : 1);
    }
  const locationType = document.getElementById('location-type').value;
  const locationFactor = coefficients.locationType[locationType] || 1.0;
  
  let computedMarketValue = baseValue * useFactor * typeFactor * finishingFactor * similarityFactor * materialFactor * floorFactor * locationFactor;
let marketValue = computedMarketValue;

    try {
        if (method === 'manual') {
            const manualInput = document.getElementById('manual-market-value');
            if (manualInput) {
                const manualVal = parseFloat(manualInput.value);
                if (!isNaN(manualVal) && manualVal > 0) marketValue = manualVal;
            }
        }
    } catch (e) {}

    unit.marketValue = marketValue;
    unit.rentalValue = marketValue * 0.018;
    unit.netRentalValue = unit.useType === 'residential' ? unit.rentalValue * 0.7 : unit.rentalValue * 0.68;
    unit.tax = unit.useType === 'residential' ? marketValue * 0.00126 : marketValue * 0.001224;

    this.updateUnitsTable();
    this.calculateValuation();
    this.showNotification(`تم حساب القيم للوحدة (دور ${unit.floor} - رقم ${unit.number || (unitIndex+1)})`);
},// البحث عن وحدات مشابهة
findSimilarUnits: function(street, district, city, governorate) {
if (!this.marketData.properties || this.marketData.properties.length === 0) {
return [];
}
// تحديد مستوى التشابه
// 1. نفس الشارع أولاً
const streetUnits = this.marketData.properties.filter(unit =>
unit.governorate === governorate &&
unit.city === city &&
unit.district === district &&
unit.street === street
);
if (streetUnits.length > 0) {
this.similarityLevel = 'نفس الشارع';
return streetUnits.slice(0, 10);
}
// 2. نفس المنطقة/القرية
const villageUnits = this.marketData.properties.filter(unit =>
unit.governorate === governorate &&
unit.city === city &&
unit.district === district
);
if (villageUnits.length > 0) {
this.similarityLevel = 'نفس المنطقة/القرية';
return villageUnits.slice(0, 10);
}
// 3. نفس المدينة
const cityUnits = this.marketData.properties.filter(unit =>
unit.governorate === governorate &&
unit.city === city
);
if (cityUnits.length > 0) {
this.similarityLevel = 'نفس المدينة';
return cityUnits.slice(0, 10);
}
// 4. نفس المحافظة
const governorateUnits = this.marketData.properties.filter(unit =>
unit.governorate === governorate
);
this.similarityLevel = 'نفس المحافظة';
return governorateUnits.slice(0, 10);
},
// عرض الوحدات المشابهة
showSimilarUnits: function() {
const container = document.getElementById('similar-units-container');
container.innerHTML = '';
if (this.similarUnits.length === 0) {
container.innerHTML = `
<div class="empty-data">
<i class="fas fa-search"></i>
<h3>لا توجد وحدات مشابهة</h3>
<p>الرجاء إدخال بيانات العقار الجغرافية ثم الضغط على "احتساب القيم"</p>
</div>
`;
return;
}
// إضافة بطاقات الوحدات المشابهة
this.similarUnits.forEach(unit => {
const similarityClassMap = {
'street': 'similarity-street',
'village': 'similarity-village',
'city': 'similarity-city',
'governorate': 'similarity-governorate'
};
const similarityTextMap = {
'street': 'نفس الشارع',
'village': 'نفس القرية',
'city': 'نفس المدينة',
'governorate': 'نفس المحافظة'
};
const unitCard = document.createElement('div');
unitCard.className = 'unit-card';
unitCard.innerHTML = `
<span class="similarity-badge ${similarityClassMap[unit.similarity] || 'similarity-street'}">
${similarityTextMap[unit.similarity] || 'مشابه'}
</span>
<div class="unit-header">
<h3>${unit.unitType} - ${unit.area} م²</h3>
<div class="unit-price">${this.formatCurrency(unit.price)}</div>
</div>
<p><strong>الموقع:</strong> ${unit.governorate} - ${unit.city} - ${unit.district}</p>
<p><strong>الشارع:</strong> ${unit.street}</p>
<p><strong>سعر المتر:</strong> ${this.formatCurrency(unit.pricePerMeter)}</p>
<p><strong>سنة الإنشاء:</strong> ${unit.constructionYear}</p>
<p><strong>المصدر:</strong> ${unit.source}</p>
<div class="unit-stats">
<div class="stat-item">
<div class="stat-label">القيمة السوقية</div>
<div class="stat-value">${this.formatCurrency(unit.price)}</div>
</div>
<div class="stat-item">
<div class="stat-label">القيمة الإيجارية</div>
<div class="stat-value">${this.formatCurrency(unit.price * 0.018)}</div>
</div>
<div class="stat-item">
<div class="stat-label">صافي الإيجار</div>
<div class="stat-value">${unit.useType === 'residential' ? this.formatCurrency(unit.price * 0.018 * 0.7) : this.formatCurrency(unit.price * 0.018 * 0.68)}</div>
</div>
</div>
`;
container.appendChild(unitCard);
});
},
// ======== وظائف الاستمارات الرسمية ========
// تعبئة استمارة الحصر
fillOfficialForm1: function(property) {
if (!property) return; if (property._imported) return;
    const isImported = !!(property._imported || property.imported || property.source === 'import');
    const importedBadge = isImported
      ? '<span class="property-badge badge-imported">مستورد</span>'
      : '<span class="property-badge badge-saved">محفوظ</span>';
// تحديث عنوان الاستمارة
document.getElementById('form1-header').innerHTML = `
<td colspan="18" class="merged-cell">
محافظة: ${property.governorate || '--'}
مأمورية: ${property.city || '--'}
قرية: ${property.district || '--'}
</td>
`;
// تعبئة البيانات
const tbody = document.getElementById('form1-data');
tbody.innerHTML = '';
if (property.units && property.units.length > 0) {
property.units.forEach((unit, index) => {
const tr = document.createElement('tr');
// تعبئة البيانات المشتركة مرة واحدة فقط للوحدة الأولى
const commonData = index === 0 ? `
<td rowspan="${property.units.length}">${property.propertyNumber || '--'}</td>
<td rowspan="${property.units.length}">${property.street || '--'}</td>
<td rowspan="${property.units.length}">${property.streetWidth || '--'}</td>
<td rowspan="${property.units.length}">${property.owner || '--'}</td>
<td rowspan="${property.units.length}">${this.getBuildingMaterialName(property.buildingMaterial)}</td>
<td rowspan="${property.units.length}">${property.detailedDescription || '--'}</td>
<td rowspan="${property.units.length}">${property.constructionYear || '--'}</td>
` : '';
tr.innerHTML = commonData + `
<td>${this.getUseTypeName(unit.useType)}</td>
<td>${unit.floor || '--'}</td>
<td>${unit.number || index + 1}</td>
<td>${this.getUnitTypeName(unit.unitType)}</td>
<td>${unit.area || '--'} م²</td>
<td>${unit.occupant || '--'}</td>
<td>${unit.rentalValue ? this.formatCurrency(unit.rentalValue) : '--'}</td>
<td>${unit.tax ? this.formatCurrency(unit.tax) : '--'}</td>
<td>${property.district || '--'}</td>
`;
tbody.appendChild(tr);
});
} else {
const tr = document.createElement('tr');
tr.innerHTML = `
<td colspan="18" style="text-align: center; padding: 20px; color: var(--gray);">
<i class="fas fa-inbox"></i>
<h3>لا توجد وحدات مسجلة لهذا العقار</h3>
</td>
`;
tbody.appendChild(tr);
}
},
// تعبئة استمارة 32
fillOfficialForm2: function(property) {
if (!property) return; if (property._imported) return;
// تحديث عنوان الاستمارة
document.getElementById('form2-header').innerHTML = `
<td colspan="35" class="merged-cell">
محافظة: ${property.governorate || '--'}
مأمورية: ${property.city || '--'}
الناحية: ${property.district || '--'}
</td>
`;
// تعبئة البيانات
const tbody = document.getElementById('form2-data');
tbody.innerHTML = '';
if (property.units && property.units.length > 0) {
property.units.forEach((unit, index) => {
const tr = document.createElement('tr');
// تعبئة البيانات المشتركة مرة واحدة فقط للوحدة الأولى
const commonData = index === 0 ? `
<td rowspan="${property.units.length}">${new Date().toLocaleDateString('ar-EG')}</td>
<td rowspan="${property.units.length}">${property.owner || '--'}</td>
<td rowspan="${property.units.length}">${property.propertyNumber || '--'}</td>
<td rowspan="${property.units.length}">${property.previousPropertyNumber || '--'}</td>
<td rowspan="${property.units.length}">--</td>
<td rowspan="${property.units.length}">${property.street || '--'}</td>
<td rowspan="${property.units.length}">${property.detailedDescription || '--'}</td>
<td rowspan="${property.units.length}">${property.constructionYear || '--'}</td>
` : '';
tr.innerHTML = commonData + `
<td>${this.getUseTypeName(unit.useType)}</td>
<td>--</td>
<td>${unit.floor || '--'}</td>
<td>${unit.number || index + 1}</td>
<td>${this.getUnitTypeName(unit.unitType)}</td>
<td>${unit.area || '--'} م²</td>
<td>${unit.occupant || '--'}</td>
<td>${unit.rentalValue ? this.formatCurrency(unit.rentalValue) : '--'}</td>
<td>${unit.netRentalValue ? this.formatCurrency(unit.netRentalValue) : '--'}</td>
<td>${unit.tax ? this.formatCurrency(unit.tax) : '--'}</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
<td>--</td>
`;
tbody.appendChild(tr);
});
// إضافة صور العقار في خانة الملاحظات
if (property.images && property.images.length > 0) {
const imagesRow = document.createElement('tr');
imagesRow.innerHTML = `
<td colspan="35">
<div class="form-images-container">
<div class="form-images-title">
<i class="fas fa-images"></i> صور العقار
</div>
<div class="form-images-grid" id="form2-images">
<!-- سيتم ملؤها بالصور -->
</div>
</div>
</td>
`;
tbody.appendChild(imagesRow);
const imagesContainer = document.getElementById('form2-images');
property.images.forEach(img => {
const imgContainer = document.createElement('div');
imgContainer.className = 'form-image-item';
imgContainer.innerHTML = `<img src="${img}" alt="صورة العقار">`;
imagesContainer.appendChild(imgContainer);
});
}
} else {
const tr = document.createElement('tr');
tr.innerHTML = `
<td colspan="35" style="text-align: center; padding: 20px; color: var(--gray);">
<i class="fas fa-inbox"></i>
<h3>لا توجد وحدات مسجلة لهذا العقار</h3>
</td>
`;
tbody.appendChild(tr);
}
},
// البحث في الاستمارات
searchOfficialForms: function() {
const propertyNumber = document.getElementById('search-property-number').value.trim();
const street = document.getElementById('search-street').value.trim();
const district = document.getElementById('search-district').value.trim();
const formType = document.querySelector('.form-type-btn.active').dataset.formType;
const resultsContainer = document.getElementById('search-results-body');
resultsContainer.innerHTML = '';
// إظهار مؤشر التحميل
const searchBtn = document.getElementById('search-forms');
const originalHtml = searchBtn.innerHTML;
searchBtn.innerHTML = '<span class="search-loader"></span> جاري البحث...';
searchBtn.disabled = true;
// البحث في العقارات
const filteredProperties = this.properties.filter(property => {
// إذا كان هناك معايير بحث محددة
if (propertyNumber && property.propertyNumber && !property.propertyNumber.includes(propertyNumber)) {
return false;
}
if (street && property.street && !property.street.includes(street)) {
return false;
}
if (district && property.district && !property.district.includes(district)) {
return false;
}
return true;
});
setTimeout(() => {
// تحديث عدد النتائج
document.getElementById('results-count').textContent = `${filteredProperties.length} نتائج`;
if (filteredProperties.length === 0) {
resultsContainer.innerHTML = `
<div class="no-results">
<i class="fas fa-inbox"></i>
<h3>لا توجد نتائج</h3>
<p>لم يتم العثور على استمارات تطابق معايير البحث</p>
</div>
`;
} else {
// عرض النتائج في بطاقات
filteredProperties.forEach(property => {
const propertyCard = document.createElement('div');
propertyCard.className = 'property-card';
propertyCard.innerHTML = `
<h3>
<span class="property-id">${property.propertyNumber}</span>
${property.street ? property.street + '، ' : ''}
${property.district || ''}
</h3>
<div class="property-info">
<div class="info-item">
<span class="info-label">المالك:</span>
<span>${property.owner || '--'}</span>
</div>
<div class="info-item">
<span class="info-label">المحافظة:</span>
<span>${property.governorate || '--'}</span>
</div>
<div class="info-item">
<span class="info-label">المساحة:</span>
<span>${property.area || '--'} م²</span>
</div>
<div class="info-item">
<span class="info-label">عدد الوحدات:</span>
<span>${property.units ? property.units.length : 0}</span>
</div>
</div>
<div class="btn-group" style="margin-top:15px;">
<button class="btn btn-sm view-form" data-property-id="${property.id}" data-form-type="form1">
<i class="fas fa-eye"></i> استمارة الحصر
</button>
<button class="btn btn-sm view-form" data-property-id="${property.id}" data-form-type="form2">
<i class="fas fa-eye"></i> استمارة 32
</button>
</div>
`;
resultsContainer.appendChild(propertyCard);
});
// إضافة أحداث لعرض الاستمارات
document.querySelectorAll('.view-form').forEach(button => {
button.addEventListener('click', (e) => {
const propertyId = e.target.closest('.view-form').dataset.propertyId;
const formType = e.target.closest('.view-form').dataset.formType;
// البحث عن العقار
const property = this.properties.find(p => p.id == propertyId);
if (!property) return;
// عرض الاستمارة المطلوبة
if (formType === 'form1') {
// إظهار تبويب استمارة الحصر
document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
document.querySelector('.tab[data-target="form1"]').classList.add('active');
document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
document.getElementById('form1').classList.add('active');
// تعبئة الاستمارة
this.fillOfficialForm1(property);
} else {
// إظهار تبويب استمارة 32
document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
document.querySelector('.tab[data-target="form2"]').classList.add('active');
document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
document.getElementById('form2').classList.add('active');
// تعبئة الاستمارة
this.fillOfficialForm2(property);
}
this.showNotification(`تم تحميل ${formType === 'form1' ? 'استمارة الحصر' : 'استمارة 32'} للعقار ${property.propertyNumber}`);
});
});
}
// إعادة زر البحث إلى حالته الأصلية
searchBtn.innerHTML = originalHtml;
searchBtn.disabled = false;
// إخفاء القائمة المنسدلة
document.getElementById('forms-search-dropdown').classList.remove('active');
}, 1000);
},
// البحث في بيانات العقار
searchProperty: function() {
const propertyNumber = document.getElementById('property-search-number').value.trim();
const street = document.getElementById('property-search-street').value.trim();
const district = document.getElementById('property-search-district').value.trim();
// البحث في العقارات
const foundProperties = this.properties.filter(property => {
const matchesNumber = propertyNumber ? (property.propertyNumber || '').toLowerCase().includes(propertyNumber.toLowerCase()) : true;
const matchesStreet = street ? (property.street || '').toLowerCase().includes(street.toLowerCase()) : true;
const matchesDistrict = district ? (property.district || '').toLowerCase().includes(district.toLowerCase()) : true;
return matchesNumber && matchesStreet && matchesDistrict;
});
if (foundProperties.length > 0) {
this.showNotification(`تم العثور على ${foundProperties.length} عقارًا`);
} else {
this.showNotification('لم يتم العثور على عقار يطابق معايير البحث', 'error');
}
// إخفاء القائمة المنسدلة
document.getElementById('property-search-dropdown').classList.remove('active');
},
// مسح البحث في الاستمارات
resetSearch: function() {
document.getElementById('search-property-number').value = '';
document.getElementById('search-street').value = '';
document.getElementById('search-district').value = '';
const resultsContainer = document.getElementById('search-results-body');
resultsContainer.innerHTML = `
<div class="no-results">
<i class="fas fa-search"></i>
<h3>لم يتم إجراء بحث بعد</h3>
<p>استخدم أيقونة البحث للعثور على الاستمارات الرسمية</p>
</div>
`;
document.getElementById('results-count').textContent = '0 نتائج';
},
// مسح البحث في بيانات العقار
resetPropertySearch: function() {
document.getElementById('property-search-number').value = '';
document.getElementById('property-search-street').value = '';
document.getElementById('property-search-district').value = '';
},
// تهيئة أحداث البحث
initSearchEvents: function() {
// أحداث أزرار تصفية نوع الاستمارة
document.querySelectorAll('.form-type-btn').forEach(button => {
button.addEventListener('click', function() {
document.querySelectorAll('.form-type-btn').forEach(btn => btn.classList.remove('active'));
this.classList.add('active');
});
});
// البحث عند الضغط على Enter
document.querySelectorAll('.search-dropdown input').forEach(input => {
input.addEventListener('keypress', function(e) {
if (e.key === 'Enter') {
if (e.target.closest('#forms-search-dropdown')) {
RealEstateApp.searchOfficialForms();
} else {
RealEstateApp.searchProperty();
}
}
});
});
},
// الحصول على اسم مادة البناء
getBuildingMaterialName: function(value) {
const materials = {
'brick': 'طوب أحمر',
'sand_brick': 'طوب رملي',
'concrete': 'خرسانة مسلحة',
'stone': 'حجر',
'mud_brick': 'طوب لبن',
'other': 'أخرى'
};
return materials[value] || value;
},
// الحصول على اسم نوع الاستغلال
getUseTypeName: function(value) {
const types = {
'residential': 'سكني',
'commercial': 'تجاري',
'administrative': 'إداري',
'space': 'فضاء',
'utilized_space': 'فضاء مستغل'
};
return types[value] || value;
},
// الحصول على اسم نوع الوحدة
getUnitTypeName: function(value) {
const types = {
'apartment': 'شقة',
'duplex': 'دوبلكس',
'villa': 'فيلا',
'shop': 'محل',
'warehouse': 'مخزن',
'workshop': 'ورشة',
'clinic': 'عيادة',
'office': 'مكتب',
'space': 'فضاء',
'utilized_space': 'فضاء مستغل'
};
return types[value] || value;
},
// ======== وظائف قرار الإضافة ========
// تعبئة جدول قرار الإضافة
fillAdditionTable: function() {
    const tbody = document.getElementById('addition-table-body');
    tbody.innerHTML = '';
    let totalRental = 0;
    let totalTax = 0;
    let totalExempt = 0;
    let totalPayable = 0;
    // التكرار على العقارات المحفوظة فقط (غير المستوردة)
    this.properties.forEach(property => {
        if (property._imported || property.imported || property.source === 'import') return;
// لا نستثني العقارات المستوردة هنا لأننا نريد عرضها في النافذة
if (property.units && property.units.length > 0) {
property.units.forEach((unit, index) => {
const rentalValue = unit.rentalValue || 0;
const tax = unit.tax || 0;
// حساب معفي ق117 والمقتضى إضافته
let exemptValue = 0;
let payableValue = tax;
// خصم 120 جنيهاً فقط للوحدات غير السكنية
if (unit.useType !== 'residential') {
exemptValue = 120;
payableValue = Math.max(tax - exemptValue, 0);
}
totalRental += rentalValue;
totalTax += tax;
totalExempt += exemptValue;
totalPayable += payableValue;
const tr = document.createElement('tr');
tr.innerHTML = `
<td>${property.propertyNumber}</td>
<td>${property.street || '--'}</td>
<td>${property.district || '--'}</td>
<td>${property.city || '--'}</td>
<td>${property.owner || '--'}</td>
<td>${unit.number || index + 1}</td> <!-- رقم الوحدة -->
<td>${unit.floor || '--'}</td>
<td>${unit.activity || '--'}</td>
<td>${this.formatCurrency(rentalValue)}</td>
<td>${this.formatCurrency(tax)}</td>
<!-- إضافة العمودين الجديدين هنا -->
<td>${this.formatCurrency(exemptValue)}</td>
<td>${this.formatCurrency(payableValue)}</td>
`;
tbody.appendChild(tr);
});
}
});
// تحديث الإجمالي
document.getElementById('total-rental').textContent = this.formatCurrency(totalRental);
document.getElementById('total-tax').textContent = this.formatCurrency(totalTax);
document.getElementById('total-exempt').textContent = this.formatCurrency(totalExempt);
document.getElementById('total-payable').textContent = this.formatCurrency(totalPayable);
// إذا لم تكن هناك بيانات
if (tbody.children.length === 0) {
tbody.innerHTML = `
<tr>
<td colspan="12" style="text-align: center; padding: 30px; color: var(--gray);">
<i class="fas fa-inbox"></i>
<h3>لا توجد عقارات مسجلة</h3>
<p>قم بإضافة عقارات أولاً لعرضها في قرار الإضافة</p>
</td>
</tr>
`;
}
},
// طباعة قرار الإضافة
printDecision: function() {
window.print();
},
// ======== وظائف الخريطة ========
// تحديث الخريطة
updateMap: function() {
const mapContainer = document.getElementById('map');
mapContainer.innerHTML = '';
if (this.properties.length === 0) {
mapContainer.innerHTML = `
<div class="empty-data" style="height: 500px; display: flex; flex-direction: column; justify-content: center;">
<i class="fas fa-map-marked-alt"></i>
<h3>لا توجد عقارات مسجلة</h3>
<p>قم بإضافة عقارات لعرضها على الخريطة</p>
</div>
`;
return;
}
// إنشاء الخريطة
mapContainer.innerHTML = '<div id="map-canvas" style="height: 100%;"></div>';
this.map = L.map('map-canvas').setView([30.0444, 31.2357], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(this.map);
// إضافة العلامات
    this.properties.forEach(property => {
      // لا نستثني العقارات المستوردة هنا لأننا نريد عرضها في النافذة
if (property.coordinates) {
const [lat, lng] = property.coordinates.split(',').map(coord => parseFloat(coord.trim()));
if (!isNaN(lat) && !isNaN(lng)) {
// تحديد لون العلامة بناءً على وجود الصور
const iconColor = property.images && property.images.length > 0 ? 'green' : 'blue';
const marker = L.marker([lat, lng], {
icon: L.divIcon({
className: 'custom-icon',
html: `<div style="background-color: ${iconColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
iconSize: [20, 20]
})
}).addTo(this.map);
// إنشاء محتوى البوب أب
let popupContent = `
<div class="map-popup-content">
<h3>عقار ${property.propertyNumber}</h3>
<p><strong>الموقع:</strong> ${property.governorate} - ${property.city} - ${property.district}</p>
<p><strong>الشارع:</strong> ${property.street} (عرض: ${property.streetWidth || '--'} متر)</p>
<p><strong>المالك:</strong> ${property.owner}</p>
<p><strong>سنة الإنشاء:</strong> ${property.constructionYear || 'غير معروف'}</p>
<p><strong>عدد الوحدات:</strong> ${property.units?.length || 0}</p>
<hr style="margin: 10px 0; border-top: 1px solid #eee;">
<h4>الوحدات:</h4>
`;
if (property.units && property.units.length > 0) {
property.units.forEach((unit, index) => {
popupContent += `
<div class="unit-item">
<p><strong>الوحدة ${index + 1}:</strong> ${this.getUnitTypeName(unit.unitType)} - الدور ${unit.floor}</p>
<p><strong>المساحة:</strong> ${unit.area} م² - <strong>القيمة السوقية:</strong> ${unit.marketValue ? this.formatCurrency(unit.marketValue) : '--'}</p>
<p><strong>النشاط:</strong> ${unit.activity || '--'}</p>
</div>
`;
});
} else {
popupContent += '<p>لا توجد وحدات مسجلة</p>';
}
popupContent += `</div>`;
marker.bindPopup(popupContent);
}
}
});
},
// الحصول على الإحداثيات عبر GPS
getGPSLocation: function() {
const loader = document.getElementById('gps-loader');
const icon = document.getElementById('get-gps').querySelector('i');
const statusEl = document.getElementById('gps-status');
// إظهار مؤشر التحميل وإخفاء الأيقونة
loader.style.display = 'inline-block';
icon.style.display = 'none';
statusEl.textContent = 'جاري الحصول على الموقع...';
statusEl.className = 'gps-status';
if (navigator.geolocation) {
navigator.geolocation.getCurrentPosition(
(position) => {
const lat = position.coords.latitude;
const lng = position.coords.longitude;
document.getElementById('coordinates').value = `${lat}, ${lng}`;
// إخفاء مؤشر التحميل وإظهار الأيقونة
loader.style.display = 'none';
icon.style.display = 'inline-block';
statusEl.textContent = 'تم الحصول على الإحداثيات بنجاح!';
statusEl.className = 'gps-status success';
this.showNotification('تم الحصول على الإحداثيات بنجاح');
},
(error) => {
// إخفاء مؤشر التحميل وإظهار الأيقونة
loader.style.display = 'none';
icon.style.display = 'inline-block';
let errorMessage = 'فشل في الحصول على الموقع: ';
switch(error.code) {
case error.PERMISSION_DENIED:
errorMessage = 'تم رفض الإذن. يرجى تمكين الموقع في إعدادات المتصفح.';
break;
case error.POSITION_UNAVAILABLE:
errorMessage = 'الموقع غير متاح حاليًا.';
break;
case error.TIMEOUT:
errorMessage = 'انتهت مهلة طلب الموقع.';
break;
default:
errorMessage = 'خطأ غير معروف أثناء محاولة الحصول على الموقع.';
}
statusEl.textContent = errorMessage;
statusEl.className = 'gps-status error';
this.showNotification(errorMessage, 'error');
},
{
timeout: 10000,
maximumAge: 0,
enableHighAccuracy: true
}
);
} else {
// إخفاء مؤشر التحميل وإظهار الأيقونة
loader.style.display = 'none';
icon.style.display = 'inline-block';
statusEl.textContent = 'المتصفح لا يدعم خدمة الموقع.';
statusEl.className = 'gps-status error';
this.showNotification('المتصفح لا يدعم خدمة الموقع', 'error');
}
},
// ======== وظائف التصدير والاستيراد ========
// تصدير نسخة احتياطية كاملة
exportBackupAll: function() {
if (this.properties.length === 0) {
this.showNotification('لا توجد بيانات للتصدير!', 'error');
return;
}
// إظهار مؤشر التحميل
document.getElementById('loading-overlay').style.display = 'flex';
// تأخير عملية التصدير لضمان عرض مؤشر التحميل
setTimeout(() => {
try {
const workbook = XLSX.utils.book_new();
// إعداد بيانات العقارات للتصدير
const propertiesData = this.properties.map(property => ({
'الرقم العقاري': property.propertyNumber,
// إضافة التعديل: تضمين رقم العقار السابق
'رقم العقار السابق': property.previousPropertyNumber || '',
'الشارع': property.street,
'عرض الشارع': property.streetWidth,
'الحى / القرية': property.district,
'المركز / المدينة': property.city,
'المحافظة': property.governorate,
'سنة الإنشاء': property.constructionYear,
'مادة البناء': this.getBuildingMaterialName(property.buildingMaterial),
'اسم المكلف': property.responsibleName,
'اسم المالك': property.owner,
// إضافة التعديل: تضمين الرقم القومي للمالك
'الرقم القومي للمالك': property.ownerNationalId || '',
'المساحة (م²)': property.area,
'عدد الأدوار': property.floors,
'عدد الوحدات': property.unitsCount,
'نوع العقار': property.propertyType,
'الإحداثيات': property.coordinates,
'الوصف التفصيلي للعقار': property.detailedDescription,
'عدد الصور': property.images ? property.images.length : 0
}));
// إضافة ورقة العقارات
const propertiesWs = XLSX.utils.json_to_sheet(propertiesData);
XLSX.utils.book_append_sheet(workbook, propertiesWs, 'الخصائص');
// إعداد بيانات الوحدات للتصدير
const unitsData = [];
    this.properties.forEach(property => {
      // لا نستثني العقارات المستوردة هنا لأننا نريد عرضها في النافذة
property.units.forEach(unit => {
unitsData.push({
'الرقم العقاري': property.propertyNumber,
'الشارع': property.street,
      'الحى / القرية': property.district,
      'الدور': unit.floor,
'رقم الوحدة': unit.number || '', // رقم الوحدة
'اسم المالك': unit.owner,
// إضافة التعديل: تضمين الرقم القومي للمالك للوحدة
'الرقم القومي للمالك': unit.ownerNationalId || '',
'المساحة (م²)': unit.area,
'نوع الوحدة': this.getUnitTypeName(unit.unitType),
'نوع الاستغلال': this.getUseTypeName(unit.useType),
'النشاط': unit.activity || '',
'حالة الوحدة': unit.status === 'complete' ? 'تامة' : unit.status === 'incomplete' ? 'غير تامة' : 'مشغولة',
'القيمة السوقية': unit.marketValue || 0,
'القيمة الإيجارية': unit.rentalValue || 0,
'صافي الإيجار': unit.netRentalValue || 0,
'الضريبة': unit.tax || 0
});
});
});
// إضافة ورقة الوحدات
const unitsWs = XLSX.utils.json_to_sheet(unitsData);
XLSX.utils.book_append_sheet(workbook, unitsWs, 'الوحدات');
// حفظ الملف
XLSX.writeFile(workbook, this.ensureFileExtension("backup_real_estate_data", "xlsx"));
this.showNotification('تم تصدير النسخة الاحتياطية بنجاح!');
} catch (error) {
console.error('Error exporting backup:', error);
this.showNotification('حدث خطأ أثناء التصدير', 'error');
} finally {
// إخفاء مؤشر التحميل
document.getElementById('loading-overlay').style.display = 'none';
}
}, 500);
},
// تصدير بيانات العقار إلى Excel
exportPropertyExcel: function() {
if (!this.currentProperty) {
this.showNotification('لا يوجد عقار محدد للتصدير', 'error');
return;
}
const propertyData = [{
'الرقم العقاري': this.currentProperty.propertyNumber,
// إضافة التعديل: تضمين رقم العقار السابق
'رقم العقار السابق': this.currentProperty.previousPropertyNumber || '',
'الشارع': this.currentProperty.street,
'عرض الشارع': this.currentProperty.streetWidth,
'الحى / القرية': this.currentProperty.district,
'المركز / المدينة': this.currentProperty.city,
'المحافظة': this.currentProperty.governorate,
'سنة الإنشاء': this.currentProperty.constructionYear,
'مادة البناء': this.getBuildingMaterialName(this.currentProperty.buildingMaterial),
'اسم المكلف': this.currentProperty.responsibleName,
'اسم المالك': this.currentProperty.owner,
// إضافة التعديل: تضمين الرقم القومي للمالك
'الرقم القومي للمالك': this.currentProperty.ownerNationalId || '',
'المساحة (م²)': this.currentProperty.area,
'عدد الأدوار': this.currentProperty.floors,
'عدد الوحدات': this.currentProperty.unitsCount,
'نوع العقار': this.currentProperty.propertyType,
'الإحداثيات': this.currentProperty.coordinates,
'الوصف التفصيلي للعقار': this.currentProperty.detailedDescription
}];
const ws = XLSX.utils.json_to_sheet(propertyData);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'بيانات العقار');
XLSX.writeFile(wb, this.ensureFileExtension('بيانات_العقار', 'xlsx'));
},
// تصدير الوحدات إلى Excel
exportUnitsExcel: function() {
if (this.units.length === 0) {
this.showNotification('لا توجد وحدات لتصديرها', 'error');
return;
}
const data = this.units.map(unit => ({
'الشارع': property.street,
      'الحى / القرية': property.district,
      'الدور': unit.floor,
'رقم الوحدة': unit.number || '', // رقم الوحدة
'اسم المالك': unit.owner,
// إضافة التعديل: تضمين الرقم القومي للمالك للوحدة
'الرقم القومي للمالك': unit.ownerNationalId || '',
'المساحة (م²)': unit.area,
'نوع الوحدة': this.getUnitTypeName(unit.unitType),
'نوع الاستغلال': this.getUseTypeName(unit.useType),
'النشاط': unit.activity || '',
'حالة الوحدة': unit.status === 'complete' ? 'تامة' : unit.status === 'incomplete' ? 'غير تامة' : 'مشغولة',
'القيمة السوقية': unit.marketValue || 0,
'القيمة الإيجارية': unit.rentalValue || 0,
'صافي الإيجار': unit.netRentalValue || 0,
'الضريبة': unit.tax || 0
}));
const ws = XLSX.utils.json_to_sheet(data);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'وحدات العقار');
XLSX.writeFile(wb, this.ensureFileExtension('وحدات_العقار', 'xlsx'));
},
// تصدير التقييم إلى Excel
exportValuationExcel: function() {
if (this.units.length === 0) {
this.showNotification('لا توجد وحدات لتصدير تقييمها', 'error');
return;
}
// بيانات التقييم الأساسية
const totalMarketValue = this.units.reduce((sum, unit) => sum + (unit.marketValue || 0), 0);
const totalRentalValue = this.units.reduce((sum, unit) => sum + (unit.rentalValue || 0), 0);
const totalTax = this.units.reduce((sum, unit) => sum + (unit.tax || 0), 0);
const totalArea = this.units.reduce((sum, unit) => sum + (parseFloat(unit.area) || 0), 0);
const avgPricePerMeter = totalArea > 0 ? totalMarketValue / totalArea : 0;
const valuationData = [{
'القيمة السوقية': this.formatCurrency(totalMarketValue),
'متوسط سعر المتر': this.formatCurrency(avgPricePerMeter),
'القيمة الإيجارية': this.formatCurrency(totalRentalValue),
'صافي الإيجار': this.units.reduce((sum, unit) => sum + (unit.netRentalValue || 0), 0),
'الضريبة العقارية': this.formatCurrency(totalTax),
'مستوى التشابه': this.similarityLevel
}];
// بيانات الوحدات المشابهة
const similarUnitsData = this.similarUnits.map(unit => ({
'المصدر': unit.source,
'الشارع': unit.street,
'المنطقة': unit.district,
'المدينة': unit.city,
'المحافظة': unit.governorate,
'نوع الوحدة': unit.unitType,
'الممساحة': unit.area,
'سعر المتر': unit.pricePerMeter,
'السعر الإجمالي': unit.price,
'سنة الإنشاء': unit.constructionYear,
'الوصف التفصيلي للعقار': unit.description
}));
const wb = XLSX.utils.book_new();
// ورقة بيانات التقييم
const valuationWs = XLSX.utils.json_to_sheet(valuationData);
XLSX.utils.book_append_sheet(wb, valuationWs, 'التقييم');
// ورقة الوحدات المشابهة
const similarWs = XLSX.utils.json_to_sheet(similarUnitsData);
XLSX.utils.book_append_sheet(wb, similarWs, 'وحدات مشابهة');
XLSX.writeFile(wb, this.ensureFileExtension('تقرير_التقييم', 'xlsx'));
},
// تصدير قرار الإضافة إلى Excel
exportAdditionExcel: function() {
const table = document.querySelector("#addition-section .addition-table table");
if (!table) {
this.showNotification('لم يتم العثور على جدول البيانات', 'error');
return;
}
const workbook = XLSX.utils.table_to_book(table, { sheet: "قرار الإضافة" });
XLSX.writeFile(workbook, this.ensureFileExtension("قرار_الإضافة", "xlsx"));
},
// تصدير الخريطة كصورة
exportMapImage: function() {
const mapCanvas = document.getElementById('map');
html2canvas(mapCanvas).then(canvas => {
const link = document.createElement('a');
link.download = this.ensureFileExtension('الخريطة_العقارية', 'png');
link.href = canvas.toDataURL('image/png');
link.click();
});
},
// استيراد بيانات السوق
importMarketData: function() {
const input = document.createElement('input');
input.type = 'file';
input.accept = '.xlsx, .xls';
input.onchange = e => {
const file = e.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = function(e) {
try {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, {type: 'array'});
// استخراج البيانات من الورقة الأولى
const firstSheetName = workbook.SheetNames[0];
const worksheet = workbook.Sheets[firstSheetName];
// تحويل البيانات إلى JSON
const jsonData = XLSX.utils.sheet_to_json(worksheet);
// معالجة البيانات المستوردة
const processedData = jsonData.map(item => ({
id: item.id || Math.random().toString(36).substr(2, 9),
governorate: item.المحافظة || item.governorate || "--",
city: item.المدينة || item.city || "--",
district: item.المنطقة || item.district || "--",
street: item.الشارع || item.street || "--",
constructionYear: item.سنة_الإنشاء || item.year || 2000,
area: item.المساحة || item.area || 0,
unitType: item.نوع_الوحدة || item.type || "شقة",
price: item.السعر || item.price || 0,
pricePerMeter: item.سعر_المتر || item.pricePerMeter || 0,
description: item.الوصف || item.description || "",
similarity: item.التشابه || "governorate",
source: "ملف مستورد"
}));
// تحديث بيانات السوق
this.marketData = {
lastUpdated: new Date().toISOString(),
properties: processedData,
source: file.name
};
localStorage.setItem('realEstateMarketData', JSON.stringify(this.marketData));
// تحديث الواجهة
const updateDate = new Date(this.marketData.lastUpdated).toLocaleDateString('ar-EG');
document.getElementById('market-update-date').textContent = updateDate;
document.getElementById('market-data-source').textContent = this.marketData.source;
document.getElementById('market-ads-count').textContent = this.marketData.properties.length;
// عرض معاينة للبيانات المستوردة
const preview = document.getElementById('market-data-preview');
preview.innerHTML = `
<div class="market-preview">
<h4>معاينة البيانات المستوردة (5 وحدات)</h4>
<table>
<thead>
<tr>
<th>المحافظة</th>
<th>المدينة</th>
<th>المنطقة</th>
<th>الشارع</th>
<th>المساحة</th>
<th>السعر</th>
</tr>
</thead>
<tbody>
${this.marketData.properties.slice(0, 5).map(item => `
<tr>
<td>${item.governorate}</td>
<td>${item.city}</td>
<td>${item.district}</td>
<td>${item.street}</td>
<td>${item.area} م²</td>
<td>${this.formatCurrency(item.price)}</td>
</tr>
`).join('')}
</tbody>
</table>
</div>
`;
this.showNotification('تم استيراد بيانات السوق بنجاح من الملف!');
} catch (error) {
console.error('Error processing Excel file:', error);
this.showNotification('حدث خطأ أثناء معالجة ملف Excel', 'error');
}
}.bind(this);
reader.readAsArrayBuffer(file);
};
input.click();
},
// استيراد العقارات
importProperties: function(mode = 'merge') {
const input = document.createElement('input');
input.type = 'file';
input.accept = '.xlsx, .xls';
input.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });

      // try to detect sheets: properties sheet and units sheet
      const sheetNames = workbook.SheetNames || [];
      const propSheetName = sheetNames.find(n => /الخصائص|بيانات|properties|properties/i.test(n)) || sheetNames[0];
      const unitsSheetName = sheetNames.find(n => /وحدات|units/i.test(n)) || null;

      // read properties sheet (expect headers in first row)
      const propsSheet = workbook.Sheets[propSheetName];
      const propsJson = XLSX.utils.sheet_to_json(propsSheet);

      // normalize and prepare importedProperties
      this.importedProperties = (propsJson || []).map((item, idx) => ({
        id: item['id'] || item.id || Date.now() + idx,
        propertyNumber: item['الرقم العقاري'] || item.propertyNumber || item['رقم العقار'] || '',
        previousPropertyNumber: item['رقم العقار السابق'] || item.previousPropertyNumber || '',
        street: item['الشارع'] || item.street || '',
        streetWidth: item['عرض الشارع'] || item.streetWidth || '',
        district: item['الحى / القرية'] || item['الحى/القرية'] || item['المنطقة'] || item.district || '',
        city: item['المركز / المدينة'] || item.city || '',
        governorate: item['المحافظة'] || item.governorate || '',
        constructionYear: item['سنة الإنشاء'] || item.constructionYear || '',
        buildingMaterial: item['مادة البناء'] || item.buildingMaterial || 'concrete',
        responsibleName: item['اسم المكلف'] || item.responsibleName || '',
        owner: item['اسم المالك'] || item.owner || '',
        ownerNationalId: item['الرقم القومي للمالك'] || item.ownerNationalId || '',
        area: parseFloat(item['المساحة (م²)'] || item['المساحة'] || item.area || 0) || 0,
        floors: parseInt(item['عدد الأدوار'] || item.floors || 0) || 0,
        unitsCount: parseInt(item['عدد الوحدات'] || item.unitsCount || 0) || 0,
        propertyType: item['نوع العقار'] || item.propertyType || 'residential',
        coordinates: item['الإحداثيات'] || item.coordinates || '',
        detailedDescription: item['الوصف التفصيلي للعقار'] || item['الوصف'] || item.detailedDescription || '',
        images: [],
        units: []
      }));
      this.importedProperties.forEach(p => p._imported = true);

      // if a units sheet exists, parse it and attach units to their parent properties
      if (unitsSheetName) {
        const unitsSheet = workbook.Sheets[unitsSheetName];
        const unitsJson = XLSX.utils.sheet_to_json(unitsSheet) || [];
        unitsJson.forEach(u => {
          const unitObj = {
            floor: (u['الدور'] || u.floor || '0').toString(),
            number: u['رقم الوحدة'] || u.number || u['رقم'] || '',
            owner: u['اسم المالك'] || u.owner || '',
            ownerNationalId: u['الرقم القومي للمالك'] || u.ownerNationalId || '',
            area: parseFloat(u['المساحة (م²)'] || u['المساحة'] || u.area || 0) || 0,
            unitType: u['نوع الوحدة'] || u.unitType || '',
            useType: u['نوع الاستغلال'] || u.useType || '',
            activity: u['النشاط'] || u.activity || '',
            status: u['حالة الوحدة'] || u.status || '',
            marketValue: parseFloat(u['القيمة السوقية'] || u.marketValue || 0) || 0,
            rentalValue: parseFloat(u['القيمة الإيجارية'] || u.rentalValue || 0) || 0,
            netRentalValue: parseFloat(u['صافي الإيجار'] || u.netRentalValue || 0) || 0,
            tax: parseFloat(u['الضريبة'] || u.tax || 0) || 0,
            // sometimes units include reference to parent property
            propertyNumber: u['الرقم العقاري'] || u.propertyNumber || ''
          };
          // try to find parent property by propertyNumber first
          let parent = this.importedProperties.find(p => p.propertyNumber && p.propertyNumber.toString() === (unitObj.propertyNumber || '').toString());
          if (!parent) {
            // fallback: match by street + district if possible
            parent = this.importedProperties.find(p => (p.street && p.street === (u['الشارع'] || u.street || '')) && (p.district && p.district === (u['الحى / القرية'] || u['المنطقة'] || u.district || '')));
          }
          if (parent) {
            parent.units = parent.units || [];
            parent.units.push(unitObj);
          } else {
            // if no parent match, attach to the first imported property as fallback (if any)
            if (this.importedProperties.length > 0) {
              this.importedProperties[0].units = this.importedProperties[0].units || [];
              this.importedProperties[0].units.push(unitObj);
            }
          }
        });
      }

      // merge/replace/add behavior
      let addedCount = 0, updatedCount = 0, duplicateCount = 0;
      if (mode === 'replace') {
        this.properties = JSON.parse(JSON.stringify(this.importedProperties));
      } else if (mode === 'add') {
        this.importedProperties.forEach(importedProp => {
          const exists = this.properties.find(p => p.propertyNumber === importedProp.propertyNumber && p.street === importedProp.street && p.district === importedProp.district);
          if (!exists) {
            this.properties.push(JSON.parse(JSON.stringify(importedProp)));
            addedCount++;
          } else {
            duplicateCount++;
          }
        });
      } else { // merge
        this.importedProperties.forEach(importedProp => {
          const existingIndex = this.properties.findIndex(p => p.propertyNumber === importedProp.propertyNumber && p.street === importedProp.street && p.district === importedProp.district);
          if (existingIndex !== -1) {
            // keep existing units (do not overwrite unless explicit)
            const existingUnits = this.properties[existingIndex].units || [];
            this.properties[existingIndex] = Object.assign({}, JSON.parse(JSON.stringify(importedProp)), { id: this.properties[existingIndex].id, units: existingUnits });
            updatedCount++;
          } else {
            this.properties.push(JSON.parse(JSON.stringify(importedProp)));
            addedCount++;
          }
        });
      }

      // persist and update UI
      localStorage.setItem('realEstateProperties', JSON.stringify(this.properties));
      try {
        document.getElementById('imported-count').textContent = this.importedProperties.length;
        if (document.getElementById('added-count')) document.getElementById('added-count').textContent = addedCount;
        if (document.getElementById('updated-count')) document.getElementById('updated-count').textContent = updatedCount;
        if (document.getElementById('duplicate-count')) document.getElementById('duplicate-count').textContent = duplicateCount;
        if (document.getElementById('merge-status')) document.getElementById('merge-status').classList.add('visible');
      } catch (e) {}
      this.updateMap();
      this.fillAdditionTable();
      this.showNotification('تم استيراد بيانات العقارات بنجاح');
    } catch (error) {
      console.error('Error importing properties:', error);
      this.showNotification('حدث خطأ أثناء استيراد الملف', 'error');
    }
  }.bind(this);
  reader.readAsArrayBuffer(file);
};
input.click();
},confirmMerge: function() {
// حفظ في localStorage
localStorage.setItem('realEstateProperties', JSON.stringify(this.properties));
// تحديث واجهة المستخدم
this.updateMap();
this.fillAdditionTable(); // تحديث جدول قرار الإضافة
// إخفاء قسم النتائج
document.getElementById('merge-status').classList.remove('visible');
this.showNotification('تم دمج العقارات المستوردة مع البيانات الحالية بنجاح');
},
// إلغاء عملية الدمج
cancelMerge: function() {
// إعادة تحميل البيانات الأصلية
this.loadData();
// إخفاء قسم النتائج
document.getElementById('merge-status').classList.remove('visible');
this.showNotification('تم إلغاء عملية الدمج');
},
// ======== وظائف الطباعة والتصدير للاستمارات الرسمية ========
// طباعة استمارة الحصر
printForm1: function() {
// حفظ حالة التبويبات الحالية
const activeTab = document.querySelector('.tab.active');
const activeContent = document.querySelector('.tab-content.active');
// تفعيل استمارة الحصر
document.querySelector('.tab[data-target="form1"]').classList.add('active');
document.getElementById('form1').classList.add('active');
// الطباعة
window.print();
// استعادة الحالة السابقة للتبويبات
if (activeTab) activeTab.classList.add('active');
if (activeContent) activeContent.classList.add('active');
},
// طباعة استمارة 32
printForm2: function() {
// حفظ حالة التبويبات الحالية
const activeTab = document.querySelector('.tab.active');
const activeContent = document.querySelector('.tab-content.active');
// تفعيل استمارة 32
document.querySelector('.tab[data-target="form2"]').classList.add('active');
document.getElementById('form2').classList.add('active');
// الطباعة
window.print();
// استعادة الحالة السابقة للتبويبات
if (activeTab) activeTab.classList.add('active');
if (activeContent) activeContent.classList.add('active');
},
// ======== وظائف مساعدة ========
// عرض الإشعارات
showNotification: function(message, type = 'success') {
const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.innerHTML = `
<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
${message}
`;
document.body.appendChild(notification);
setTimeout(() => {
notification.remove();
}, 3000);
},
// ضمان إضافة امتداد الملف
ensureFileExtension: function(filename, ext) {
if (!filename.toLowerCase().endsWith(`.${ext.toLowerCase()}`)) {
return `${filename}.${ext}`;
}
return filename;
},
// تنسيق العملة
formatCurrency: function(amount) {
return amount.toLocaleString('ar-EG', {
style: 'currency',
currency: 'EGP',
minimumFractionDigits: 0,
maximumFractionDigits: 0
});
},
// تعيين تقييم للوحدة
setUnitRating: function(rating) {
document.querySelectorAll('.unit-rating .star').forEach((star, index) => {
if (index < rating) {
star.classList.add('active');
} else {
star.classList.remove('active');
}
});
},
// تصفية الوحدات حسب النوع
filterUnits: function(filter) {
const rows = document.querySelectorAll('#units-table-body tr');
rows.forEach(row => {
if (row.classList.contains('empty-data-row')) return;
const typeCell = row.cells[6]; // النوع في العمود السابع
const typeText = typeCell.textContent.toLowerCase();
if (filter === 'all' ||
(filter === 'residential' && typeText.includes('سكني')) ||
(filter === 'commercial' && typeText.includes('تجاري')) ||
(filter === 'space' && typeText.includes('فضاء'))) {
row.style.display = '';
} else {
row.style.display = 'none';
}
});
}
};
// تهيئة التطبيق عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
  // تعيين قيمة افتراضية لطبيعة المكان
  document.getElementById('location-type').value = 'village';
  RealEstateApp.init();
});
// === إدارة العقارات المحفوظة ===
document.getElementById('show-saved-properties').addEventListener('click', function() {
    const modal = document.getElementById('saved-properties-modal');
    const tableBody = document.getElementById('saved-properties-table');
    
    // مسح الجدول الحالي
    tableBody.innerHTML = '';
    
    // ملء الجدول بالعقارات المحفوظة والمستوردة
    if (RealEstateApp.properties.length === 0) {
        tableBody.innerHTML = `
        <tr>
            <td colspan="8" style="text-align:center; padding:20px;">
                <i class="fas fa-inbox"></i> لا توجد عقارات محفوظة
            </td>
        </tr>
        `;
    } else {
        RealEstateApp.properties.forEach(property => {
            const tr = document.createElement('tr');
            tr.dataset.propertyId = property.id;
            tr.style.cursor = 'pointer';
            
            const date = new Date(property.id);
            const formattedDate = date.toLocaleDateString('ar-EG');
            const isImported = !!(property._imported || property.imported || property.source === 'import');
            
            tr.innerHTML = `
                <td>${property.propertyNumber || '--'}</td>
                <td>${property.street || '--'}</td>
                <td>${property.district || '--'}</td>
                <td>${property.city || '--'}</td>
                <td>${property.governorate || '--'}</td>
                <td>${formattedDate}</td>
                <td>
                    ${isImported ? '<span class="property-badge badge-imported">مستورد</span>' : '<span class="property-badge badge-saved">محفوظ</span>'}
                </td>
                <td>
                    ${isImported ? 
                      `<button class="btn btn-sm" style="background-color: #27ae60; color: white;" data-property-id="${property.id}">
                          <i class="fas fa-save"></i> حفظ
                       </button>` : ''}
                    <button class="btn btn-sm delete-property-row" data-property-id="${property.id}">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </td>
`;
            
            tableBody.appendChild(tr);
            
            // حدث النقر على الصف لتحميل العقار
            tr.addEventListener('click', function(e) {
                if (!e.target.closest('.delete-property-row')) {
                    RealEstateApp.loadPropertyData(property.id);
                    modal.style.display = 'none';
                }
            });
            // أحداث الأزرار
            if (isImported) {
                tr.querySelector('button:not(.delete-property-row)').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const propertyId = this.dataset.propertyId;
                    const property = RealEstateApp.properties.find(p => p.id == propertyId);
                    if (property) {
                        // تحويل العقار المستورد الحالي فقط إلى محفوظ
                        property._imported = false;
                        property.imported = false;
                        localStorage.setItem('realEstateProperties', JSON.stringify(RealEstateApp.properties));
                        RealEstateApp.showNotification('تم تحويل العقار المستورد إلى محفوظ بنجاح');
                        // تحديث الصف في الجدول
                        const badge = tr.querySelector('.property-badge');
                        if (badge) {
                            badge.className = 'property-badge badge-saved';
                            badge.textContent = 'محفوظ';
                        }
                        // إزالة زر الحفظ
                        this.remove();
                    }
                });
            }

            // حدث حذف العقار
            tr.querySelector('.delete-property-row').addEventListener('click', function(e) {
                e.stopPropagation();
                const propertyId = this.dataset.propertyId;
                
                if (confirm('هل أنت متأكد من حذف هذا العقار نهائياً؟')) {
                    const index = RealEstateApp.properties.findIndex(p => p.id == propertyId);
                    if (index !== -1) {
                        RealEstateApp.properties.splice(index, 1);
                        localStorage.setItem('realEstateProperties', JSON.stringify(RealEstateApp.properties));
                        tr.remove();
                        RealEstateApp.showNotification('تم حذف العقار بنجاح');
                        
                        // إذا كان العقار المحذوف هو الحالي، يتم مسح النموذج
                        if (RealEstateApp.currentProperty && RealEstateApp.currentProperty.id == propertyId) {
                            RealEstateApp.resetForm();
                        }
                    }
                }
            });
});
    }
    
    modal.style.display = 'block';
});

document.getElementById('close-saved-properties').addEventListener('click', function() {
    document.getElementById('saved-properties-modal').style.display = 'none';
});

// دالة لتحميل بيانات العقار
RealEstateApp.loadPropertyData = function(propertyId) {
    const property = this.properties.find(p => p.id == propertyId);
    if (!property) return;
    
    // تعبئة بيانات العقار في النموذج
    document.getElementById('property-number').value = property.propertyNumber || '';
    document.getElementById('previous-property-number').value = property.previousPropertyNumber || '';
    document.getElementById('street').value = property.street || '';
    document.getElementById('street-width').value = property.streetWidth || '';
    document.getElementById('district').value = property.district || '';
    document.getElementById('city').value = property.city || '';
    document.getElementById('governorate').value = property.governorate || '';
    document.getElementById('building-material').value = property.buildingMaterial || 'concrete';
    document.getElementById('construction-year').value = property.constructionYear || '';
    document.getElementById('responsible-name').value = property.responsibleName || '';
    document.getElementById('owner').value = property.owner || '';
    document.getElementById('owner-national-id').value = property.ownerNationalId || '';
    document.getElementById('area').value = property.area || '';
    document.getElementById('floors').value = property.floors || '';
    document.getElementById('units-count').value = property.unitsCount || '';
    document.getElementById('property-type').value = property.propertyType || 'residential';
    document.getElementById('detailed-description').value = property.detailedDescription || '';
    document.getElementById('coordinates').value = property.coordinates || '';
    
    // تعبئة الوحدات إذا وجدت
    if (property.units && property.units.length > 0) {
        this.units = [...property.units];
        this.updateUnitsTable();
    } else {
        this.units = [];
        this.updateUnitsTable();
    }
    
    // تعبئة الصور إذا وجدت
    const imagePreview = document.getElementById('image-preview');
    imagePreview.innerHTML = '';
    if (property.images && property.images.length > 0) {
        property.images.forEach(img => {
            const image = document.createElement('img');
            image.src = img;
            imagePreview.appendChild(image);
        });
    }
    
    this.currentProperty = property;
    this.showNotification(`تم تحميل العقار ${property.propertyNumber} بنجاح`);
};

// ==== التقييم اليدوي ====
document.getElementById("valuation-method").addEventListener("change", function() {
const manualInput = document.getElementById("manual-valuation-input");
if (this.value === "manual") {
manualInput.style.display = "block";
} else {
manualInput.style.display = "none";
}
});
document.getElementById("manual-market-value").addEventListener("input", function() {
let marketValue = parseFloat(this.value) || 0;
if (marketValue > 0) {
// نفس المعادلات الأصلية
let rentalValue = marketValue * 0.03; // مثال: 3%
let netRentalValue = rentalValue * 0.9; // خصم 10%
let taxValue = netRentalValue * 0.1; // ضريبة 10%
document.getElementById("market-value").innerText = marketValue.toLocaleString() + " ج.م";
document.getElementById("rental-value").innerText = rentalValue.toLocaleString() + " ج.م";
document.getElementById("tax-value").innerText = taxValue.toLocaleString() + " ج.م";
} else {
document.getElementById("market-value").innerText = "--";
document.getElementById("rental-value").innerText = "--";
document.getElementById("tax-value").innerText = "--";
}
});
// === منطق الحاسبة ===
let calcDisplay = document.getElementById("calc-display");
let calcValue = "";
document.getElementById("open-calculator").addEventListener("click", function() {
document.getElementById("calculator-modal").style.display = "block";
});
document.getElementById("calc-buttons").addEventListener("click", function(e) {
if (e.target.tagName === "BUTTON" && e.target.innerText !== "مسح" && e.target.innerText !== "استخدام النتيجة" && e.target.innerText !== "إغلاق") {
if (e.target.innerText === "=") {
try {
calcValue = safeEvalExpression(calcValue);
} catch {
calcValue = "خطأ";
}
} else {
calcValue += e.target.innerText;
}
calcDisplay.value = calcValue;
}
});
document.getElementById("calc-clear").addEventListener("click", function() {
calcValue = "";
calcDisplay.value = "";
});
document.getElementById("calc-use").addEventListener("click", function() {
if (!isNaN(parseFloat(calcValue))) {
document.getElementById("manual-market-value").value = parseFloat(calcValue);
document.getElementById("manual-market-value").dispatchEvent(new Event('input'));
}
document.getElementById("calculator-modal").style.display = "none";
});
document.getElementById("calc-close").addEventListener("click", function() {
document.getElementById("calculator-modal").style.display = "none";
});
</script>
<script>
// تسجيل Service Worker
if ('serviceWorker' in navigator) {
window.addEventListener('load', function() {
navigator.serviceWorker.register('/service-worker.js')
.then(registration => {
console.log('ServiceWorker مسجل بنجاح: ', registration.scope);
})
.catch(error => {
console.log('فشل تسجيل ServiceWorker: ', error);
});
});
}
</script>
<script>
function calculateStatistics() {
    // قراءة العقارات من المفتاح الحقيقي المستخدم في التطبيق
    const properties = JSON.parse(localStorage.getItem('realEstateProperties') || '[]')
        .filter(p => !(p._imported || p.imported || p.source === 'import')); // فقط العقارات المحفوظة
// بناء مصفوفة الوحدات من داخل كل عقار (الوحدات مخزنة داخل property.units)
    let units = [];
    properties.forEach(p => {
        const pUnits = Array.isArray(p.units) ? p.units : [];
        pUnits.forEach(u => {
            // ضع مرجعًا لرقم العقار داخل الوحدة إذا لم يكن موجودًا
            if (!u.propertyNumber) u.propertyNumber = p.propertyNumber || p.id || null;
            // احتفظ بمعلومات الشارع في الوحدة إن لم تكن موجودة
            if (!u.street) u.street = p.street || 'غير محدد';
            units.push(u);
        });
    });

    const totalProperties = properties.length;
    const totalUnits = units.length;

    let totalRental = 0;
    let totalTax = 0;

    let streetStats = {};

    units.forEach(unit => {
        const street = unit.street || 'غير محدد';
        if (!streetStats[street]) {
            streetStats[street] = {
                properties: new Set(),
                residential: 0,
                commercial: 0,
                space: 0,
                rental: 0,
                tax: 0
            };
        }
        let s = streetStats[street];
        if (unit.propertyNumber) s.properties.add(unit.propertyNumber);

        // استخدام useType كما يُعرّف في النموذج (residential, commercial, space, utilized_space ...)
        switch ((unit.useType || '').toString()) {
            case "residential": s.residential++; break;
            case "commercial": s.commercial++; break;
            case "space":
            case "utilized_space": s.space++; break;
            default: break;
        }

        // نقرأ قيم الإيجار والضريبة من الحقول المحتملة بطريقة مرنة
        const rentalNum = parseFloat(unit.rentalValue || unit.netRentalValue || unit.rental || 0) || 0;
        const taxNum = parseFloat(unit.tax || unit.taxValue || 0) || 0;

        s.rental += rentalNum;
        s.tax += taxNum;
        totalRental += rentalNum;
        totalTax += taxNum;
    });

    // تحديث البطاقات الملخصة إن وُجدت العناصر
    const elTotalProperties = document.getElementById("total-properties");
    const elTotalUnits = document.getElementById("total-units");
    const elTotalRental = document.getElementById("total-rental");
    const elTotalTax = document.getElementById("total-tax");
    if (elTotalProperties) elTotalProperties.textContent = totalProperties;
    if (elTotalUnits) elTotalUnits.textContent = totalUnits;
    if (elTotalRental) elTotalRental.textContent = totalRental.toFixed ? totalRental.toFixed(2) : totalRental;
    if (elTotalTax) elTotalTax.textContent = totalTax.toFixed ? totalTax.toFixed(2) : totalTax;

    // تحديث جدول إحصائيات الشوارع
    const tbody = document.getElementById("street-stats-body");
    if (!tbody) return;
    tbody.innerHTML = "";
const filteredProps = this.properties; // نعرض جميع العقارات بما فيها المستوردة
if (Object.keys(streetStats).length === 0) {
        tbody.innerHTML = '<tr class="empty-data-row"><td colspan="7"><div class="empty-message"><p>لا توجد بيانات لإظهارها — يتم عرض الإحصائيات بعد إضافة عقارات ووحدات</p></div></td></tr>';
    } else {
        for (let street in streetStats) {
            let s = streetStats[street];
            let tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${street}</td>
                <td>${s.properties.size}</td>
                <td>${s.residential}</td>
                <td>${s.commercial}</td>
                <td>${s.space}</td>
                <td>${(s.rental).toFixed ? s.rental.toFixed(2) : s.rental}</td>
                <td>${(s.tax).toFixed ? s.tax.toFixed(2) : s.tax}</td>
            `;
            tbody.appendChild(tr);
        }
    }
}


// Run stats calculation when statistics section is opened
document.addEventListener("DOMContentLoaded", () => {
    document.querySelector("[data-target='stats-section']").addEventListener("click", calculateStatistics);
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("saved-properties-search-input");
    if (searchInput) {
        searchInput.addEventListener("keyup", function() {
            let filter = this.value.toLowerCase();
            let rows = document.querySelectorAll("#saved-properties-table tr");
            rows.forEach(row => {
                let text = row.textContent.toLowerCase();
                if (text.includes(filter)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });
    }
});
</script>
<script>
  
function updatePropertiesCount() {
  const saved = JSON.parse(localStorage.getItem('realEstateProperties') || '[]'); // نعرض جميع العقارات بما فيها المستوردة
const el = document.getElementById("properties-count");
    if (el) el.textContent = saved.length;
}


  document.getElementById("save-property").addEventListener("click", function () {
    setTimeout(updatePropertiesCount, 300);
  });

  document.getElementById("import-properties").addEventListener("click", function () {
    setTimeout(updatePropertiesCount, 500);
  });

  window.addEventListener("load", updatePropertiesCount);
</script>
<script>
function updateStats() {
    const properties = JSON.parse(localStorage.getItem('realEstateProperties') || '[]')
        .filter(p => !(p._imported || p.imported || p.source === 'import')); // فقط العقارات المحفوظة
// اجمع الوحدات من العقارات
    let units = [];
    properties.forEach(p => {
        const pUnits = Array.isArray(p.units) ? p.units : [];
        pUnits.forEach(u => {
            if (!u.propertyNumber) u.propertyNumber = p.propertyNumber || p.id || null;
            units.push(u);
        });
    });

    const elTotalProperties = document.getElementById("total-properties");
    const elTotalUnits = document.getElementById("total-units");
    const elTotalArea = document.getElementById("total-area");

    if (elTotalProperties) elTotalProperties.textContent = properties.length;
    if (elTotalUnits) elTotalUnits.textContent = units.length;

    let totalArea = 0;
    properties.forEach(p => { totalArea += Number(p.area || 0); });
    if (elTotalArea) elTotalArea.textContent = totalArea;
}


  // تحديث عند تحميل الصفحة
  window.addEventListener("load", updateStats);

  // تحديث بعد حفظ أو استيراد
  document.getElementById("save-property").addEventListener("click", () => setTimeout(updateStats, 300));
  document.getElementById("import-properties").addEventListener("click", () => setTimeout(updateStats, 500));
</script>
<script>
// --- الكود الخاص باحتساب القيم ---
// تعديل الخلل بحيث يتم تحديث القيم للوحدة الحالية فقط وليس كل الوحدات

function calculateUnitValues(units, coefficients, buildingMaterial, similarityLevel) {
    const lastUnit = units[units.length - 1];
    if (!lastUnit) return;

    const baseValue = coefficients.area * lastUnit.area;
    const useFactor = coefficients.useType[lastUnit.useType] || 1.0;
    const typeFactor = coefficients.unitType[lastUnit.unitType] || 1.0;
    const finishingFactor = coefficients.finishing[lastUnit.finishing] || 1.0;
    const materialFactor = coefficients.buildingMaterial[buildingMaterial] || 1.0;

    let similarityFactor = 1.0;
    if (similarityLevel === 'نفس الشارع') similarityFactor = 1.10;
    else if (similarityLevel === 'نفس المنطقة/القرية') similarityFactor = 1.05;
    else if (similarityLevel === 'نفس المدينة') similarityFactor = 1.02;

    const floorNumber = parseInt(lastUnit.floor) || 0;
    let floorFactor;
    if (typeof getFloorFactor === 'function') {
        // use the explicit mapping function
        floorFactor = getFloorFactor(floorNumber || 1);
    } else {
        // fallback to old multiplicative logic
        floorFactor = (coefficients.floor || 1.0) * (floorNumber > 0 ? floorNumber : 1);
    }


    let computedMarketValue = baseValue * useFactor * typeFactor * finishingFactor * similarityFactor * materialFactor * floorFactor;
    let marketValue = computedMarketValue;

    try {
        const methodNow = document.getElementById('valuation-method').value;
        if (methodNow === 'manual') {
            const manualInput = document.getElementById('manual-market-value');
            if (manualInput) {
                const manualVal = parseFloat(manualInput.value);
                if (!isNaN(manualVal) && manualVal > 0) {
                    marketValue = manualVal;
                }
            }
        }
    } catch (e) {
        marketValue = computedMarketValue;
    }

    const rentalValue = marketValue * 0.018;
    let netRentalValue = (lastUnit.useType === 'residential')
        ? rentalValue * 0.7
        : rentalValue * 0.68;

    let tax = (lastUnit.useType === 'residential')
        ? marketValue * 0.00126
        : marketValue * 0.001224;

    lastUnit.marketValue = marketValue;
    lastUnit.rentalValue = rentalValue;
    lastUnit.netRentalValue = netRentalValue;
    lastUnit.tax = tax;
}

const calcBtn = document.getElementById('calculate-values-btn');
if (calcBtn) {
    calcBtn.addEventListener('click', () => {
        const floor = document.getElementById('unit-floor') ? document.getElementById('unit-floor').value.trim() : '';
        const number = document.getElementById('unit-number') ? document.getElementById('unit-number').value.trim() : '';
        if (window.RealEstateApp && typeof RealEstateApp.calculateUnitValues === 'function') {
            RealEstateApp.calculateUnitValues({ floor, number });
        } else {
            if (typeof calculateUnitValues === 'function') calculateUnitValues();
        }
    });
}
  });
}

// ======== تصدير إحصائيات الشوارع ========
function exportStreetStatsExcel() {
  // جمع البيانات من الجدول
  const data = [];
  const headers = ['الشارع', 'عدد العقارات', 'عدد الوحدات', 'إجمالي القيمة الإيجارية', 'إجمالي الضريبة السنوية'];
  
  data.push(headers);
  
  document.querySelectorAll('#street-stats-body tr').forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length >= 5) {
      const rowData = [
        cells[0].textContent,
        cells[1].textContent,
        cells[2].textContent,
        cells[3].textContent.replace(' ج.م', ''),
        cells[4].textContent.replace(' ج.م', '')
      ];
      data.push(rowData);
    }
  });
  
  // إنشاء ملف Excel
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'إحصائيات الشوارع');
  
  // حفظ الملف
  XLSX.writeFile(wb, 'إحصائيات_الشوارع.xlsx');
}

function exportStreetStatsCSV() {
  // جمع البيانات من الجدول
  let csvContent = 'الشارع,عدد العقارات,عدد الوحدات,إجمالي القيمة الإيجارية,إجمالي الضريبة السنوية\n';
  
  document.querySelectorAll('#street-stats-body tr').forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length >= 5) {
      const rowData = [
        `"${cells[0].textContent}"`,
        cells[1].textContent,
        cells[2].textContent,
        cells[3].textContent.replace(' ج.م', ''),
        cells[4].textContent.replace(' ج.م', '')
      ];
      csvContent += rowData.join(',') + '\n';
    }
  });
  
  // إنشاء رابط تحميل
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.setAttribute('href', url);
  link.setAttribute('download', 'إحصائيات_الشوارع.csv');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function exportStreetStatsPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // إضافة عنوان
  doc.setFontSize(18);
  doc.text('إحصائيات الشوارع', 105, 15, { align: 'center' });
  doc.setFontSize(12);
  doc.text(new Date().toLocaleDateString('ar-EG'), 105, 22, { align: 'center' });
  
  // جمع البيانات من الجدول
  const data = [];
  const headers = ['الشارع', 'عدد العقارات', 'عدد الوحدات', 'القيمة الإيجارية', 'الضريبة السنوية'];
  
  data.push(headers);
  
  document.querySelectorAll('#street-stats-body tr').forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length >= 5) {
      const rowData = [
        cells[0].textContent,
        cells[1].textContent,
        cells[2].textContent,
        cells[3].textContent.replace(' ج.م', ''),
        cells[4].textContent.replace(' ج.م', '')
      ];
      data.push(rowData);
    }
  });
  
  // إنشاء الجدول في PDF
  doc.autoTable({
    head: [data[0]],
    body: data.slice(1),
    startY: 30,
    theme: 'grid',
    styles: { font: 'Cairo', fontSize: 10, halign: 'center' },
    headStyles: { fillColor: [52, 152, 219] },
    margin: { right: 10, left: 10 }
  });
  
  // حفظ الملف
  doc.save('إحصائيات_الشوارع.pdf');
}

// ======== تهيئة الأحداث ========
document.addEventListener('DOMContentLoaded', function() {
  // تحديث الإحصائيات عند فتح قسم الإحصائيات
  document.querySelector('[data-target="stats-section"]').addEventListener('click', function() {
    calculateStreetStatistics();
  });
  
  // تحديث الإحصائيات عند النقر على زر التحديث
  document.getElementById('refresh-stats').addEventListener('click', function() {
    calculateStreetStatistics();
  });
  
  // تصفية البيانات أثناء الكتابة
  document.getElementById('street-filter').addEventListener('input', function() {
    calculateStreetStatistics();
  });
  
  // أحداث التصدير
  document.getElementById('export-street-stats-excel').addEventListener('click', exportStreetStatsExcel);
  document.getElementById('export-street-stats-csv').addEventListener('click', exportStreetStatsCSV);
  document.getElementById('export-street-stats-pdf').addEventListener('click', exportStreetStatsPDF);
  
  // التهيئة الأولية
  calculateStreetStatistics();
});
</script><script>
const coefficients = {
      // ✨ معامل الدور
      floor: 0.98,
                    area: 3000,
                    locationType: {
                      'compound': 0.5,
                      'village': 1.0,
                      'city': 1.5,
                      'major_city': 2.0
                    },
buildingMaterial: {
                        'brick': 1.0,
                        'sand_brick': 0.95,
                        'concrete': 1.1,
                        'stone': 1.05,
                        'mud_brick': 0.9,
                        'other': 1.0
                    },
                    useType: {
                        'residential': 1.0,
                        'commercial': 1.2,
                        'administrative': 1.1,
                        'space': 0.5,
                        'utilized_space': 1.15 // معامل خاص للفضاء مستغل
                    },
                    unitType: {
                        'apartment': 1.0,
                        'duplex': 1.3,
                        'villa': 1.8,
                        'shop': 1.4,
                        'warehouse': 1.1,
                        'workshop': 1.2,
                        'clinic': 1.5,
                        'office': 1.3,
                        'space': 0.4,
                        'utilized_space': 1.2 // معامل خاص للفضاء مستغل
                    },
                    finishing: {
                        'none': 0.7,
                        'basic': 0.9,
                        'medium': 1.0,
                        'high': 1.2,
                        'luxury': 1.5
                    }
                };
</script>

<script>
if (typeof getFloorFactor === 'function') {
  console.log('معاملات الدور (floor -> factor):');
  for (let f=1; f<=10; f++) console.log(f + ' -> ' + getFloorFactor(f));
}
</script>

<script>
function printForm1() {
  const formContent = document.getElementById('form1').innerHTML;
  const w = window.open('', '', 'height=800,width=1200');
  w.document.write('<html><head><title>طباعة استمارة الحصر</title></head><body>');
  w.document.write(formContent);
  w.document.write('</body></html>');
  w.document.close();
  w.print();
}

function printForm2() {
  const formContent = document.getElementById('form2').innerHTML;
  const w = window.open('', '', 'height=800,width=1200');
  w.document.write('<html><head><title>طباعة استمارة 32 ض ع</title></head><body>');
  w.document.write(formContent);
  w.document.write('</body></html>');
  w.document.close();
  w.print();
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('export-map-package');
  if(btn){
    btn.addEventListener('click', async function(){
      try {
        // إظهار رسالة تحميل
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.display = 'flex';
        
        const mapEl = document.getElementById('map-canvas') || document.getElementById('map');
        if(!mapEl) {
          throw new Error("❌ لم يتم العثور على عنصر الخريطة");
        }

        // 1. التقاط صورة الخريطة
        const canvas = await html2canvas(mapEl, {
          useCORS: true,
          allowTaint: true,
          scale: 2, // زيادة دقة الصورة
          logging: false
        });
        
        // 2. إنشاء بيانات GeoJSON وGPX
        const app = window.RealEstateApp || {};
        const features = [];
        (app.properties||[]).forEach(p => {
          if (!p.coordinates) return;
          const parts = p.coordinates.split(',').map(s => parseFloat(s.trim()));
          if (parts.length < 2) return;
          const lat = parts[0], lng = parts[1];
          if (!isFinite(lat) || !isFinite(lng)) return;
          
          features.push({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [lng, lat] },
            properties: {
              id: p.id || p.propertyNumber || '',
              street: p.street || '',
              district: p.district || '',
              city: p.city || '',
              governorate: p.governorate || '',
              owner: p.owner || '',
              unitsCount: (p.units||[]).length
            }
          });
        });

        const geojson = { type: 'FeatureCollection', features };
        
        // 3. إنشاء ملف GPX
        let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="RealEstateApp" xmlns="http://www.topografix.com/GPX/1/1">`;
        
        features.forEach(f => {
          const [lng, lat] = f.geometry.coordinates;
          gpx += `
  <wpt lat="${lat}" lon="${lng}">
    <name>${f.properties.id}</name>
    <desc>${[f.properties.street, f.properties.district, f.properties.city].filter(Boolean).join(' - ')}</desc>
  </wpt>`;
        });
        
        gpx += '\n</gpx>';

        // 4. إنشاء ملف ZIP
        const zip = new JSZip();
        
        // أضف صورة الخريطة
        canvas.toBlob(async (blob) => {
          zip.file("map.png", blob);
          
          // أضف ملف GeoJSON
          zip.file("properties.geojson", JSON.stringify(geojson, null, 2));
          
          // أضف ملف GPX
          zip.file("properties.gpx", gpx);
          
          // أضف ملف README
          const readme = `حزمة تصدير الخريطة العقارية\n\nتتضمن:\n- map.png: صورة الخريطة\n- properties.geojson: بيانات المواقع بصيغة GeoJSON\n- properties.gpx: بيانات المواقع بصيغة GPX لاستخدامها في أجهزة الملاحة\n\nتم التصدير من تطبيق حصر وتقييم العقارات في ${new Date().toLocaleString('ar-EG')}`;
          zip.file("README.txt", readme);
          
          // إنشاء وتحميل الملف
          const content = await zip.generateAsync({type: "blob"});
          const url = URL.createObjectURL(content);
          const a = document.createElement("a");
          a.href = url;
          a.download = `الخريطة_العقارية_${new Date().toISOString().slice(0,10)}.zip`;
          document.body.appendChild(a);
          a.click();
          
          // التنظيف
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            loadingOverlay.style.display = 'none';
            RealEstateApp.showNotification('تم تصدير حزمة الخريطة بنجاح');
          }, 100);
          
        }, 'image/png', 0.9); // جودة الصورة 90%

      } catch(err) {
        console.error(err);
        document.getElementById('loading-overlay').style.display = 'none';
        RealEstateApp.showNotification('حدث خطأ أثناء تصدير الخريطة', 'error');
      }
    });
  }
});
</script>
<!-- BEGIN: Map GPS Export Patch -->
<script>
/*
Patch: Map GPS export/import + navigation
How to use:
1. Paste this script *after* the existing RealEstateApp object in property_app_with_gps_export_v16.html (i.e. after the big RealEstateApp = { ... } block) OR include it in a separate <script> tag after the main script.
2. Ensure JSZip and html2canvas are already included (they are in the original file). This patch uses existing functions: showNotification(), ensureFileExtension(), formatCurrency(), and the map element with id 'map-canvas'.
3. The patch adds these public methods to RealEstateApp:
   - generateGeoJSON(includeImported = false)
   - generateGPX(includeImported = false)
   - exportMapPackage()  // creates a ZIP with map image, properties.geojson, properties.gpx and README
   - importMapFile(file) // accepts .zip, .geojson, .gpx and visualizes points on the map (does not auto-merge into saved properties)

Notes:
- Export includes only properties that have valid coordinates ("lat, lng") and by default excludes imported properties (keeps app behavior that imported items are draft).
- Import shows imported points on the map with a distinct icon (orange) and a popup with a "انتقل" link that opens Google Maps directions.
- Navigation: popups (both saved properties and imported ones) include a direct Google Maps directions link. On mobile this will open the Maps app if available.

Limitations:
- The app does not attempt to compute turn-by-turn navigation inside the app (requires routing API). It opens external Google Maps directions instead.
- If you want auto-merge of imported properties into the main dataset, modify merge logic where appropriate (we intentionally keep imported map data separate to respect your earlier requirement to review/confirm before saving).
*/

(function(){
  // helper: convert dataURL to Blob
  function dataURLToBlob(dataurl) {
    const arr = dataurl.split(','); 
    const mimeMatch = arr[0].match(/:(.*?);/);
    const mime = mimeMatch ? mimeMatch[1] : 'image/png';
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while(n--) {
      u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], {type: mime});
  }

  function escapeXml(unsafe) {
    if (!unsafe) return '';
    return unsafe.replace(/[<>&\"']/g, function (c) {
      switch (c) {
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '&': return '&amp;';
        case '\"': return '&quot;';
        case "'": return '&apos;';
      }
    });
  }

  // Add methods to RealEstateApp (the main app object exists in the original file)
  if (!window.RealEstateApp) {
    console.warn('RealEstateApp not found - please ensure this patch is loaded after the main file.');
    return;
  }

  // Generate GeoJSON from saved properties
  RealEstateApp.generateGeoJSON = function(includeImported = false) {
    const features = this.properties
      .filter(p => {
        if (!p || !p.coordinates) return false;
        if (!includeImported && (p._imported || p.imported || p.source === 'import')) return false;
        return true;
      })
      .map(p => {
        const parts = (p.coordinates || '') .split(',').map(s => parseFloat(s.trim()));
        if (parts.length < 2) return null;
        const lat = parseFloat(parts[0]);
        const lng = parseFloat(parts[1]);
        if (isNaN(lat) || isNaN(lng)) return null;
        return {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [lng, lat] },
          properties: {
            id: p.id || '',
            propertyNumber: p.propertyNumber || '',
            street: p.street || '',
            district: p.district || '',
            city: p.city || '',
            governorate: p.governorate || '',
            owner: p.owner || '',
            unitsCount: (p.units||[]).length || 0
          }
        };
      })
      .filter(Boolean);

    return { type: 'FeatureCollection', features };
  };

  // Generate simple GPX from properties
  RealEstateApp.generateGPX = function(includeImported = false) {
    const geo = this.generateGeoJSON(includeImported);
    let gpx = '<?xml version="1.0" encoding="UTF-8"?>\n';
    gpx += '<gpx version="1.1" creator="RealEstateApp" xmlns="http://www.topografix.com/GPX/1/1">\n';
    geo.features.forEach(f => {
      const lng = f.geometry.coordinates[0];
      const lat = f.geometry.coordinates[1];
      const name = escapeXml(f.properties.propertyNumber || f.properties.id || 'عقار');
      const desc = escapeXml([f.properties.street, f.properties.district, f.properties.city, f.properties.governorate].filter(Boolean).join(' - '));
      gpx += `<wpt lat="${lat}" lon="${lng}"><name>${name}</name><desc>${desc}</desc></wpt>\n`;
    });
    gpx += '</gpx>';
    return gpx;
  };

  // Add a distinguishable icon factory for imported map points
  RealEstateApp._createPointIcon = function(color = 'blue') {
    return L.divIcon({
      className: 'custom-icon',
      html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
      iconSize: [20, 20]
    });
  };

  // Add function to export package (image + geojson + gpx)
  RealEstateApp.exportMapPackage = async function(options = {}) {
    options = Object.assign({ includeImported: false, filenamePrefix: 'map_package' }, options);
    try {
      this.showNotification('جاري إعداد حزمة الخريطة...');
      // 1) snapshot of the map (map-canvas)
      const canvasEl = document.getElementById('map-canvas') || document.getElementById('map');
      if (!canvasEl) {
        this.showNotification('لم يتم العثور على عنصر الخريطة للتصدير', 'error');
        return;
      }
      const canvas = await html2canvas(canvasEl, {useCORS: true, allowTaint: true});
      const dataUrl = canvas.toDataURL('image/png');
      const pngBlob = dataURLToBlob(dataUrl);

      // 2) geojson & gpx
      const geojson = JSON.stringify(this.generateGeoJSON(options.includeImported), null, 2);
      const gpx = this.generateGPX(options.includeImported);

      // 3) create ZIP
      const zip = new JSZip();
      zip.file(this.ensureFileExtension(options.filenamePrefix, 'png'), pngBlob, {binary: true});
      zip.file('properties.geojson', geojson);
      zip.file('properties.gpx', gpx);
      const readme = `تم إنشاء حزمة الخريطة بواسطة تطبيق الحصر والتقييم العقاري\n\nمحتويات الحزمة:\n- ${this.ensureFileExtension(options.filenamePrefix, 'png')}: صورة للخريطة\n- properties.geojson: بيانات المواقع بنسق GeoJSON\n- properties.gpx: بيانات المواقع بنسق GPX (يمكن استيرادها في أجهزة الملاحة وتطبيقات الهاتف)\n\nملاحظة: لا يتم دمج بيانات الخريطة المستوردة آليًا في قاعدة البيانات، ويتوجب مراجعتها واعتمادها يدويًا.`;
      zip.file('README.txt', readme);

      const blob = await zip.generateAsync({ type: 'blob' });
      const link = document.createElement('a');
      const now = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      const fname = this.ensureFileExtension(`${options.filenamePrefix}_${now}`, 'zip');
      link.href = URL.createObjectURL(blob);
      link.download = fname;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(link.href);
      this.showNotification('تم تصدير حزمة الخريطة بنجاح');
    } catch (err) {
      console.error(err);
      this.showNotification('فشل في تصدير حزمة الخريطة', 'error');
    }
  };

  // Add markers from a GeoJSON object (visual-only, does not add to saved properties)
  RealEstateApp.addGeoJSONToMap = function(geojson, options = {}) {
    if (!this.map) {
      this.showNotification('الخريطة غير جاهزة - قم بتحديث الخريطة أولاً', 'error');
      return;
    }
    options = Object.assign({ iconColor: 'orange', clearPrevious: false }, options);
    if (options.clearPrevious && this._importedLayer) {
      try { this.map.removeLayer(this._importedLayer); } catch(e){}
      this._importedLayer = null;
    }

    const layerGroup = L.layerGroup();
    if (geojson && geojson.features && geojson.features.length) {
      geojson.features.forEach(f => {
        const coords = f.geometry && f.geometry.coordinates;
        if (!coords || coords.length < 2) return;
        const lng = coords[0];
        const lat = coords[1];
        const icon = this._createPointIcon(options.iconColor);
        const marker = L.marker([lat, lng], { icon }).addTo(layerGroup);
        const props = f.properties || {};
        const popup = `
          <div class="map-popup-content">
            <h3>عقار ${props.propertyNumber || props.id || ''}</h3>
            <p><strong>الموقع:</strong> ${props.governorate||''} - ${props.city||''} - ${props.district||''}</p>
            <p><strong>الشارع:</strong> ${props.street||''}</p>
            <p><strong>المالك:</strong> ${props.owner||'--'}</p>
            <hr/>
            <a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" class="btn">انتقل</a>
          </div>`;
        marker.bindPopup(popup);
      });
    }
    layerGroup.addTo(this.map);
    this._importedLayer = layerGroup; // keep reference to clear later
    // zoom to layer bounds if present
    try {
      const bounds = layerGroup.getBounds();
      if (bounds.isValid && bounds.isValid()) this.map.fitBounds(bounds.pad(0.5));
    } catch (e) {}
  };

  // Import handler for files (.zip, .geojson, .gpx)
  RealEstateApp.importMapFile = async function(file) {
    const name = (file && file.name) ? file.name.toLowerCase() : '';
    try {
      if (name.endsWith('.zip')) {
        const zip = await JSZip.loadAsync(file);
        // try to find geojson first
        const geoName = Object.keys(zip.files).find(n => n.toLowerCase().endsWith('.geojson'));
        const gpxName = Object.keys(zip.files).find(n => n.toLowerCase().endsWith('.gpx'));
        if (geoName) {
          const text = await zip.file(geoName).async('string');
          const geo = JSON.parse(text);
          this.addGeoJSONToMap(geo, { iconColor: 'orange', clearPrevious: true });
          this.showNotification('تم استيراد بيانات GeoJSON من الحزمة');
          return;
        } else if (gpxName) {
          const text = await zip.file(gpxName).async('string');
          const geo = this._gpxToGeoJSON(text);
          this.addGeoJSONToMap(geo, { iconColor: 'orange', clearPrevious: true });
          this.showNotification('تم استيراد بيانات GPX من الحزمة');
          return;
        } else {
          this.showNotification('لا يوجد ملف GeoJSON/GPX في الحزمة', 'error');
          return;
        }
      } else if (name.endsWith('.geojson') || name.endsWith('.json')) {
        const text = await file.text();
        const geo = JSON.parse(text);
        this.addGeoJSONToMap(geo, { iconColor: 'orange', clearPrevious: true });
        this.showNotification('تم استيراد GeoJSON بنجاح');
        return;
      } else if (name.endsWith('.gpx')) {
        const text = await file.text();
        const geo = this._gpxToGeoJSON(text);
        this.addGeoJSONToMap(geo, { iconColor: 'orange', clearPrevious: true });
        this.showNotification('تم استيراد GPX بنجاح');
        return;
      } else {
        this.showNotification('نوع الملف غير مدعوم (ZIP / GEOJSON / GPX)', 'error');
      }
    } catch (err) {
      console.error(err);
      this.showNotification('فشل في استيراد ملف الخريطة', 'error');
    }
  };

  // Convert simple GPX waypoints to GeoJSON
  RealEstateApp._gpxToGeoJSON = function(gpxText) {
    try {
      const parser = new DOMParser();
      const xml = parser.parseFromString(gpxText, 'application/xml');
      const wpts = Array.from(xml.querySelectorAll('wpt')) || [];
      const features = wpts.map(w => {
        const lat = parseFloat(w.getAttribute('lat'));
        const lon = parseFloat(w.getAttribute('lon'));
        const name = w.querySelector('name') ? w.querySelector('name').textContent : '';
        const desc = w.querySelector('desc') ? w.querySelector('desc').textContent : '';
        return {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [lon, lat] },
          properties: { id: name, propertyNumber: name, street: desc }
        };
      });
      return { type: 'FeatureCollection', features };
    } catch (e) {
      console.error(e);
      return { type: 'FeatureCollection', features: [] };
    }
  };

  // Create UI: add import button next to export-map-package if not present
  (function setupMapImportButton(){
    try {
      const exportBtn = document.getElementById('export-map-package');
      if (!exportBtn) return;
      // create import button
      if (!document.getElementById('import-map-package')) {
        const importBtn = document.createElement('button');
        importBtn.className = 'export-btn image';
        importBtn.id = 'import-map-package';
        importBtn.style.backgroundColor = '#f39c12';
        importBtn.style.marginRight = '10px';
        importBtn.innerHTML = '<i class="fas fa-file-import"></i> استيراد حزمة خريطة';
        exportBtn.parentNode.insertBefore(importBtn, exportBtn.nextSibling);

        // hidden file input
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.zip,.geojson,.gpx,.json';
        input.style.display = 'none';
        input.id = 'import-map-file-input';
        document.body.appendChild(input);

        importBtn.addEventListener('click', () => input.click());
        input.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          this.importMapFile(file);
          input.value = null; // reset
        });
      }
    } catch (e) { console.warn(e); }
  }).call(RealEstateApp);

  // attach export button handler
  const existingExportBtn = document.getElementById('export-map-package');
  if (existingExportBtn) {
    existingExportBtn.addEventListener('click', function(){
      RealEstateApp.exportMapPackage({ includeImported: false, filenamePrefix: 'الخريطة_العقارية' });
    });
  }

  // Augment updateMap popups (navigation link) only if popups don't already include directions
  // We'll monkey-patch the existing method: when RealEstateApp.updateMap runs it creates markers and popups.
  // To ensure navigation links are present, add a small helper that re-binds popups to include a Google Maps directions link.
  RealEstateApp._ensureNavigationInMap = function() {
    if (!this.map) return;
    // find all markers created by the map (we created them with class 'custom-icon' HTML inside) - we will iterate layers
    this.map.eachLayer(layer => {
      try {
        if (layer && layer.getLatLng && layer.getPopup) {
          const latlng = layer.getLatLng();
          const popup = layer.getPopup && layer.getPopup();
          if (!latlng || !popup) return;
          const content = popup.getContent ? popup.getContent() : '';
          if (content && typeof content === 'string' && !content.includes('google.com/maps/dir')) {
            // append a small navigation button
            const newContent = content.replace('</div>', `<p style="text-align:center; margin-top:8px;"><a class="btn" target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${latlng.lat},${latlng.lng}">انتقل</a></p></div>`);
            layer.setPopupContent(newContent);
          }
        }
      } catch(e){}
    });
  };

  // After map is updated, try to ensure navigation links exist
  // If RealEstateApp.updateMap exists, wrap it
  if (RealEstateApp.updateMap && typeof RealEstateApp.updateMap === 'function') {
    const originalUpdateMap = RealEstateApp.updateMap.bind(RealEstateApp);
    RealEstateApp.updateMap = function() {
      originalUpdateMap();
      // small timeout to wait for markers/popups creation
      setTimeout(() => { try { this._ensureNavigationInMap(); } catch(e){} }, 300);

      // add locate-me control once
      if (!this._locateControlAdded && this.map) {
        const LocateControl = L.Control.extend({
          options: { position: 'topright' },
          onAdd: function(map){
            const container = L.DomUtil.create('div', 'map-controls');
            container.innerHTML = '<button id="locate-me" class="btn" title="عرض موقعي الحالي">📍 موقعي</button>';
            container.style.padding = '6px';
            L.DomEvent.disableClickPropagation(container);
            return container;
          }
        });
        this._locateCtrl = new LocateControl();
        this._locateCtrl.addTo(this.map);
        // attach click listener
        document.addEventListener('click', (e) => {
          if (e.target && e.target.id === 'locate-me') {
            if (!this.map) return;
            this.showNotification('جاري تحديد موقعك...');
            this.map.locate({ setView: true, maxZoom: 16 });
          }
        });
        this.map.on('locationfound', (e) => {
          if (this._yourLocationMarker) { try { this.map.removeLayer(this._yourLocationMarker); } catch(e){} }
          this._yourLocationMarker = L.marker(e.latlng, {icon: this._createPointIcon('red')}).addTo(this.map).bindPopup('<strong>موقعك الحالي</strong>').openPopup();
        });
        this.map.on('locationerror', (err) => { this.showNotification('تعذر الحصول على الموقع: ' + (err.message || ''), 'error'); });
        this._locateControlAdded = true;
      }
    };
  }

})();
  // ======== تعديلات دعم التقسيم إلى صفحات في الاستمارات الرسمية ========

// دالة مساعدة لتقسيم الوحدات إلى صفحات
RealEstateApp.splitIntoPages = function(items, itemsPerPage) {
    const pages = [];
    for (let i = 0; i < items.length; i += itemsPerPage) {
        pages.push(items.slice(i, i + itemsPerPage));
    }
    return pages;
};

// دالة إنشاء عناصر التحكم في الصفحات
RealEstateApp.createPaginationControls = function(currentPage, totalPages, formType) {
    const controls = document.createElement('div');
    controls.className = 'pagination-controls';
    controls.style.cssText = 'text-align: center; margin: 20px 0; display: flex; justify-content: center; align-items: center; gap: 10px;';

    if (totalPages <= 1) return controls;

    const prevButton = document.createElement('button');
    prevButton.className = 'btn';
    prevButton.innerHTML = '<i class="fas fa-chevron-right"></i> الصفحة السابقة';
    prevButton.disabled = currentPage === 1;
    prevButton.addEventListener('click', () => {
        RealEstateApp.showFormPage(formType, currentPage - 1);
    });

    const nextButton = document.createElement('button');
    nextButton.className = 'btn';
    nextButton.innerHTML = 'الصفحة التالية <i class="fas fa-chevron-left"></i>';
    nextButton.disabled = currentPage === totalPages;
    nextButton.addEventListener('click', () => {
        RealEstateApp.showFormPage(formType, currentPage + 1);
    });

    const pageInfo = document.createElement('span');
    pageInfo.style.cssText = 'padding: 8px 15px; background: #f8f9fa; border-radius: 5px; font-weight: bold;';
    pageInfo.textContent = `الصفحة ${currentPage} من ${totalPages}`;

    controls.appendChild(prevButton);
    controls.appendChild(pageInfo);
    controls.appendChild(nextButton);

    return controls;
};

// دالة عرض صفحة محددة من الاستمارة
RealEstateApp.showFormPage = function(formType, pageNumber) {
    if (formType === 'form1') {
        RealEstateApp.fillOfficialForm1(RealEstateApp.currentProperty, pageNumber);
    } else if (formType === 'form2') {
        RealEstateApp.fillOfficialForm2(RealEstateApp.currentProperty, pageNumber);
    }
};

// تعديل دالة تعبئة استمارة الحصر لدعم التقسيم إلى صفحات
RealEstateApp.fillOfficialForm1 = function(property, page = 1) {
    if (!property) return;

    const itemsPerPage = 10; // كل صفحة تسع 10 وحدات
    const allUnits = property.units || [];
    const totalPages = Math.ceil(allUnits.length / itemsPerPage);
    const currentPage = Math.max(1, Math.min(page, totalPages));
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const units = allUnits.slice(startIndex, endIndex);

    // تحديث عنوان الاستمارة
    document.getElementById('form1-header').innerHTML = `
        <td colspan="18" class="merged-cell">
        محافظة: ${property.governorate || '--'}
        مأمورية: ${property.city || '--'}
        قرية: ${property.district || '--'}
        ${totalPages > 1 ? ` - الصفحة ${currentPage} من ${totalPages}` : ''}
        </td>
    `;

    // تعبئة البيانات
    const tbody = document.getElementById('form1-data');
    tbody.innerHTML = '';

    if (units.length > 0) {
        units.forEach((unit, index) => {
            const globalIndex = startIndex + index;
            const tr = document.createElement('tr');
            
            // تعبئة البيانات المشتركة مرة واحدة فقط للوحدة الأولى في الصفحة
            const commonData = index === 0 ? `
                <td rowspan="${units.length}">${property.propertyNumber || '--'}</td>
                <td rowspan="${units.length}">${property.street || '--'}</td>
                <td rowspan="${units.length}">${property.streetWidth || '--'}</td>
                <td rowspan="${units.length}">${property.owner || '--'}</td>
                <td rowspan="${units.length}">${this.getBuildingMaterialName(property.buildingMaterial)}</td>
                <td rowspan="${units.length}">${property.detailedDescription || '--'}</td>
                <td rowspan="${units.length}">${property.constructionYear || '--'}</td>
            ` : '';
            
            tr.innerHTML = commonData + `
                <td>${this.getUseTypeName(unit.useType)}</td>
                <td>${unit.floor || '--'}</td>
                <td>${unit.number || globalIndex + 1}</td>
                <td>${this.getUnitTypeName(unit.unitType)}</td>
                <td>${unit.area || '--'} م²</td>
                <td>${unit.occupant || '--'}</td>
                <td>${unit.rentalValue ? this.formatCurrency(unit.rentalValue) : '--'}</td>
                <td>${unit.tax ? this.formatCurrency(unit.tax) : '--'}</td>
                <td>${property.district || '--'}</td>
            `;
            tbody.appendChild(tr);
        });
    } else {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td colspan="18" style="text-align: center; padding: 20px; color: var(--gray);">
            <i class="fas fa-inbox"></i>
            <h3>لا توجد وحدات مسجلة لهذا العقار</h3>
            </td>
        `;
        tbody.appendChild(tr);
    }

    // إضافة عناصر التحكم بالصفحات
    const existingPagination = document.getElementById('form1-pagination');
    if (existingPagination) {
        existingPagination.remove();
    }

    if (totalPages > 1) {
        const paginationControls = this.createPaginationControls(currentPage, totalPages, 'form1');
        paginationControls.id = 'form1-pagination';
        const form1Element = document.getElementById('form1');
        form1Element.appendChild(paginationControls);
    }
};

// تعديل دالة تعبئة استمارة 32 لدعم التقسيم إلى صفحات
RealEstateApp.fillOfficialForm2 = function(property, page = 1) {
    if (!property) return;

    const itemsPerPage = 20; // كل صفحة تسع 20 وحدة
    const allUnits = property.units || [];
    const totalPages = Math.ceil(allUnits.length / itemsPerPage);
    const currentPage = Math.max(1, Math.min(page, totalPages));
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const units = allUnits.slice(startIndex, endIndex);

    // تحديث عنوان الاستمارة
    document.getElementById('form2-header').innerHTML = `
        <td colspan="35" class="merged-cell">
        محافظة: ${property.governorate || '--'}
        مأمورية: ${property.city || '--'}
        الناحية: ${property.district || '--'}
        ${totalPages > 1 ? ` - الصفحة ${currentPage} من ${totalPages}` : ''}
        </td>
    `;

    // تعبئة البيانات
    const tbody = document.getElementById('form2-data');
    tbody.innerHTML = '';

    if (units.length > 0) {
        units.forEach((unit, index) => {
            const globalIndex = startIndex + index;
            const tr = document.createElement('tr');
            
            // تعبئة البيانات المشتركة مرة واحدة فقط للوحدة الأولى في الصفحة
            const commonData = index === 0 ? `
                <td rowspan="${units.length}">${new Date().toLocaleDateString('ar-EG')}</td>
                <td rowspan="${units.length}">${property.owner || '--'}</td>
                <td rowspan="${units.length}">${property.propertyNumber || '--'}</td>
                <td rowspan="${units.length}">${property.previousPropertyNumber || '--'}</td>
                <td rowspan="${units.length}">--</td>
                <td rowspan="${units.length}">${property.street || '--'}</td>
                <td rowspan="${units.length}">${property.detailedDescription || '--'}</td>
                <td rowspan="${units.length}">${property.constructionYear || '--'}</td>
            ` : '';
            
            tr.innerHTML = commonData + `
                <td>${this.getUseTypeName(unit.useType)}</td>
                <td>--</td>
                <td>${unit.floor || '--'}</td>
                <td>${unit.number || globalIndex + 1}</td>
                <td>${this.getUnitTypeName(unit.unitType)}</td>
                <td>${unit.area || '--'} م²</td>
                <td>${unit.occupant || '--'}</td>
                <td>${unit.rentalValue ? this.formatCurrency(unit.rentalValue) : '--'}</td>
                <td>${unit.netRentalValue ? this.formatCurrency(unit.netRentalValue) : '--'}</td>
                <td>${unit.tax ? this.formatCurrency(unit.tax) : '--'}</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
            `;
            tbody.appendChild(tr);
        });

        // إضافة صور العقار في خانة الملاحظات (فقط في الصفحة الأولى)
        if (currentPage === 1 && property.images && property.images.length > 0) {
            const imagesRow = document.createElement('tr');
            imagesRow.innerHTML = `
                <td colspan="35">
                <div class="form-images-container">
                    <div class="form-images-title">
                        <i class="fas fa-images"></i> صور العقار
                    </div>
                    <div class="form-images-grid" id="form2-images">
                        <!-- سيتم ملؤها بالصور -->
                    </div>
                </div>
                </td>
            `;
            tbody.appendChild(imagesRow);
            const imagesContainer = document.getElementById('form2-images');
            imagesContainer.innerHTML = '';
            property.images.forEach(img => {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'form-image-item';
                imgContainer.innerHTML = `<img src="${img}" alt="صورة العقار">`;
                imagesContainer.appendChild(imgContainer);
            });
        }
    } else {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td colspan="35" style="text-align: center; padding: 20px; color: var(--gray);">
            <i class="fas fa-inbox"></i>
            <h3>لا توجد وحدات مسجلة لهذا العقار</h3>
            </td>
        `;
        tbody.appendChild(tr);
    }

    // إضافة عناصر التحكم بالصفحات
    const existingPagination = document.getElementById('form2-pagination');
    if (existingPagination) {
        existingPagination.remove();
    }

    if (totalPages > 1) {
        const paginationControls = this.createPaginationControls(currentPage, totalPages, 'form2');
        paginationControls.id = 'form2-pagination';
        const form2Element = document.getElementById('form2');
        form2Element.appendChild(paginationControls);
    }
};

// تعديل دوال الطباعة لدعم الصفحات المتعددة
RealEstateApp.printForm1 = function() {
    const originalFillForm1 = RealEstateApp.fillOfficialForm1;
    
    // طباعة جميع الصفحات
    const property = RealEstateApp.currentProperty;
    if (!property || !property.units || property.units.length === 0) {
        RealEstateApp.showNotification('لا توجد وحدات لطباعتها', 'error');
        return;
    }

    const totalPages = Math.ceil(property.units.length / 10);
    
    // حفظ حالة التبويبات الحالية
    const activeTab = document.querySelector('.tab.active');
    const activeContent = document.querySelector('.tab-content.active');
    
    // تفعيل استمارة الحصر
    document.querySelector('.tab[data-target="form1"]').classList.add('active');
    document.getElementById('form1').classList.add('active');
    
    // طباعة كل صفحة على حدة
    for (let page = 1; page <= totalPages; page++) {
        RealEstateApp.fillOfficialForm1(property, page);
        
        // تأخير بسيط بين الصفحات
        if (page < totalPages) {
            setTimeout(() => {
                window.print();
            }, page * 1000);
        } else {
            window.print();
        }
    }
    
    // استعادة الحالة السابقة للتبويبات
    if (activeTab) activeTab.classList.add('active');
    if (activeContent) activeContent.classList.add('active');
};

RealEstateApp.printForm2 = function() {
    const property = RealEstateApp.currentProperty;
    if (!property || !property.units || property.units.length === 0) {
        RealEstateApp.showNotification('لا توجد وحدات لطباعتها', 'error');
        return;
    }

    const totalPages = Math.ceil(property.units.length / 20);
    
    // حفظ حالة التبويبات الحالية
    const activeTab = document.querySelector('.tab.active');
    const activeContent = document.querySelector('.tab-content.active');
    
    // تفعيل استمارة 32
    document.querySelector('.tab[data-target="form2"]').classList.add('active');
    document.getElementById('form2').classList.add('active');
    
    // طباعة كل صفحة على حدة
    for (let page = 1; page <= totalPages; page++) {
        RealEstateApp.fillOfficialForm2(property, page);
        
        // تأخير بسيط بين الصفحات
        if (page < totalPages) {
            setTimeout(() => {
                window.print();
            }, page * 1000);
        } else {
            window.print();
        }
    }
    
    // استعادة الحالة السابقة للتبويبات
    if (activeTab) activeTab.classList.add('active');
    if (activeContent) activeContent.classList.add('active');
};

// إضافة أنماط CSS للتحكم في الصفحات
const paginationStyles = `
.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 20px 0;
    gap: 10px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border: 1px solid #e9ecef;
}

.pagination-controls .btn {
    padding: 8px 16px;
    font-size: 14px;
}

.pagination-controls .btn:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
}

.pagination-info {
    padding: 8px 15px;
    background: white;
    border-radius: 5px;
    font-weight: bold;
    color: #2c3e50;
}

@media print {
    .pagination-controls {
        display: none !important;
    }
    
    .official-form {
        page-break-after: always;
    }
    
    .official-form:last-child {
        page-break-after: auto;
    }
}
`;

// إضافة الأنماط إلى الصفحة
const styleSheet = document.createElement('style');
styleSheet.textContent = paginationStyles;
document.head.appendChild(styleSheet);
</script>
<!-- END: Map GPS Export Patch -->
</body>